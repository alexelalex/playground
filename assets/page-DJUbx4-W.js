import{j as e,B as Se,r as u,l as k,R as _,q as h,a8 as te,I as we,a as v,f as b,aF as S,o as z,F as ie,n as Ie,e as Ne,d as ke,T as $e,v as Re,h as Te,S as Fe,i as V}from"./index-BgJRjf8M.js";import{fw as We,dn as Ae,fx as Ee,T as re,m as O,M as B,bZ as q,bl as C,d,co as Pe,fy as De,n as M,cm as Le,fz as ze,fA as Be,bD as qe,fB as Ge,fC as Oe,ap as ae,ar as ce,fD as E,e as Me,a3 as $,aq as Ue,g as W,bg as Qe,by as He,h as U,bj as Ye,C as P,L as j,s as w,bo as Je,R as le,I as de,ca as Ze,cb as Ke,w as I,B as D,a6 as Xe,fE as Ve,fF as es,a5 as ss,U as ns,bm as os,dN as ts,b6 as Q,fG as is,dI as pe,dJ as ue,q as G,r as rs,d4 as as,f as cs,fH as ls,fI as ds,b as ee}from"./App-BghU7kAw.js";import{a as R,b as H,c as me,u as ps,d as se,e as us,f as y,S as F,C as xe}from"./useComplianceEntitiesFiltered-CVHJ5SFY.js";import{C as ms}from"./Chart-2WwD5l0G.js";import"./color-9lF95FHy.js";const xs=()=>e.jsx(d,{color:"textSecondary",children:"Views"}),he=Se.Compliance;function hs(){const{filterValues:s}=R(),{setFilterValues:n}=H();return e.jsx(We,{screen:he,body:{filters:s},updateBody:o=>n==null?void 0:n(o==null?void 0:o.filters),children:e.jsx(gs,{})})}function gs(){const{setWizard:s,body:n,updateBody:o}=Ae(),{filterValues:t}=R(),{data:i,loading:r}=Ee({screen:he}),[l,c]=u.useState(!1),a=u.useMemo(()=>i==null?void 0:i.find(p=>k.isEqual(p.body,n)),[n,i]),m=Object.keys(t||{}).length===0;return e.jsxs(e.Fragment,{children:[e.jsxs(re,{select:!0,InputProps:{classes:Cs()},SelectProps:{disableUnderline:!0,IconComponent:()=>e.jsx(_.Fragment,{}),margin:"dense",classes:js(),displayEmpty:!0,renderValue:p=>e.jsxs(C,{gap:1,children:[e.jsx(Be,{fontSize:"small",color:"action"}),p?e.jsx(d,{children:p.name}):e.jsx(xs,{}),e.jsx(qe,{fontSize:"small",color:"action"})]})},value:a||"",onChange:p=>{p.target.value&&o(p.target.value.body)},children:[!r&&!(i!=null&&i.length)&&e.jsx(B,{value:null,disabled:!0,children:e.jsx(q,{primary:"No saved views",secondary:m&&"Apply filters to save as view"})}),i==null?void 0:i.map((p,g)=>e.jsx(B,{value:p,className:"hover-me",children:e.jsx(q,{primary:e.jsxs(C,{children:[e.jsx(d,{noWrap:!0,children:p.name}),e.jsx("div",{style:{flexGrow:1}}),e.jsx(d,{variant:"caption",className:"hide-me",onClick:x=>{x.stopPropagation(),s(De,p)},children:e.jsx(Pe,{fontSize:"small",color:"action"})})]})})},g)),e.jsx(M,{variant:"middle"}),e.jsxs(B,{disabled:!!a||m,value:null,onClick:p=>{p.preventDefault(),p.stopPropagation(),c(!0)},children:[e.jsx(Le,{children:e.jsx(ze,{fontSize:"small"})}),e.jsx(q,{primary:"Save as new view"})]})]}),l&&e.jsx(Ge,{stepInfo:Oe,closeDialog:()=>c(!1),dialogOpen:l})]})}const js=O(s=>({root:{background:"transparent",borderRadius:s.shape.borderRadius},outlined:{"&$outlined":{paddingRight:s.spacing(1)}}})),Cs=O(s=>({root:{background:"transparent","& fieldset":{borderColor:s.palette.divider}}}));function ys(s){const{filterValues:n}=R(),{setFilterValues:o}=H();return e.jsx(_s,{...s,children:e.jsxs(C,{gap:2,style:{flexWrap:"wrap",justifyContent:"space-between"},children:[e.jsx(vs,{}),e.jsxs(ae,{direction:"row",filterValues:n,onChange:o,children:[e.jsx(ce,{attribute:"accounts",displayName:"Accounts"}),e.jsx(fs,{attribute:"compliance_ids",displayName:"Compliances"})]}),e.jsx(E,{}),e.jsx(bs,{}),e.jsx(hs,{})]})})}function fs(s){const{data:n,loading:o,error:t}=me({variables:{filters:{}}}),{results:i}=(n==null?void 0:n.compliance_entities)||{},r=$(i,"compliance_id"),l=u.useMemo(()=>i==null?void 0:i.map(({compliance_id:c})=>c),[i]);return e.jsx(Ue,{options:l,renderOption:c=>{var a;return e.jsx(W,{children:e.jsx(d,{noWrap:!0,children:(a=r[c])==null?void 0:a.name})})},loading:o,error:t,searchableOptions:u.useCallback(({phrase:c,value:a})=>{var m,p;return(p=(m=r[a])==null?void 0:m.name)==null?void 0:p.toLowerCase().match(c.toLowerCase())},[r]),...s})}const _s=h.div.withConfig({displayName:"ComplianceMainToolbar__Toolbar",componentId:"sc-1nwy9h-0"})(({theme:s})=>({background:s.palette.background.paper,padding:s.spacing(2),borderBottom:`solid 1px ${s.palette.dividerLight}`,position:"sticky",top:0}));function vs(){const s=Me();return e.jsx(d,{variant:"h6",children:s==null?void 0:s.display_name})}function bs(){const{searchPhrase:s}=R(),{setSearchPhrase:n}=H();return e.jsx(Ss,{placeholder:"Search for compliance",value:s,onChange:n})}function Ss(s){const[n,o]=u.useState(s.value),t=te(s.onChange,1e3),i=u.useCallback(r=>{o(r),t(r||null)},[t]);return e.jsx(re,{size:"small",variant:"outlined",placeholder:"Search for compliance",value:n||"",onChange:r=>i(r.target.value),InputProps:{startAdornment:e.jsxs(e.Fragment,{children:[e.jsx(He,{color:"action"}),"Â "]}),endAdornment:n&&e.jsx(we,{size:"small",onClick:()=>{o(""),s.onChange(null)},children:e.jsx(Qe,{fontSize:"small"})}),classes:ws()}})}const ws=O(s=>({root:{height:35,width:250,"& fieldset":{borderColor:s.palette.divider}}}));function Y(s){return v(Is,s)}const Is=b(`
  query ComplianceScores (
    $filters: ComplianceEntitiesScoresFilters
    $search_phrase: String
    $group_by: ComplianceScoreGroupBy) {
      compliance_entities_scores(filters: $filters, group_by: $group_by, search_phrase: $search_phrase, sort: { field: score, direction: asc }) {
        results {
          compliance_entity_id
          compliance_categories_ids
          compliance_controls_ids
          total_rules
          total_violated_rules
          score
        }
      }
  }
`);function Ns(){var c,a,m;const{filterValues:s,searchPhrase:n}=R(),{data:o}=Y({variables:{filters:{accounts:s==null?void 0:s.accounts},group_by:S.ComplianceIds}}),{data:t,loading:i}=ps({variables:{search_phrase:n,filters:{}}}),r=$((c=o==null?void 0:o.compliance_entities_scores)==null?void 0:c.results,"compliance_entity_id"),l=u.useMemo(()=>{var p,g;return(g=(p=t==null?void 0:t.compliance_entities)==null?void 0:p.results)==null?void 0:g.filter(x=>{var f,N,T;return(!((f=s==null?void 0:s.accounts)!=null&&f.length)||!!r[x.compliance_id??""])&&(!((N=s==null?void 0:s.compliance_ids)!=null&&N.length)||((T=s==null?void 0:s.compliance_ids)==null?void 0:T.includes(x.compliance_id??"")))})},[(a=t==null?void 0:t.compliance_entities)==null?void 0:a.results,(m=s==null?void 0:s.accounts)==null?void 0:m.length,s==null?void 0:s.compliance_ids,r]);return i?e.jsx(ne,{children:new Array(24).fill({}).map((p,g)=>e.jsx(se,{result:null,score:null},g))}):e.jsx(ne,{children:l==null?void 0:l.map((p,g)=>{var x;return e.jsx(se,{result:p,score:(x=r[p.compliance_id??""])==null?void 0:x.score},g)})})}const ne=h.div.withConfig({displayName:"ComplianceEntitiesTable__TableContainer",componentId:"sc-1si7aaf-0"})(({theme:s})=>({display:"flex",flexDirection:"column"})),A=h.div.withConfig({displayName:"LayoutContainer",componentId:"sc-bm0aq7-0"})(({direction:s="column"})=>({height:"100%",display:"flex",flexDirection:s,overflow:"auto",flexGrow:1}));function ks(){return e.jsx(us,{children:e.jsxs(A,{children:[e.jsx(U,{paper:!0,icon:e.jsx(Ye,{color:"action"}),title:e.jsx(d,{variant:"h5",children:"Compliance"})}),e.jsxs(A,{children:[e.jsx(ys,{}),e.jsx($s,{padding:2,children:e.jsx(Ns,{})})]})]})})}const $s=h.div.withConfig({displayName:"ComplianceMainPage__InnerContainer",componentId:"sc-1sdxqj3-0"})(({theme:s,padding:n})=>({width:"100%",maxWidth:1300,margin:"0 auto",...n&&{padding:s.spacing(n)}})),Rs=({loading:s=!0})=>s?e.jsx(P,{size:15}):e.jsx(_.Fragment,{});function Ts(s){return v(Fs,s)}const Fs=b(`
  query ComplianceAccountScores (
    $filters: ComplianceEntitiesScoresFilters) {
      accounts_compliance_scores(filters: $filters) {
        results {
          total_violated_rules
          score
          accounts
        }
      }
  }
`);function Ws({complianceId:s}){return e.jsx(As,{complianceId:s,children:({loading:n,error:o})=>e.jsxs(j,{gap:2,children:[e.jsxs(C,{gap:2,children:[e.jsx(d,{variant:"subtitle1",children:"Account Status"}),e.jsx(Rs,{loading:n}),e.jsx(w,{variant:"inline",error:o})]}),e.jsx(Ps,{groupBy:"account_type",children:(t,i)=>e.jsx(Ds,{accountType:i,accounts:t},i)})]})})}const ge=_.createContext(void 0);function As({complianceId:s,children:n}){var i,r;const o=Ts({variables:{filters:{compliance_ids:[s]}}}),t=$((r=(i=o.data)==null?void 0:i.accounts_compliance_scores)==null?void 0:r.results,S.Accounts);return e.jsx(ge.Provider,{value:{map:t,...o},children:n(o)})}function Es({accountId:s}){const{map:n,loading:o}=u.useContext(ge);return{score:n[s],loading:o}}function Ps({groupBy:s,children:n}){const[o]=y(),[t]=Je();return e.jsx(e.Fragment,{children:k.map(k.groupBy(t==null?void 0:t.filter(i=>!(o!=null&&o.accounts)||o.accounts.includes(i.cloud_account_id??"")),s),n)})}function Ds({accountType:s,accounts:n}){const[o,t]=u.useState(!0);return e.jsxs(j,{gap:2,children:[e.jsxs(C,{gap:2,children:[e.jsx(le,{type:"Cloud",id:s}),e.jsx(d,{color:"textSecondary",children:`${s} (${(n==null?void 0:n.length)||0})`}),e.jsx(E,{}),e.jsx(de,{onClick:()=>t(!o),children:o?e.jsx(Ze,{}):e.jsx(Ke,{})})]}),e.jsx(I,{in:o,children:e.jsxs(j,{gap:1,children:[e.jsxs(je,{children:[e.jsx(d,{className:"account-col",color:"textSecondary",children:"Name"}),e.jsx(d,{className:"rules-col",color:"textSecondary",children:"Violated Rules"}),e.jsx(d,{className:"score-col",color:"textSecondary",children:"Score"})]}),e.jsx(zs,{gap:1,children:n==null?void 0:n.map((i,r)=>e.jsx(Ls,{account:i},r))})]})})]})}function Ls({account:s}){const{score:n,loading:o}=Es({accountId:s.cloud_account_id});return e.jsxs(je,{children:[e.jsx(W,{children:e.jsx(d,{className:"account-col",noWrap:!0,children:s.display_name})}),o?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"rules-col",color:"textSecondary",noWrap:!0,children:e.jsx(Xe,{width:20})}),e.jsx(F,{className:"score-col"})]}):n?e.jsxs(e.Fragment,{children:[e.jsx(W,{children:e.jsx(d,{className:"rules-col",color:"textSecondary",noWrap:!0,children:`${n.total_violated_rules}`})}),e.jsx(F,{className:"score-col",score:n.score})]}):e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"rules-col",color:"textSecondary",noWrap:!0,children:"--"}),e.jsx(F,{className:"score-col",score:100})]})]})}const je=h.div.withConfig({displayName:"ComplianceAccountStatus__Row",componentId:"sc-zoekvx-0"})(({theme:s})=>({display:"flex",alignItems:"center","& > *":{marginRight:s.spacing(1),"&:last-child":{marginRight:0},flexGrow:1,flexBasis:0,"&.rules-col":{maxWidth:100},"&.score-col":{maxWidth:50}}}));function zs({max:s=5,children:n,...o}){const[t,i]=u.useState(!1);return e.jsxs(j,{...o,children:[n.slice(0,s),e.jsx(I,{in:t,children:e.jsx(j,{...o,children:n.slice(s)})}),n.length>s&&e.jsx("div",{children:e.jsx(D,{color:"primary",size:"small",variant:"text",onClick:()=>i(!t),children:t?"Show less":"Show more"})})]})}const L=h.div.withConfig({displayName:"List",componentId:"sc-5myy36-0"})(({theme:s,gap:n=1})=>({"& > *":{marginBottom:s.spacing(n),"&:last-child":{marginBottom:0}}}));function Bs(s){return v(qs,s)}const qs=b(`
  query Rules (
    $filters: RuleFilters) {
      rules(filters: $filters) {
        results {
          id
          name
          description
          severity
        }
      }
  }
`);function Gs({controlId:s,skip:n}){var g;const[o]=y(),{accountsMap:t,loading:i}=Ve({accountIds:(o==null?void 0:o.accounts)??[]}),{data:r,loading:l,error:c}=Bs({skip:n,variables:{filters:{state:["enabled"],compliance_controls_ids:[s]}}}),a=u.useMemo(()=>{var x;return k.sortBy((x=r==null?void 0:r.rules)==null?void 0:x.results,f=>-f.severity)},[(g=r==null?void 0:r.rules)==null?void 0:g.results]),m=l||i,p=u.useCallback(x=>{var f,N;return{...t[x],account_id:(N=(f=t[x])==null?void 0:f.account_id)==null?void 0:N.filter(({account_id:T})=>{var K,X;return!((K=o==null?void 0:o.accounts)!=null&&K.length)||((X=o==null?void 0:o.accounts)==null?void 0:X.includes(T))})}},[t,o==null?void 0:o.accounts]);return e.jsx(I,{in:!!a||!!c,children:!a&&c?e.jsx(w,{error:c}):!a&&m?e.jsxs(C,{gap:1,children:[e.jsx(P,{size:15}),e.jsx(d,{color:"textSecondary",children:"Loading..."})]}):!n&&!(a!=null&&a.length)?e.jsx(d,{children:"None"}):e.jsxs(L,{gap:1,children:[e.jsxs(Ce,{children:[e.jsx(d,{className:"name-col",color:"textSecondary",children:"Name"}),e.jsx(d,{className:"severity-col",color:"textSecondary",children:"Severity"}),e.jsx(d,{className:"violations-col",color:"textSecondary",children:"Failed Resources"}),e.jsx(d,{className:"accounts-col",color:"textSecondary",children:"Violating Accounts"}),e.jsx(d,{className:"score-col",color:"textSecondary",children:"Score"}),e.jsx("div",{className:"actions-col"})]}),a==null?void 0:a.map(x=>e.jsx(Os,{rule:x,accountsMapResult:p(x.id)},x.id))]})})}function Os({rule:s,accountsMapResult:n}){var i,r;const[o]=y(),t=es();return e.jsxs(Us,{className:"hover-me",children:[e.jsxs(j,{className:"name-col",children:[e.jsx(d,{noWrap:!0,children:s.name}),e.jsx(W,{children:e.jsx(d,{color:"textSecondary",noWrap:!0,children:s.description})})]}),e.jsx("div",{className:"severity-col",children:e.jsx(ss,{severity:s.severity})}),e.jsx("div",{className:"violations-col",children:e.jsx(d,{children:(n==null?void 0:n.violationsCount)||0})}),e.jsx("div",{className:"accounts-col",children:e.jsx(ns,{titleIcon:e.jsx(le,{size:"small",type:"Account"}),title:`Violating Accounts (${(i=n==null?void 0:n.account_id)==null?void 0:i.length})`,content:e.jsx(Ms,{accounts:n==null?void 0:n.account_id}),children:e.jsx(d,{children:((r=n==null?void 0:n.account_id)==null?void 0:r.length)||0})})}),e.jsx("div",{className:"score-col",children:e.jsx(J,{scoreResult:{total_violated_rules:n==null?void 0:n.violationsCount}})}),e.jsx("div",{className:"actions-col hide-me",children:e.jsx(D,{size:"small",variant:"text",endIcon:e.jsx(os,{fontSize:"small"}),onClick:()=>t({ruleId:s.id,filters:{account:o==null?void 0:o.accounts}}),children:"Full Details"})})]})}function Ms({accounts:s}){const n=ts();return e.jsx(j,{gap:1,children:s==null?void 0:s.map(({account_id:o,violation_count:t})=>e.jsxs(C,{gap:1,children:[e.jsx(d,{children:n(o)}),e.jsx(d,{color:"textSecondary",children:`(${t})`})]},o))})}const Ce=h.div.withConfig({displayName:"ComplianceCategoryControlRules__Row",componentId:"sc-1n42ce2-0"})(({theme:s})=>({display:"flex",borderRadius:s.shape.borderRadius,padding:s.spacing(2),gap:s.spacing(2),alignItems:"center","& > *":{flexGrow:1,flexBasis:0,"&.severity-col":{minWidth:50,maxWidth:80},"&.violations-col":{minWidth:50,maxWidth:100},"&.accounts-col":{minWidth:80,maxWidth:120},"&.score-col":{minWidth:80,maxWidth:100},"&.actions-col":{opacity:.3,maxWidth:100}}})),Us=h(Ce).withConfig({displayName:"ComplianceCategoryControlRules__RuleWrapper",componentId:"sc-1n42ce2-1"})(({theme:s})=>({background:s.palette.background.paper})),ye=_.createContext(null);function fe(s){const[n,o]=u.useContext(ye);return[!!(n!=null&&n[s]),t=>o({...n||{},[s]:t})]}function Qs(s){const n=Q("compliance_toggle",{});return e.jsx(ye.Provider,{value:n,...s})}function Hs({controls:s}){var l;const n=u.useMemo(()=>s==null?void 0:s.map(c=>c.control_id),[s]),[o]=y(),{data:t,loading:i}=Y({skip:!n,variables:{group_by:S.ComplianceControlsIds,filters:{accounts:o==null?void 0:o.accounts,compliance_controls_ids:n}}}),r=$((l=t==null?void 0:t.compliance_entities_scores)==null?void 0:l.results,S.ComplianceControlsIds);return e.jsx(L,{gap:1,children:s==null?void 0:s.map((c,a)=>e.jsxs(_.Fragment,{children:[e.jsx(Ys,{control:c,scoreResult:r[c.control_id],loading:i}),a!==s.length-1&&e.jsx(M,{})]},a))})}function Ys({control:s,scoreResult:n,loading:o}){const[t,i]=fe(s.control_id);return e.jsxs(e.Fragment,{children:[e.jsxs(Ks,{...(n||s.description)&&{onClick:()=>i(!t)},children:[t?e.jsx(pe,{}):e.jsx(ue,{style:{visibility:n||s.description?"visible":"hidden"}}),e.jsx(j,{gap:1,style:{flexGrow:1,overflow:"visible"},children:e.jsxs(C,{gap:2,grow:!0,style:{overflow:"visible"},children:[e.jsx(d,{style:{flexGrow:2},children:s.name}),e.jsxs(C,{gap:2,style:{overflow:"visible"},children:[e.jsx(J,{scoreResult:n}),e.jsx(Z,{className:"count-col",scoreResult:n,loading:o})]})]})})]}),e.jsx(I,{in:t,children:e.jsxs(j,{gap:1,children:[s.description&&e.jsx(Zs,{children:e.jsx(d,{color:"textSecondary",style:{maxWidth:600},children:s.description})}),n&&e.jsx(Js,{children:e.jsx(Gs,{controlId:s.control_id,skip:!t})})]})})]})}const J=h(({scoreResult:s,...n})=>{const o={manual:!s,passed:s&&!s.total_violated_rules,failed:(s==null?void 0:s.total_violated_rules)>0};return e.jsx("div",{style:{width:150,...n.style},children:e.jsxs(d,{display:"inline",className:is(n.className,o),children:[o.manual&&"Manual",o.passed&&"Passed",o.failed&&"Failed"]})})}).withConfig({displayName:"ComplianceCategoryControls__ScorePassFail",componentId:"sc-9mpnc8-0"})(({theme:s})=>({padding:s.spacing(1,1.5),borderRadius:s.shape.borderRadius*2,textAlign:"center","&.manual":{background:z(s.palette.common.gray,.2)},"&.passed":{background:z(s.palette.common.green,.2)},"&.failed":{background:z(s.palette.common.red,.2)}})),Js=h.div.withConfig({displayName:"ComplianceCategoryControls__ControlWrapper",componentId:"sc-9mpnc8-1"})(({theme:s})=>({background:s.palette.background.default,borderRadius:s.shape.borderRadius,padding:s.spacing(2),marginLeft:s.spacing(4)})),Zs=h.div.withConfig({displayName:"ComplianceCategoryControls__ControlDescriptionWrapper",componentId:"sc-9mpnc8-2"})(({theme:s})=>({padding:s.spacing(2),marginLeft:s.spacing(5)})),_e=h.div.withConfig({displayName:"ComplianceCategoryControls__Row",componentId:"sc-9mpnc8-3"})(({theme:s,onClick:n})=>({display:"flex",gap:s.spacing(2),padding:s.spacing(2),borderRadius:s.shape.borderRadius,...n&&{cursor:"pointer","&:hover":{background:s.palette.action.hover}},"& .count-col":{flexGrow:1,maxWidth:300}})),Ks=h(_e).withConfig({displayName:"ComplianceCategoryControls__ControlRow",componentId:"sc-9mpnc8-4"})(({theme:s})=>({}));function Xs(s){return v(Vs,s)}const Vs=b(`
  query ComplianceControls (
    $filters: ComplianceControlsFilters) {
      compliance_controls(filters: $filters) {
        results {
          control_id
          name
          description
        }
      }
  }
`);function en({categories:s}){var l;const[n]=y(),o=sn(s),{data:t,loading:i}=Y({variables:{group_by:S.ComplianceCategoriesIds,filters:{accounts:n==null?void 0:n.accounts,compliance_categories_ids:o}}}),r=$((l=t==null?void 0:t.compliance_entities_scores)==null?void 0:l.results,S.ComplianceCategoriesIds);return e.jsx(L,{gap:1,children:s==null?void 0:s.map((c,a)=>e.jsx(nn,{category:c,scoreResult:r[c.category_id],loading:i},a))})}function sn(s){return u.useMemo(()=>(s==null?void 0:s.map(n=>n.category_id??""))??[],[s])}function nn({category:s,scoreResult:n,loading:o}){var a;const[t,i]=fe(s.category_id),{data:r,error:l}=Xs({skip:!t,variables:{filters:{category_id:s.category_id}}}),c=(a=r==null?void 0:r.compliance_controls)==null?void 0:a.results;return e.jsxs(on,{children:[e.jsxs(tn,{onClick:()=>i(!t),children:[t?e.jsx(pe,{color:"action"}):e.jsx(ue,{color:"action"}),e.jsxs(j,{gap:1,style:{flexGrow:1},children:[e.jsxs(C,{gap:2,grow:!0,style:{flexGrow:1},children:[e.jsx(d,{variant:"subtitle2",noWrap:!0,style:{flexGrow:2},children:s.name}),e.jsxs(C,{gap:2,children:[e.jsx(J,{style:{visibility:"hidden"}}),e.jsx(Z,{className:"count-col",scoreResult:n,loading:o,style:{flexGrow:1}})]})]}),e.jsx(d,{color:"textSecondary",style:{maxWidth:600},children:s.description})]})]}),e.jsx(I,{in:t&&(!!c||!!l),children:e.jsx(rn,{children:!(c!=null&&c.length)&&l?e.jsx(w,{error:l}):e.jsx(Hs,{controls:c})})})]})}const Z=({scoreResult:s,loading:n=!1,...o})=>{const{total_violated_rules:t,total_rules:i}=s||{},r=i-t;return e.jsx(d,{color:s?"textPrimary":"textSecondary",noWrap:!0,...o,style:{...o.style,minWidth:100,display:"flex",alignItems:"center"},children:!i&&n?e.jsx(d,{variant:"caption",color:"textSecondary",children:"Loading..."}):i&&`${r} of ${i} Passed Rules`})},on=h.div.withConfig({displayName:"ComplianceCategories__CategoryContainer",componentId:"sc-1bwm3bw-0"})(({theme:s})=>({background:s.palette.background.paper,borderRadius:s.shape.borderRadius,overflow:"hidden"})),tn=h(_e).withConfig({displayName:"ComplianceCategories__CategoryRow",componentId:"sc-1bwm3bw-1"})(({theme:s})=>({})),rn=h.div.withConfig({displayName:"ComplianceCategories__CategoryWrapper",componentId:"sc-1bwm3bw-2"})(({theme:s})=>({padding:s.spacing(3),paddingLeft:s.spacing(4)}));function an(s){return v(cn,s)}const cn=b(`
  query ComplianceCategories (
    $filters: ComplianceCategoriesFilters) {
      compliance_categories(filters: $filters) {
        results {
          category_id
          name
          description
        }
      }
  }
`);function ve(s){var i;const{data:n,...o}=me({variables:{filters:{id:[s]}}});return{compliance:u.useMemo(()=>{var r,l;return(l=(r=n==null?void 0:n.compliance_entities)==null?void 0:r.results)==null?void 0:l[0]},[(i=n==null?void 0:n.compliance_entities)==null?void 0:i.results]),...o}}function be(s){var r;const[n]=y(),{data:o,...t}=v(ln,{variables:{filters:{accounts:n==null?void 0:n.accounts,compliance_ids:[s]}}});return{result:u.useMemo(()=>{var l,c;return(c=(l=o==null?void 0:o.compliance_entities_scores)==null?void 0:l.results)==null?void 0:c[0]},[(r=o==null?void 0:o.compliance_entities_scores)==null?void 0:r.results]),...t}}const ln=b(`
  query ComplianceScore ($filters: ComplianceEntitiesScoresFilters) {
      compliance_entities_scores(filters: $filters, group_by: compliance_ids) {
        results {
          total_rules
          total_violated_rules
          score
        }
      }
  }
`);function dn(s){return v(pn,s)}const pn=b(`
  query ComplianceScoresChart (
    $filters: ComplianceEntitiesScoresFilters) {
      compliance_scores_chart(filters: $filters, period: day) {
        results {
          period
          score
        }
      }
  }
`);function un({complianceId:s,accounts:n}){var c;const o=ie(),{data:t,error:i,loading:r}=dn({variables:{filters:{compliance_ids:[s],accounts:n}}}),l=u.useMemo(()=>{var a;return k.sortBy((a=t==null?void 0:t.compliance_scores_chart)==null?void 0:a.results,"period")},[(c=t==null?void 0:t.compliance_scores_chart)==null?void 0:c.results]);return r?e.jsx(G,{children:e.jsx(rs,{})}):i?e.jsx(G,{children:e.jsx(w,{error:i})}):l!=null&&l.length?e.jsx(ms,{options:{dark:o.palette.type==="dark",padding:{top:o.spacing(2),right:o.spacing(4),left:o.spacing(2),bottom:o.spacing(2)},getDatumStyle:a=>{var m;return{circle:{opacity:typeof((m=a.originalDatum)==null?void 0:m.score)>"u"?0:1}}},data:[{label:"Score",data:l}],primaryAxis:{scaleType:"time",showGrid:!1,tickCount:Math.min((l==null?void 0:l.length)-1,10),getValue(a){return new Date(a.period)},formatters:{scale:a=>Ie(a).format("MMM DD")}},secondaryAxes:[{showDatumElements:!0,tickCount:5,hardMin:0,hardMax:100,getValue(a){return a.score},formatters:{scale:a=>`${Math.floor(a)}%`}}]}}):e.jsx(G,{children:e.jsx(d,{color:"textSecondary",children:"--"})})}function mn({complianceId:s}){const{workspaceId:n,session:o}=Ne(),t=ke(),[i,r]=u.useState(!1),[l]=y(),c=l==null?void 0:l.accounts;async function a(){try{r(!0),await xn(s,c,n,o==null?void 0:o.access_token)}catch(m){t(`Download error: ${m.message}`,"error")}finally{r(!1)}}return e.jsx(D,{variant:"text",disabled:i,onClick:a,startIcon:i?e.jsx(P,{size:15}):e.jsx(as,{fontSize:"small"}),size:"small",children:"Download"})}async function xn(s,n,o,t){var a,m;const i=await fetch("/api/standards/compliances/download_report?"+$e({compliance_id:s,accounts_filter:n}),{headers:{customer:o,authorization:`Bearer ${t}`}});if(!i.ok)throw new Error(await i.text());const r=await i.blob(),l=window.URL.createObjectURL(r),c=document.createElement("a");c.href=l,c.download=((m=(a=i.headers.get("Content-Disposition"))==null?void 0:a.split("filename="))==null?void 0:m[1])??"report.csv",document.body.appendChild(c),c.click(),c.remove()}function hn({complianceId:s}){var x;const n=Re(),[o,t]=y(),[i,r,l]=Q("compliance_chart",!1),{data:c,loading:a,error:m}=an({variables:{filters:{compliance_id:s}}}),{compliance:p}=ve(s),g=(x=c==null?void 0:c.compliance_categories)==null?void 0:x.results;return e.jsxs(A,{children:[e.jsxs(U,{paper:!0,children:[e.jsx(de,{onClick:()=>n.goBack(),children:e.jsx(cs,{})}),e.jsx(xe,{complianceType:p==null?void 0:p.type}),e.jsx(d,{variant:"h6",children:p==null?void 0:p.name})]}),e.jsxs(A,{direction:"row",children:[e.jsx(ls,{width:350,children:e.jsx(yn,{complianceId:s})}),e.jsx(gn,{id:"compliance",children:e.jsxs(j,{gap:2,padding:2,style:{position:"relative",overflow:"auto",flexGrow:1},children:[e.jsxs(Cn,{gap:2,children:[e.jsxs(oe,{style:{position:"relative",zIndex:100},children:[a&&e.jsxs(e.Fragment,{children:[e.jsx(P,{size:15}),e.jsx(d,{children:"Loading..."})]}),e.jsx(jn,{complianceId:s}),e.jsx(ae,{direction:"row",filterValues:o,onChange:t,children:e.jsx(ce,{attribute:"accounts",displayName:"Accounts"})}),e.jsx(E,{}),e.jsx(D,{variant:"text",selected:!!i,size:"small",startIcon:e.jsx(ds,{fontSize:"small",color:"action"}),onClick:()=>i?l():r(!0),children:"Trend"}),e.jsx(mn,{complianceId:s})]}),e.jsx(I,{in:!!i,children:e.jsx(oe,{height:250,children:e.jsx(un,{complianceId:s,accounts:o==null?void 0:o.accounts})})})]}),m&&e.jsx(w,{variant:g!=null&&g.length?"inline":"default",error:m}),e.jsx(Qs,{children:e.jsx(en,{categories:g})})]})})]})]})}function gn({id:s,children:n}){const o=u.useRef(),[t,i,r]=Q(`scroll-${s}`,0),l=_.Children.only(n),c=te(i,1e3);return u.useEffect(()=>{t&&o.current&&(o.current.scrollTop=Number(t),r());const a=o.current;return()=>{a!=null&&a.scrollTop&&i(a.scrollTop)}},[]),_.cloneElement(l,{ref:o,onScroll:u.useCallback(a=>{c(a.currentTarget.scrollTop)},[c])})}function jn({complianceId:s}){const{result:n,loading:o}=be(s);return e.jsx(Z,{variant:"subtitle1",scoreResult:n,loading:o})}const Cn=h(L).withConfig({displayName:"ComplianceDetailsPage__StickyList",componentId:"sc-kx4gel-0"})(({theme:s})=>({position:"sticky",top:0}));function yn({complianceId:s}){const{compliance:n}=ve(s);return e.jsxs(j,{gap:2,padding:3.33,style:{paddingTop:12},children:[e.jsxs(j,{gap:1,children:[e.jsx(ee,{children:e.jsx(xe,{complianceType:n==null?void 0:n.type,fontSize:"large"})}),e.jsx(ee,{gap:2,children:e.jsxs(j,{gap:2,children:[e.jsxs(C,{gap:2,children:[e.jsx(d,{variant:"h6",children:n==null?void 0:n.name}),e.jsx(E,{}),e.jsx("div",{children:e.jsx(fn,{complianceId:s})})]}),e.jsx(d,{color:"textSecondary",children:n==null?void 0:n.description})]})})]}),e.jsx(M,{}),e.jsx(Ws,{complianceId:s})]})}function fn({complianceId:s}){const{result:n,error:o}=be(s);return o?e.jsx(w,{variant:"inline",error:o}):e.jsx(F,{score:n==null?void 0:n.score,size:"large"})}function oe(s){const n=ie();return e.jsx(U,{paper:!0,round:!0,...s,style:{...s.style,height:s.height,boxShadow:`0 ${-n.spacing(3)}px 0 0 ${n.palette.background.default}, 0 0 ${n.spacing(3)}px ${n.spacing(1)}px  ${n.palette.background.default}, 0 ${n.spacing(1)}px ${n.spacing(1)}px ${-n.spacing(1)}px ${n.palette.common.black}`}})}function In(){const s=Te();return e.jsxs(Fe,{children:[e.jsx(V,{path:`${s.url}/:id`,render:n=>e.jsx(hn,{complianceId:n.match.params.id})}),e.jsx(V,{render:()=>e.jsx(ks,{})})]})}export{In as default};
