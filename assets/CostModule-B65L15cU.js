import{q as D,o as I,r as m,j as t,aA as Ge,as as He,at as Be,a as ve,ar as R,aB as M,f as Se,g as Qe,aC as qe,l as E,F as Ye,B as je,R as H,aD as Ue,e as Xe,aE as Je,T as Ze,aF as et,n as tt}from"./index-Ba6YVotX.js";import{fu as v,fv as st,f5 as rt,q as ye,r as nt,s as at,K as ot,b as k,d as y,e_ as he,e$ as Y,dx as it,fw as ke,fx as lt,f0 as U,n as ge,fy as Te,L,U as oe,f6 as Ie,fz as fe,fA as Fe,fh as ct,fB as ut,w as dt,fC as pt,I as ue,bd as mt,fD as ht,fE as ft,fF as w,fG as gt,as as xt,fH as Ct,ap as De,c9 as jt,h as Pe,fI as yt,bg as _t,fJ as bt,m as vt,cX as St,fr as kt,fK as Tt,fL as It,fM as Ft,fN as Me,bG as Re,bu as Ne,M as G,bv as ne,T as Le,d_ as Oe,c2 as Ae,C as Ee,fO as Dt,fP as Ve,B as ae,c0 as Pt,by as Mt,eF as Rt,ac as Nt,G as Lt,fQ as Ot,fR as At,cs as Et,N as Vt,O as _e,fS as zt,dp as wt,aw as $t,R as Kt,fT as Wt,S as Gt,fU as Ht,fV as Bt,fW as Qt,fX as qt}from"./App-CM6DQiPl.js";import"./transform-CZcZjpP2.js";import{C as Yt}from"./Chart-CAE9CZaH.js";import{F as Ut}from"./useRuleFilterValues-B1HM72N0.js";import{u as Xt}from"./search-Wc3juolO.js";import"./color-9lF95FHy.js";function ze(e){this._context=e}ze.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(e,s){switch(e=+e,s=+s,this._point){case 0:this._point=1,this._line?this._context.lineTo(e,s):this._context.moveTo(e,s);break;case 1:this._point=2;default:this._context.lineTo(e,s);break}}};function Jt(e){return new ze(e)}const pe=9;function Zt(){const e="total_cost",[{customRange:s,filters:r,chartType:n,chartPeriod:a,periodValue:i}]=v(),c=i==="custom"?I(s.from_timestamp).utc().add(I(s.from_timestamp).utc().startOf(a).isSame(s.from_timestamp)?0:1,a).startOf(a).toISOString():I(r.from_timestamp).utc().startOf(rs(i)).toISOString(),p=ns({from:c,to:r==null?void 0:r.to_timestamp,exact:!!s,period:a}),h=n==="stacked",j=m.useMemo(()=>["#003F5C","#2F4B7C","#665191","#A05195","#D45087","#F95D6A","#FF7C43","#FFA600","#D77741","#46CBD3","#C8DDD9"],[]),{data:u,loading:f,error:o,previousSerie:d,totalResults:T}=ss({tickCount:p,valueField:e,colors:j,startTimestamp:c}),C=m.useMemo(()=>u==null?void 0:u.map(({data:x})=>x).flat().map(({value:x})=>x).filter(x=>x),[u]),b=st(C),_=m.useCallback(x=>`$${rt(x,{maximumFractionDigits:b})}`,[b]),l=os({data:u,tickCount:p,formatValue:_,startTimestamp:c,endTimestamp:i==="current_year"||i==="current_month"?I.utc().endOf(i==="current_month"?"month":"year").toISOString():r==null?void 0:r.to_timestamp,previousSerie:d,stacked:h,totalResults:T,valueField:e});return t.jsx(as,{children:f?t.jsx(ye,{children:t.jsx(nt,{})}):o?t.jsx(ye,{children:t.jsx(at,{error:o})}):(u==null?void 0:u.length)>0&&t.jsxs(ot,{column:!0,grow:!0,children:[t.jsx("div",{style:{position:"relative",flexGrow:1},children:t.jsx(Yt,{options:l})}),t.jsx(es,{data:u})]})})}function es({data:e}){return t.jsx(ts,{gap:2,children:e.map(({label:s,color:r},n)=>t.jsxs(k,{gap:1,style:{alignItems:"center"},children:[t.jsx(we,{color:r}),t.jsx(y,{variant:"body2",children:s})]},n))})}const ts=D(k).withConfig({displayName:"CostChart__LegendContainer",componentId:"sc-a2qyjp-0"})(({theme:e})=>({padding:e.spacing(2),paddingLeft:50,flexWrap:"wrap"}));function ss(e){const{tickCount:s,valueField:r,colors:n,startTimestamp:a}=e,[{expenseType:i,periodValue:c,chartPeriod:p,trendRange:h,customRange:j,filters:u,groupByValue:f,groupByTagKey:o}]=v(),d=he(c),T=he(c,!0),C=j||d,b=h||(j?null:T),{results:_,loading:l}=Y(m.useMemo(()=>({operationName:"CostChartIndexQuery",groupBy:[f],groupByTagKey:o,filters:{...u,...C},limit:pe+1,expenseType:i,sort:{field:(()=>{switch(i){case"cloud":return He.TotalDirectCost;case"kubernetes":return Ge.TotalCost}})(),direction:Be.Desc}}),[i,u,f,C,o])),x=_==null?void 0:_.slice(0,pe),P=x==null?void 0:x.map(({[f]:S})=>S),V=it(),{data:{resources:A}={}}=ve(Se(`
        query ChartIndexResourcesQuery($ids: [ID!]){
          resources(ids: $ids, return_deleted: true) {
            id
            type
            display_name
            is_public
            state
            parent
          }
        }
      `),{skip:!_&&![R.Vpc,M.Namespace,M.Node,M.Deployment,M.ReplicaSet,M.StatefulSet,M.DaemonSet,M.ControllerId].includes(f),variables:{ids:x==null?void 0:x.map(({[f]:S})=>S)}}),g=m.useCallback(S=>{var O;return((O=A==null?void 0:A.find(({id:N})=>N===S))==null?void 0:O.display_name)||S},[A]),X=m.useCallback(S=>{switch(f){case R.Account:return V(S);case R.ResourceType:return Qe(S);case R.Vpc:case M.Namespace:case M.Deployment:case M.ReplicaSet:case M.StatefulSet:case M.DaemonSet:case M.ControllerId:return g(S);case M.Node:default:return S}},[V,g,f]),{results:J}=Y(m.useMemo(()=>({operationName:"CostChartCurrentQuery",groupBy:[p],groupByTagKey:o,expenseType:i,filters:{...u,...C},skipQuery:!_,limit:1e4}),[p,i,u,C,_,o])),{results:$,loading:F,error:Z}=Y(m.useMemo(()=>({operationName:"CostChartCurrentGroupQuery",groupBy:[p,f],groupByTagKey:o,filters:{...u,...C,...f===R.TagValue?{tags:[...u.tags||[],{logic_operand:qe.Or,tag_filters:P==null?void 0:P.map(S=>({key:o,value:S}))}]}:{[f]:P}},skipQuery:!(_!=null&&_.length),expenseType:i,limit:1e4}),[p,f,o,u,C,_,P,i])),{results:z,loading:K,error:Q}=Y({operationName:"CostChartPreviousQuery",groupBy:[p],groupByTagKey:o,filters:m.useMemo(()=>({...u,...b}),[u,b]),skipQuery:!b||!p,expenseType:i,limit:1e4}),W=E.keyBy(z,p),ee=m.useMemo(()=>z&&b&&{label:ke(c)||"Previous Direct Cost",val:"previous",color:"#0EA3C7",data:new Array(s).fill(!0).map((S,O)=>{var le;const N=I(a).utc().add(O,p).toISOString();return{index:O,date:N,value:(le=W==null?void 0:W[N])==null?void 0:le[r]}})},[p,c,z,W,b,a,s,r]),Ce=m.useMemo(()=>{if(!$)return[];const S=E.chain($).groupBy(p).mapValues(N=>E.groupBy(N,f)).value(),O=E.chain(P).map(N=>({val:N,label:X(N),color:"",data:new Array(s).fill(!0).map((le,te)=>{var se,ce,re;const q=I(a).utc().add(te,p).toISOString();return{index:te,date:q,value:(re=(ce=(se=S==null?void 0:S[q])==null?void 0:se[N])==null?void 0:ce[0])==null?void 0:re[r]}})})).value();if($&&((_==null?void 0:_.length)??0)>pe){const N=E.keyBy(J,p);O.push({label:"Other",val:"other",color:"#C8DDD9",data:new Array(s).fill(!0).map((le,te)=>{var re;const q=I(a).utc().add(te,p).toISOString(),se=(re=N[q])==null?void 0:re[r],ce=E.chain(O).map("data").flatten().filter(({date:We})=>q===We).sumBy("value").value()||0;return{index:te,date:q,value:se&&se-ce}})})}return O},[$,p,P,_==null?void 0:_.length,f,X,s,a,r,J]);return Ce.forEach((S,O)=>{S.color=S.color||n[O%n.length]}),{data:Ce,previousSerie:ee,totalResults:J,loading:l||F||K,error:Z||Q}}function rs(e){switch(e){case"current_month":case"last_month":return"month";case"current_year":case"last_year":return"year";case"custom":return"day";default:return null}}function ns({from:e,to:s,exact:r,period:n}){return m.useMemo(()=>{const a=1+I(s).diff(e,n);return!r&&n==="day"?Math.max(a,I(e).daysInMonth()):a},[n,r,e,s])}const as=D.div.withConfig({displayName:"CostChart__ChartWrapper",componentId:"sc-a2qyjp-1"})(({theme:e})=>({height:"100vh",maxHeight:"35vh",display:"flex",flexDirection:"column",border:`solid 1px ${e.palette.dividerLight}`,borderRadius:e.shape.borderRadius}));function os({data:e,tickCount:s,formatValue:r,startTimestamp:n,endTimestamp:a,previousSerie:i,stacked:c,totalResults:p,valueField:h}){const j=Ye(),u=m.useMemo(()=>e.slice().reverse(),[e]),[{chartPeriod:f}]=v();return m.useMemo(()=>({data:e,dark:j.palette.type==="dark",padding:{top:j.spacing(2),right:j.spacing(2),left:j.spacing(2),bottom:j.spacing(2)},getSeriesStyle:o=>({color:o.originalSeries.color}),getDatumStyle:o=>{var d;return{circle:{opacity:typeof((d=o.originalDatum)==null?void 0:d.value)>"u"?0:1}}},primaryAxis:{getValue:o=>I(n).add(o.index,f).toDate(),scaleType:"time",...a&&{hardMax:new Date(a)},tickCount:Math.min(15,s),padBandRange:!!c,innerBandPadding:0,outerBandPadding:30,showGrid:!1,formatters:{scale:o=>I(o).format(f==="day"?"MMM-DD":"MMM-YYYY")}},secondaryAxes:[{showDatumElements:!0,getValue:o=>o.value,scaleType:"linear",hardMin:0,...c?{stacked:c,elementType:"bar"}:{curve:Jt},formatters:{scale:o=>typeof o<"u"&&(o===0||o>=1||o<=-1)?r(o):"",cursor:o=>typeof o<"u"?r(o):""}}],tooltip:{render:({focusedDatum:o})=>o&&u.find(({data:d})=>{var T;return(T=d.find(C=>C.date===o.originalDatum.date))==null?void 0:T.value})&&t.jsx(is,{series:u,totalResults:p,focusedDatum:o,previousSerie:i,valueField:h,startTimestamp:n})}}),[e,j,a,s,c,n,f,r,u,p,i,h])}function is({series:e,previousSerie:s,totalResults:r,focusedDatum:n,valueField:a,startTimestamp:i}){var b,_;const[{chartPeriod:c,expenseType:p}]=v(),h=(b=r==null?void 0:r.find(({[c]:l})=>l===n.originalDatum.date))==null?void 0:b[a],{date:j,value:u}=((_=s==null?void 0:s.data)==null?void 0:_.find(l=>l.index===n.originalDatum.index))||{},f=e.find(({val:l})=>l==="other"),o=l=>{var x;return(x=l.data.find(P=>P.index===n.originalDatum.index))==null?void 0:x.value},d=e.map(l=>({serie:l,value:o(l)})).filter(({serie:{val:l},value:x})=>l!=="other"&&x).sort((l,x)=>x.value-l.value);f&&d.push({serie:f,value:o(f)});const T=c==="month"?"MMM-YYYY":"MMM-D",C=l=>p==="kubernetes"?`Total allocation cost for ${I(l).format(T)}`:`Total cost for ${I(l).format(T)}`;return t.jsx(lt,{children:t.jsxs(ls,{children:[t.jsxs("div",{children:[h&&t.jsxs(k,{gap:1,children:[t.jsx(me,{style:{fontWeight:"bold",flexGrow:1},children:C(I.utc(i).add(n.originalDatum.index,c))}),t.jsx(U,{value:h})]}),u&&t.jsxs(k,{gap:1,children:[t.jsx(me,{style:{flexGrow:1},children:C(I.utc(j))}),t.jsx(U,{value:u})]})]}),d.length>0&&t.jsx(ge,{}),d.length>0&&t.jsx("div",{children:d.map(({serie:{val:l,label:x,color:P},value:V},A)=>{const g=l===n.originalSeries.val;return t.jsxs(k,{gap:1,style:{alignItems:"center"},children:[t.jsx("div",{children:t.jsx(we,{color:P,focused:g})}),t.jsx(me,{style:{fontWeight:g?"bold":"normal",flexGrow:1},children:x}),t.jsx(U,{value:V,style:{minWidth:"fit-content",textAlign:"right",fontWeight:l===n.originalSeries.val?"bold":"normal"}})]},A)})})]})})}const ls=D.div.withConfig({displayName:"CostChart__TooltipPaper",componentId:"sc-a2qyjp-2"})(({theme:e})=>({backgroundColor:e.palette.background.paper,borderRadius:e.shape.borderRadius/2,padding:e.spacing(2),width:300,"& > *":{marginBottom:e.spacing(1),"&:last-child":{marginBottom:0}}})),me=D(y).withConfig({displayName:"CostChart__TooltipTypography",componentId:"sc-a2qyjp-3"})(({theme:e})=>({fontSize:e.typography.body2.fontSize,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"})),we=D.div.withConfig({displayName:"CostChart__TooltipCircle",componentId:"sc-a2qyjp-4"})(({theme:e,color:s,focused:r})=>({width:12,height:12,borderRadius:"50%",backgroundColor:s,border:`solid 2px ${r?e.palette.text.primary:"transparent"}`}));function cs(e){const[{expenseType:s,periodValue:r,trendRange:n,filters:a}]=v(),{results:i,loading:c}=Y({operationName:"CostCurrentTotalQuery",groupBy:m.useMemo(()=>[],[]),trend_period:Te(r),trend_range:n,filters:a,expenseType:s}),{trend_percentage:p,total_cost:h,predicted_cost:j}=(i==null?void 0:i[0])||{},u=he(r,!0),f=n||u,{results:o,loading:d}=Y({operationName:"CostPreviousTotalQuery",groupBy:m.useMemo(()=>[],[]),expenseType:s,filters:m.useMemo(()=>({...a,...f}),[a,f])}),{total_cost:T}=(o==null?void 0:o[0])||{},C=c||d;return t.jsx(L,{gap:1,...e,children:t.jsx(k,{gap:1,style:{alignItems:C?"center":"flex-start"},children:C?t.jsx(y,{variant:"caption",color:"textSecondary",children:"Loading..."}):t.jsxs(k,{gap:4,children:[t.jsx(oe,{placement:"top",title:s==="cloud"?t.jsxs(t.Fragment,{children:[t.jsx(y,{children:"Calculated by total direct cost"}),t.jsx(y,{color:"textSecondary",children:"The trend is calculated against the previous period"})]}):s==="kubernetes"?t.jsxs(t.Fragment,{children:[t.jsx(y,{children:"Calculated by total cluster allocation"}),t.jsx(y,{color:"textSecondary",children:"The trend is calculated against the previous period"})]}):t.jsx(t.Fragment,{}),children:t.jsx(L,{children:t.jsxs(k,{gap:1,children:[t.jsx(Ie,{size:"large",trend:p,loading:C}),t.jsxs(L,{children:[t.jsxs(k,{style:{alignItems:"flex-end"},gap:1,children:[t.jsx(us,{value:h??0,variant:"h6"}),p&&t.jsxs(y,{variant:"caption",color:"textSecondary",style:{lineHeight:"normal"},children:[Number(p).toLocaleString(void 0,{maximumFractionDigits:1}),"%"]})]}),t.jsx(y,{variant:"caption",color:"textSecondary",children:r==="custom"?s==="kubernetes"?"Total Allocation Cost":"Direct total":fe[r]})]})]})})}),(r!=="custom"||n)&&t.jsxs(L,{children:[t.jsx(U,{value:T??0,variant:"h6",color:"textSecondary",style:{lineHeight:"normal"}}),t.jsx(y,{variant:"caption",color:"textSecondary",children:r==="custom"&&n?Fe(n.from_timestamp,n.to_timestamp):ke(r)})]}),!1]})})})}const us=D(U).withConfig({displayName:"CostTotal__HeaderCostValue",componentId:"sc-1jyofkr-0"})(({theme:e})=>({lineHeight:"normal"}));function ds({children:e}){const[{expenseType:s,filterValues:r,getLink:n,groupByValue:a,sort:i,chartPeriod:c,chartType:p,customRange:h,trendRange:j,kubernetesCluster:u,periodValue:f},{setGroupByValue:o,setKubernetesCluster:d,setSort:T,setFilterValues:C,setCustomRange:b,setTrendRange:_,setChartPeriod:l,setChartType:x,setPeriodValue:P}]=v(),V=s==="kubernetes"?je.CostKubernetes:je.Cost,A=ps(s,{filters:r,groupBy:a,sort:i,chartPeriod:c,chartType:p,customRange:h,trendRange:j,kubernetesCluster:u,period:f});return t.jsx(ct,{screen:V,body:A,updateBody:g=>{o(g==null?void 0:g.groupBy),d(g==null?void 0:g.kubernetesCluster),T(g==null?void 0:g.sort),C(g==null?void 0:g.filters),b(g==null?void 0:g.customRange),_(g==null?void 0:g.trendRange),l(g==null?void 0:g.chartPeriod),x(g==null?void 0:g.chartType),P(g==null?void 0:g.period)},getLink:n,children:e})}function ps(e,s){const r=ut(e);return m.useMemo(()=>E.omitBy(s,(n,a)=>E.isEqual(n,r[a])),[s,r])}function ms(e){const[{settings:s}]=v();return t.jsx(dt,{in:s==null?void 0:s.chartOpen,...e})}function hs(){const[{settings:e,chartType:s},{updateSettings:r,setChartType:n}]=v();return t.jsx(oe,{title:"Line or stacked bar chart",children:t.jsxs(pt,{children:[t.jsx(ue,{selected:(e==null?void 0:e.chartOpen)&&s==="line",onClick:()=>{n("line"),r==null||r({chartOpen:e!=null&&e.chartOpen?e.chartOpen&&s==="line"?!1:s==="line"?!e.chartOpen:e.chartOpen:!0})},children:t.jsx(mt,{fontSize:"small"})}),t.jsx(ue,{selected:(e==null?void 0:e.chartOpen)&&s==="stacked",onClick:()=>{n("stacked"),r==null||r({chartOpen:e!=null&&e.chartOpen?e.chartOpen&&s==="stacked"?!1:s==="stacked"?!e.chartOpen:e.chartOpen:!0})},children:t.jsx(ht,{fontSize:"small"})})]})})}function fs(){return ft([w(xs),w(Cs),w(js),w(ys),w(_s),w(bs),w(vs),w(Ss),w(gs),gt(ks,{addButtonText:"Add label"})])}const B={renderOption:e=>e.includes(" ")?e:t.jsx(xt,{id:e})},gs={key:"resource_id",displayName:"Resource",...B},xs={key:"namespace",displayName:"Namespace",...B},Cs={key:"deployment",displayName:"Deployment",...B},js={key:"node",displayName:"Node",...B},ys={key:"replica_set",displayName:"ReplicaSet",...B},_s={key:"stateful_set",displayName:"StatefulSet",...B},bs={key:"daemon_set",displayName:"DaemonSet",...B},vs={key:"service",displayName:"Service"},Ss={key:"controller_kind",displayName:"Controller Kind"},ks={key:"tags",displayName:"Labels"};function Ts(){const[{expenseType:e}]=v();switch(e){case"cloud":return t.jsx(Is,{});case"kubernetes":return t.jsx(Fs,{})}}function Is(){const[{filterValues:e},{setFilterValues:s}]=v(),r=Ct();return t.jsx(De,{filters:r,filterValues:e,onChange:s})}function Fs(){const[{filterValues:e},{setFilterValues:s}]=v(),r=fs();return t.jsx(De,{filters:r,filterValues:e,onChange:s})}function Ds(){const[{settings:e},{updateSettings:s}]=v();return t.jsx(jt,{open:e==null?void 0:e.filtersOpen,children:t.jsxs(L,{className:"filters",style:{maxWidth:300},grow:[0,1],children:[t.jsx(Pe,{dense:!0,title:t.jsx(yt,{}),actions:t.jsx(k,{style:{alignItems:"center"},children:t.jsx(ue,{size:"small",onClick:()=>s==null?void 0:s({filtersOpen:!1}),children:t.jsx(_t,{fontSize:"small"})})})}),t.jsx(bt,{Filters:Ts})]})})}const Ps="rgba(0,0,0,0)",Ms=vt(e=>({root:s=>({backgroundColor:s.open?e.palette.action.hover:Ps})})),Rs=H.forwardRef(function(s,r){const{parentMenuOpen:n,label:a,rightIcon:i=t.jsx(It,{}),children:c,className:p,tabIndex:h,MenuProps:j={},ContainerProps:u={},...f}=s,{ref:o,...d}=u,T=m.useRef(null);m.useImperativeHandle(r,()=>T.current);const C=m.useRef(null);m.useImperativeHandle(o,()=>C.current);const b=m.useRef(null),[_,l]=m.useState(!1),x=F=>{l(!0),d!=null&&d.onMouseEnter&&d.onMouseEnter(F)},P=F=>{l(!1),d!=null&&d.onMouseLeave&&d.onMouseLeave(F)},V=()=>{var z,K;const F=(K=(z=C.current)==null?void 0:z.ownerDocument)==null?void 0:K.activeElement,Z=b.current?Array.from(b.current.children):[];for(const Q of Z)if(Q===F)return!0;return!1},A=F=>{F.target===C.current&&l(!0),d!=null&&d.onFocus&&d.onFocus(F)},g=F=>{var z,K,Q,W;if(F.key==="Escape")return;V()&&F.stopPropagation();const Z=(K=(z=C.current)==null?void 0:z.ownerDocument)==null?void 0:K.activeElement;if(F.key==="ArrowLeft"&&V()&&((Q=C.current)==null||Q.focus()),F.key==="ArrowRight"&&F.target===C.current&&F.target===Z){const ee=(W=b.current)==null?void 0:W.children[0];ee==null||ee.focus()}},X=_&&n,J=Ms({open:X});let $;return s.disabled||($=h!==void 0?h:-1),t.jsxs("div",{...d,ref:C,onFocus:A,tabIndex:$,onMouseEnter:x,onMouseLeave:P,onKeyDown:g,children:[t.jsxs(St,{...f,className:kt(J.root,p),ref:T,onClick:()=>l(!0),children:[a,i]}),t.jsx(Tt,{anchorEl:T.current,anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"left"},open:X,autoFocus:!1,disableAutoFocus:!0,disableEnforceFocus:!0,onClose:()=>{l(!1)},...j,children:t.jsx("div",{ref:b,style:{pointerEvents:"auto"},children:c})})]})}),Ns=()=>{const[e,s]=m.useState(""),[{expenseType:r,groupByValue:n,periodValue:a,filters:i,groupByTagKey:c},{setGroupByValue:p,setGroupByTagKey:h}]=v(),j=m.useRef(null),[u,f]=m.useState(!1),o=m.useCallback(l=>{f(!1),p(l)},[p]),{data:d,loading:T}=Ft({field:Ue.ResourceTagGb,filters:i,period:a,phrase:e,limit:100},{skip:!u}),C=m.useMemo(()=>(d==null?void 0:d.map(({_id:l})=>l))||[],[d]),b=Dt(r),_=m.useCallback(l=>{o(R.TagValue),h(l)},[o,h]);return t.jsxs(t.Fragment,{children:[t.jsxs(Me,{ref:j,open:u,onClick:()=>f(!0),children:[t.jsxs(y,{color:"inherit",noWrap:!0,children:["Group by"," ",t.jsx(y,{component:"span",color:"primary",className:"value",noWrap:!0,children:n===R.TagValue?r==="kubernetes"?`Label (${c})`:`Tag (${c})`:b==null?void 0:b[n]})]}),t.jsx(Re,{fontSize:"small"})]}),t.jsxs(Ne,{open:u,anchorEl:j==null?void 0:j.current,anchorOrigin:{vertical:"bottom",horizontal:"left"},onClose:()=>f(!1),PaperProps:{style:{maxHeight:500}},children:[E.map(b,(l,x)=>t.jsx(G,{value:x,selected:n===x,onClick:()=>o(x),children:t.jsx(ne,{primary:l})},x)),t.jsxs(Rs,{selected:n===R.TagValue,label:t.jsx(ne,{primary:r==="cloud"?"Tag":"Label"}),parentMenuOpen:u,MenuProps:{anchorOrigin:{vertical:"top",horizontal:"right"},PaperProps:{style:{maxHeight:400,width:300}}},children:[t.jsx(Ls,{children:t.jsx(Le,{value:e,placeholder:r==="cloud"?"Search tag":"Search label",variant:"outlined",fullWidth:!0,InputProps:{startAdornment:t.jsx(Oe,{position:"start",children:t.jsx(Ae,{})}),...T&&{endAdornment:t.jsx(Ee,{size:20})}},onChange:l=>s(l.target.value),onKeyDown:l=>{l.key!=="Escape"&&l.stopPropagation()}})}),!T&&(C==null?void 0:C.length)===0&&t.jsx(G,{disabled:!0,children:t.jsx(ne,{primary:r==="cloud"?"No tags found":"No labels found"})}),C.map((l,x)=>t.jsx(G,{onClick:()=>_(l),selected:l===c,children:t.jsx(ne,{primary:l})},x))]})]})]})},Ls=D.div.withConfig({displayName:"CostGroupBySelector__SearchWrapper",componentId:"sc-175hn8f-0"})(({theme:e})=>({background:e.palette.background.paper,position:"sticky",top:0,zIndex:100,padding:e.spacing(1)}));function Os(){const[{customRange:e,trendRange:s},{setPeriodValue:r,setCustomRange:n,setTrendRange:a}]=v(),[i,c]=m.useState(e),[p,h]=m.useState(s),j=m.useCallback(d=>{r(d),c(null),h(null),n(null),a(null)},[n,r,a]),u=m.useCallback(()=>{r("custom"),n(i),a(p)},[i,p,n,r,a]);return[{localCustomRange:i,localTrendRange:p},{setLocalCustomRange:c,setLocalTrendRange:h,handleChange:j,handleCustomApply:u}]}const ie=H.createContext(null);function As({children:e}){const[s,r]=Os();return t.jsx(ie.Provider,{value:[s,r],children:e})}function Es(){const[{localCustomRange:e,localTrendRange:s},{setLocalCustomRange:r,setLocalTrendRange:n}]=H.useContext(ie);return t.jsx(Ve,{variant:"inline",from:e==null?void 0:e.from_timestamp,to:e==null?void 0:e.to_timestamp,...s&&{highlightRange:{from:s.from_timestamp,to:s.to_timestamp}},onChange:({from:a,to:i})=>{r({from_timestamp:a,to_timestamp:i}),s&&n($e(a,i))},disableTime:!0})}function $e(e,s){const r=I(s).diff(e,"days")+1;return{from_timestamp:I(e).subtract(r,"days").format(),to_timestamp:I(s).subtract(r,"days").format()}}function Vs(){const[{localCustomRange:e,localTrendRange:s},{setLocalTrendRange:r}]=H.useContext(ie);return t.jsx(Ve,{variant:"inline",from:s==null?void 0:s.from_timestamp,to:s==null?void 0:s.to_timestamp,...e&&{highlightRange:{from:e.from_timestamp,to:e.to_timestamp}},placeholder:!(e!=null&&e.from_timestamp)||!(e!=null&&e.to_timestamp)?"Select date range":"Select trend range",onChange:({from:n,to:a})=>r({from_timestamp:n,to_timestamp:a}),...e&&{strictDuration:I.utc(e.to_timestamp).diff(e.from_timestamp,"days")},disabled:!s||!(e!=null&&e.from_timestamp)||!(e!=null&&e.to_timestamp),maxDate:(e==null?void 0:e.from_timestamp)&&I.utc(e==null?void 0:e.from_timestamp).subtract(1,"day").toDate(),disableTime:!0})}function zs(){return t.jsxs(L,{gap:2,children:[t.jsxs(Ks,{gap:2,children:[t.jsxs(L,{gap:1,children:[t.jsx(y,{variant:"caption",children:"Select date range"}),t.jsx(Es,{})]}),t.jsxs(L,{gap:1,children:[t.jsx($s,{}),t.jsx(Vs,{})]})]}),t.jsxs(k,{children:[t.jsx("div",{style:{flexGrow:1}}),t.jsx(ws,{})]})]})}function ws(){const[{localCustomRange:e},{handleCustomApply:s}]=H.useContext(ie);return t.jsx(ae,{size:"small",color:"primary",onClick:()=>s(),disabled:!(e!=null&&e.from_timestamp)||!(e!=null&&e.to_timestamp),children:"Apply"})}function $s(){const[{localCustomRange:e,localTrendRange:s},{setLocalTrendRange:r}]=H.useContext(ie);return t.jsxs(k,{gap:1,children:[t.jsx(Pt,{size:"small",checked:!!s,disabled:!(e!=null&&e.from_timestamp)||!(e!=null&&e.to_timestamp),onChange:()=>{s?r(null):e&&r($e(e.from_timestamp,e.to_timestamp))}}),t.jsx(y,{variant:"caption",children:"Calculate trend with previous period"})]})}const Ks=D(L).withConfig({displayName:"CustomPicker__CustomWrapper",componentId:"sc-6o5sha-0"})(({theme:e})=>({padding:e.spacing(1),width:300})),Ws=()=>{const[{periodValue:e,customRange:s},{setPeriodValue:r,setCustomRange:n,setTrendRange:a,setChartPeriod:i}]=v(),c=m.useRef(null),[p,h]=m.useState(!1),[j,u]=m.useState(e==="custom"),f=m.useCallback(o=>{o==="custom"?u(!0):(h(!1),r(o),n(null),a(null),u(!1),i(o==="current_month"||o==="last_month"?"day":"month"))},[i,n,r,a]);return t.jsxs(t.Fragment,{children:[t.jsxs(Me,{ref:c,open:p,onClick:()=>h(!0),children:[t.jsx(y,{color:"inherit",noWrap:!0,children:t.jsx(y,{component:"span",color:"primary",className:"value",noWrap:!0,children:e==="custom"?s?Fe(s.from_timestamp,s.to_timestamp):"Custom":fe[e]})}),t.jsx(Re,{fontSize:"small"})]}),t.jsx(Ne,{open:p,anchorEl:c==null?void 0:c.current,anchorOrigin:{vertical:"bottom",horizontal:"left"},onClose:()=>{h(!1),u(e==="custom")},children:t.jsxs(k,{gap:1,children:[t.jsx(L,{grow:!0,children:E.map(fe,(o,d)=>t.jsx(G,{value:d,selected:!j&&e===d,onClick:()=>f(d),children:t.jsx(ne,{primary:o})},d))}),j&&t.jsxs(t.Fragment,{children:[t.jsx(ge,{orientation:"vertical",flexItem:!0}),t.jsx(As,{children:t.jsx(zs,{})})]})]})})]})};function Gs(){const[{settings:e,filterValues:s},{updateSettings:r}]=v(),n=m.useMemo(()=>s?Object.keys(s).filter(a=>s[a]).length:0,[s]);return t.jsxs(ae,{size:"small",variant:"text",startIcon:t.jsx(Mt,{fontSize:"small"}),onClick:()=>r==null?void 0:r({filtersOpen:!(e!=null&&e.filtersOpen)}),selected:n>0,active:!!(e!=null&&e.filtersOpen),children:["Filter by (",n,")"]})}function Hs(){const[{chartPeriod:e},{setChartPeriod:s}]=v();return t.jsx(oe,{title:"Daily or monthly view of the chart",children:t.jsxs(Bs,{children:[t.jsx(ae,{size:"small",color:e===R.Day?"primary":"default",variant:e===R.Day?"contained":"text",onClick:()=>{s(R.Day)},children:"Daily"}),t.jsx(ae,{size:"small",color:e===R.Month?"primary":"default",variant:e===R.Month?"contained":"text",onClick:()=>{s(R.Month)},children:"Monthly"})]})})}const Bs=D.div.withConfig({displayName:"ChartPeriodButton__ButtonGroup",componentId:"sc-ht2wsd-0"})(({theme:e})=>({display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",border:`solid 1px ${e.palette.dividerLight}`,borderRadius:e.shape.borderRadius,padding:e.spacing(.5),"& > *":{marginRight:e.spacing(.5),"&:last-child":{marginRight:0}}}));function Qs(e){const{workspaceId:s}=Xe();return Je(s,qs(e))}function qs(e){return`${Rt.path}${e.filters?`?${Ze({[Ut]:e.filters})}`:""}`}function Ys(){const e=m.useMemo(()=>({filters:{category:[et.Cost]}}),[]),s=Us(e);return t.jsx(oe,{title:`${s} Cost Violations in Architectural Standards`,children:t.jsxs(Xs,{size:"small",variant:"outlined",startIcon:t.jsx(Nt,{fontSize:"small"}),component:Lt,to:Qs(e),children:["Cost Optimization Opportunities",s>0&&t.jsxs(y,{variant:"caption",color:"textSecondary",children:["Â (",s,")"]})]})})}function Us({filters:e}){const[s]=Ot(e);return At(s,e,!0).length}const Xs=D(ae).withConfig({displayName:"CostRulesLinkButton__LightBorderButton",componentId:"sc-m36gyy-0"})(({theme:e})=>({padding:e.spacing(1,1),border:`solid 1px ${e.palette.dividerLight}`,borderRadius:e.shape.borderRadius,"&:hover":{border:`solid 1px ${e.palette.divider}`}}));function Js(){const[{expenseType:e},{setExpenseType:s}]=v();return t.jsxs(Zs,{children:[t.jsx(Et,{color:"action"}),t.jsx(y,{variant:"h5",children:"Cost Governance"}),t.jsxs(Vt,{value:e,onChange:(r,n)=>s(n),children:[t.jsx(_e,{value:"cloud",label:"Cloud"}),t.jsx(_e,{value:"kubernetes",label:t.jsx(zt,{})})]})]})}const Zs=D(Pe).withConfig({displayName:"CostHeader__Container",componentId:"sc-1wfak66-0"})(({theme:e})=>({display:"flex",alignItems:"center",background:e.palette.background.paper,padding:e.spacing(0,2)}));function er(){const{data:e,loading:s}=sr();return t.jsxs(tr,{children:[t.jsx(be,{label:"Total Cluster Cost",total_cost:e==null?void 0:e.total_cluster_cost,trend_percentage:e==null?void 0:e.trend_percentage_cluster_cost,loading:s}),t.jsx(be,{label:"Cluster Idle Cost",total_cost:e==null?void 0:e.total_cluster_idle_cost,trend_percentage:e==null?void 0:e.trend_percentage_cluster_idle_cost,loading:s})]})}function be({label:e,total_cost:s,trend_percentage:r,loading:n}){return t.jsxs(k,{gap:1,children:[t.jsx(Ie,{size:"large",trend:r,loading:n}),t.jsxs(L,{gap:1,children:[t.jsxs(k,{gap:1,style:{alignItems:"center"},children:[t.jsx(U,{value:s,variant:"h6"}),r&&t.jsxs(y,{variant:"caption",color:"textSecondary",children:[Number(r).toLocaleString(void 0,{maximumFractionDigits:1}),"%"]})]}),t.jsx(y,{color:"textSecondary",children:e})]})]})}const tr=D.div.withConfig({displayName:"CostKubernetesTotal__Container",componentId:"sc-1y8f4ja-0"})(({theme:e})=>({display:"flex",gap:e.spacing(2),alignItems:"center"}));function sr(){const[{periodValue:e,trendRange:s,filters:r}]=v(),{data:n,...a}=ve(rr,{variables:{filters:{to_timestamp:r.to_timestamp,from_timestamp:r.from_timestamp,cluster:r.cluster},trend_period:Te(e),trend_range:s}});return{data:n==null?void 0:n.cost_k8s_clusters,...a}}const rr=Se(`
  query CostKubernetesClustersQuery(
    $filters: CostK8sClusterFilters
    $trend_period: CostTrendPeriod
    $trend_range: TrendRange) {
      cost_k8s_clusters(filters: $filters, trend_period: $trend_period, trend_range: $trend_range) {
        total_cluster_cost
        total_cluster_idle_cost
        trend_percentage_cluster_cost
        trend_percentage_cluster_idle_cost
    }
  }
`),nr=()=>{const[{kubernetesCluster:e},{setKubernetesCluster:s}]=v(),[r,n]=m.useState(""),[a,{loading:i}]=Ke(r),[c,{loading:p}]=wt(e);return t.jsxs(ar,{margin:"none",variant:"outlined",value:e||"",onChange:h=>s(h.target.value||null),MenuProps:{autoFocus:!1,style:{maxHeight:400}},displayEmpty:!0,disabled:i||!(a!=null&&a.length),onClose:()=>n(""),renderValue:()=>p?t.jsx(y,{color:"textSecondary",children:"Loading"}):c?t.jsx($t,{icon:t.jsx(Kt,{type:"eks",size:"small"}),label:t.jsx(y,{variant:"subtitle1",style:{maxWidth:300},noWrap:!0,children:(c==null?void 0:c.display_name)||(c==null?void 0:c.id)})}):i?t.jsx(y,{color:"textSecondary",children:"Loading"}):(a==null?void 0:a.length)===0?t.jsx(y,{color:"textSecondary",children:"No clusters found"}):t.jsx(y,{color:"textSecondary",children:"All Clusters"}),input:t.jsx(Wt,{margin:"dense",disableUnderline:!0}),children:[t.jsx(or,{children:t.jsx(Le,{autoFocus:!0,placeholder:"Search Cluster Name",variant:"outlined",size:"small",fullWidth:!0,InputProps:{startAdornment:t.jsx(Oe,{position:"start",children:t.jsx(Ae,{})})},onChange:h=>n(h.target.value),onKeyDown:h=>{h.key!=="Escape"&&h.stopPropagation()}})}),i?t.jsxs(G,{value:e,disabled:!0,children:[t.jsx(Ee,{size:15}),t.jsx(y,{children:"Loading..."})]}):(a==null?void 0:a.length)===0?t.jsx(G,{disabled:!0,children:t.jsx(y,{color:"textSecondary",children:"No clusters found"})}):a==null?void 0:a.map(h=>t.jsx(G,{value:h.id,children:t.jsx(y,{children:h.display_name||h.id})},h.id))]})},ar=D(Gt).withConfig({displayName:"CostKubernetesClusterSelector__Select",componentId:"sc-4cb7yy-0"})(({theme:e})=>({borderRadius:e.shape.borderRadius,overflow:"hidden","&:hover, &.Mui-focused":{background:e.palette.action.hover}})),or=D.div.withConfig({displayName:"CostKubernetesClusterSelector__SearchWrapper",componentId:"sc-4cb7yy-1"})(({theme:e})=>({background:e.palette.background.paper,position:"sticky",top:0,zIndex:100,padding:e.spacing(1)}));function Ke(e,s){return Xt({...s,limit:100,phrase:e,filters:{active:!0,resource_type:["eks"]}})}function Cr(){const[{expenseType:e,kubernetesCluster:s},{setKubernetesCluster:r}]=v(),[n,a]=H.useState(!1),[i]=Ke("",{skipQuery:e!=="kubernetes"});return m.useEffect(()=>{!s&&Number(i==null?void 0:i.length)>0&&r(i==null?void 0:i[0].id)},[i,s,r]),t.jsx(Ht,{children:t.jsx(ds,{children:t.jsxs(ur,{children:[t.jsx(Js,{}),t.jsxs(k,{className:"main",grow:!0,children:[t.jsx(Ds,{}),t.jsxs(L,{grow:[0,1],children:[t.jsx(lr,{expenseType:e}),t.jsx(cr,{stickyChart:n,setStickyChart:a}),(e!=="kubernetes"||s)&&t.jsx(ir,{stickyChart:n})]})]})]})})})}function ir({stickyChart:e}){return t.jsx(Bt,{paperSkeleton:!0,renderList:({header:s,list:r})=>t.jsxs(t.Fragment,{children:[t.jsx(ms,{style:{...e&&{position:"sticky",top:0,zIndex:999}},children:t.jsx(xe,{children:t.jsx(de,{children:t.jsx(Zt,{})})})}),t.jsxs(de,{p:2,children:[s,r]})]})})}function lr({expenseType:e}){return t.jsx(xe,{children:t.jsx(de,{children:t.jsxs(k,{gap:1,grow:[1,0],style:{alignItems:"flex-start"},children:[t.jsxs(k,{gap:1,style:{alignItems:"center",flexWrap:"wrap"},children:[t.jsx(Qt,{}),e==="kubernetes"&&t.jsx(nr,{}),t.jsx(Ws,{}),t.jsx(Ns,{}),t.jsx(Gs,{})]}),e==="cloud"&&t.jsx(Ys,{})]})})})}function cr({stickyChart:e,setStickyChart:s}){const[{settings:r,expenseType:n}]=v();return t.jsx(xe,{children:t.jsx(de,{children:t.jsxs(k,{gap:1,grow:[1,0],style:{alignItems:"center"},children:[t.jsx(cs,{}),t.jsxs(k,{gap:2,style:{alignItems:"center"},children:[n==="kubernetes"&&t.jsx(er,{}),t.jsxs(k,{gap:1,style:{alignItems:"center"},children:[t.jsx(Hs,{}),t.jsx(ge,{variant:"middle",orientation:"vertical",flexItem:!0}),t.jsx(oe,{title:"Pin chart to top of page",children:t.jsx(ue,{disabled:!(r!=null&&r.chartOpen),active:!(r!=null&&r.chartOpen)&&e,onClick:()=>s(!e),children:t.jsx(qt,{color:!e||!(r!=null&&r.chartOpen)?"action":"primary"})})}),t.jsx(hs,{})]})]})]})})})}const xe=D.div.withConfig({displayName:"CostModule__Toolbar",componentId:"sc-zgivfa-0"})(({theme:e})=>({background:e.palette.background.paper,padding:e.spacing(2),borderBottom:`solid 1px ${e.palette.dividerLight}`})),de=D.div.withConfig({displayName:"CostModule__InnerContainer",componentId:"sc-zgivfa-1"})(({theme:e,p:s})=>({maxWidth:1300,margin:"0 auto",transition:"all 250ms ease-out",position:"relative",...s&&{padding:e.spacing(s)}})),ur=D.div.withConfig({displayName:"CostModule__Container",componentId:"sc-zgivfa-2"})(({theme:e})=>({display:"flex",flexDirection:"column",height:"100%","& .main":{flexGrow:1,overflow:"auto"},"& .filters":{background:tt(e.palette.background.paper,.25)}}));export{Cr as default};
