import{j as e,x as Fe,v as rt,r as b,Y as st,D as _,p as v,Z as S,R as pe,$ as xe,a0 as I,a1 as it,q as Ae,a2 as A,a3 as j,a4 as Le,a as Y,f as k,a5 as ce,o as ot,g as at,a6 as H,a7 as We,V as ct,l as he,d as je,h as ye,S as Ne,i as M,a8 as lt,c as ut,a9 as ee}from"./index-Z48k0RZH.js";import{N as $e,O as B,bU as Ee,bV as dt,bW as pt,bX as Ve,bY as me,M as g,bZ as C,b_ as xt,B as f,b$ as ht,c0 as jt,a2 as P,bE as yt,c1 as mt,K as a,c2 as gt,d as l,C as ft,c3 as bt,c4 as _t,n as q,c5 as vt,g as N,c6 as ge,bD as It,c7 as wt,q as Pe,s as ze,c8 as Dt,c9 as Me,ca as Ct,cb as kt,w as Rt,cc as Be,as as Tt,cd as fe,aR as St,at as Ot,ce as Ft,T as w,cf as L,cg as z,ch as At,ci as Lt,F as te,cj as ne,ck as re,cl as se,a3 as qe,cm as $,a as Wt,A as Ge,cn as Nt,co as le,cp as He,cq as $t,cr as Et,I as J,cs as Vt,ct as K,cu as Pt,R as zt,bo as Mt,ai as ie,cv as Bt,cw as qt,cx as Gt,cy as Ht,cz as Ie,cA as Kt,cB as Ut,cC as we,cD as Qt,cE as Yt,cF as Ke,cG as Zt,cH as Jt,cI as Xt,cJ as en,z as Ue,i as Qe,bg as Ye,u as Ze,by as tn,b6 as nn,ad as R,cK as rn,cL as De,cM as sn,cN as on,cO as an,af as cn,cP as ln,ag as un,cQ as dn,cR as pn,bO as xn,cS as hn,cT as Ce,cU as jn,cV as yn,cW as mn}from"./App-XcBPpDfQ.js";import{D as gn,u as fn}from"./DetectionsSeveritySummary-jNQRxHA1.js";import{F as bn,a as _n}from"./webhook-mark-vX_eWgKB.js";function vn(){return e.jsxs($e,{...In(),children:[e.jsx(B,{value:"detections",label:"Detections"}),e.jsx(B,{value:"investigator",label:"Investigator"}),e.jsx(B,{value:"detection_rules",label:"Rules"})]})}function In(){const t=Fe(),r=rt();return{value:t.split("/").pop(),onChange:b.useCallback((n,s)=>{r.push(`/${s}`)},[r])}}function wn(){const[t,r]=Ee(),n=b.useRef(null),s=dt({onComplete(){r([])}}),{onSubmit:i}=pt({ids:t,type:st.Detection,resourceIds:t});return e.jsx(Ve,{trigger:e.jsx(f,{ref:n,disabled:t.length===0,variant:"outlined",size:"small",startIcon:e.jsx(ht,{fontSize:"small"}),children:"Actions"}),menu:({handleMenuClose:c,...o})=>e.jsxs(me,{...o,anchorOrigin:{vertical:"bottom",horizontal:"left"},children:[e.jsx(g,{onClick:()=>{c(),s({acknowledge:!0,detections_ids:t,reason:""})},children:e.jsx(C,{primary:"Acknowledge"})}),e.jsx(g,{onClick:()=>{c(),s({acknowledge:!1,detections_ids:t})},children:e.jsx(C,{primary:"Revoke Acknowledge"})}),e.jsx(xt,{onSubmit:i,resourceIds:t,summary:`[Stream Security] - ${t.length>1?"Multiple":""} threat detections`,inMenu:!0,variant:"text"})]})})}function Dn(){const[t,r]=jt(),[n]=P();return e.jsx(f,{size:"small",variant:"outlined",active:t,selected:Object.keys(n||{}).length>1,startIcon:e.jsx(yt,{}),onClick:()=>r(!t),children:"Filters"})}function Cn(){const[t]=P(),{totalCount:r,error:n,loading:s}=mt({variables:{filters:t}}),[i,c]=Ee();return n?e.jsxs(a,{row:!0,center:!0,gap:!0,children:[e.jsx(gt,{color:"error"}),e.jsx(l,{color:"error",children:"Error"})]}):s?e.jsxs(a,{row:!0,center:!0,gap:!0,children:[e.jsx(ft,{size:15}),e.jsx(l,{color:"textSecondary",children:"Loading..."})]}):r?e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"subtitle1",noWrap:!0,children:`Showing ${r} Detections`}),i.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(l,{noWrap:!0,variant:"subtitle1",color:"primary",children:`${i.length} selected`}),e.jsx(f,{variant:"text",size:"small",onClick:()=>c([]),children:"Clear"})]})]}):e.jsx(l,{color:"textSecondary",noWrap:!0,children:"No Detections Found"})}function kn(){return e.jsx(bt,{children:e.jsxs(a,{row:!0,fullHeight:!0,children:[e.jsx(_t,{}),e.jsxs(a,{paper:!0,grow:!0,column:!0,children:[e.jsxs(a,{header:!0,children:[e.jsx(Cn,{}),e.jsx(q,{orientation:"vertical",flexItem:!0}),e.jsx(gn,{}),e.jsx(a,{grow:!0}),e.jsx(Rn,{}),e.jsx(Dn,{}),e.jsx(q,{orientation:"vertical",flexItem:!0}),e.jsx(Tn,{}),e.jsx(q,{orientation:"vertical",flexItem:!0}),e.jsx(wn,{})]}),e.jsx(Sn,{MainView:On,GroupByView:Fn})]})]})})}function Rn(){const[t,r]=P(),n=typeof(t==null?void 0:t.acknowledged)<"u"&&(t==null?void 0:t.acknowledged)!==!1;return e.jsxs(a,{row:!0,center:!0,gap:!0,children:[e.jsx(vt,{size:"small",checked:n,onChange:s}),e.jsx(N,{children:e.jsx(l,{noWrap:!0,children:"Show Acknowledged"})})]});function s(){r({...t,acknowledged:!n})}}function Tn(){const[t,r]=ge();return e.jsx(Ve,{trigger:e.jsxs(f,{variant:"outlined",size:"small",selected:!!t,startIcon:e.jsx(wt,{color:"action"}),endIcon:e.jsx(It,{color:"action",fontSize:"small"}),children:["Group By",t&&e.jsxs(e.Fragment,{children:[":","Â ",e.jsx(l,{color:"primary",children:ue(t)})]})]}),menu:({handleMenuClose:n,...s})=>e.jsxs(me,{...s,PaperProps:{style:{maxHeight:400}},anchorOrigin:{vertical:"bottom",horizontal:"left"},children:[e.jsx(g,{disabled:!t,onClick:()=>{r(null),n()},children:e.jsx(C,{secondary:"None"})}),Object.values(_).map(i=>e.jsx(g,{disabled:t===i,onClick:()=>{r(i),n()},children:e.jsx(C,{primary:ue(i)})},i))]})})}function ue(t){switch(t){case _.AccountId:return"Cloud Account";case _.ActivityType:return"Detection Type";case _.AnomalySeverity:return"Detection Severity";case _.Region:return"Region";case _.ResourceId:return"Resource";case _.ResourceType:return"Resource Type"}}function Sn({MainView:t,GroupByView:r}){return ge()[0]?e.jsx(r,{}):e.jsx(t,{})}function On(){const[t]=P();return e.jsx(Me,{filters:t})}function Fn(){const[t]=ge(),[r]=P(),{results:n,error:s,loading:i}=fn({variables:{group_by:t,filters:r}});return e.jsx(a,{scroll:!0,margin:2,children:s?e.jsx(Pe,{children:e.jsx(ze,{error:s})}):i?e.jsx(Dt,{}):n==null?void 0:n.map((c,o)=>e.jsx(An,{group:c,groupBy:t},o))})}function An({group:t,groupBy:r}){const[n,s]=b.useState(!1),[i]=P(),c=b.useMemo(()=>({...i,[r]:t.group?r===_.AnomalySeverity?Number(t.group):String(t.group):null}),[t,r,i]),o=n?Ct:kt;return e.jsxs(e.Fragment,{children:[e.jsxs(a,{row:!0,center:!0,bg:!0,mb:!0,sticky:!0,gap:2,round:!0,pad:!0,hover:!0,onClick:()=>s(!n),style:{height:40},children:[e.jsx(o,{color:"action",fontSize:"small"}),e.jsx(N,{children:e.jsx(l,{component:"div",style:{width:"100%",maxWidth:200},noWrap:!0,children:e.jsx(Ln,{group:t,groupBy:r})})}),e.jsx(q,{light:!0,orientation:"vertical",flexItem:!0}),e.jsxs(l,{noWrap:!0,children:[e.jsx("b",{children:t.quantity})," ",e.jsx(l,{color:"textSecondary",component:"span",children:"detections"})]})]}),e.jsx(Rt,{in:n,children:e.jsx(a,{mb:!0,children:e.jsx(Me,{filters:c,skipQuery:!n,totalCount:t.quantity??void 0})})})]})}function Ln({group:t,groupBy:r}){const{group:n,resource_type:s}=t;if(!n)return e.jsx(l,{color:"textSecondary",children:`No ${ue(r)}`});switch(r){case _.AccountId:return e.jsx(Ot,{id:n});case _.AnomalySeverity:return e.jsxs(a,{row:!0,center:!0,gap:!0,children:[e.jsx(fe,{severity:n}),e.jsx(l,{children:St(n)})]});case _.ResourceId:return e.jsx(Tt,{id:n,resourceType:s||void 0});case _.ResourceType:return e.jsx(Be,{resource_type:n});case _.ActivityType:return e.jsx(l,{children:v(n)});default:return e.jsx(l,{children:n})}}const E={[I.Audit]:Et,[I.Identity]:$t.filter(t=>t.key!=="dst_resource_type"&&t.key!=="dst_geo_iso"),[I.Network]:He.filter(t=>t.key!=="cross_communications"&&t.key!=="intermediate_resource_id")},Wn={[I.Identity]:{dst_tags:ae,src_ip:Q,account_id:U,principal_id:T(we),principal_type:W(Yt),src_resource_type:W(Pt()),region:oe,identity:T(Qt),src_resource_id:T(we),src_geo_iso:Te},[I.Network]:{src_tags:ae,dst_tags:ae,src_ip_filter:Re,dst_ip_filter:Re,src_port_range:ke,dst_port_range:ke,tcp_flags:Nn,src_vpc_id:T(["vpc"]),src_resource_id:T(K("src")),src_resource_type:W(K("src")),src_region:oe,src_account_id:U,dst_vpc_id:T(["vpc"]),dst_account_id:U,dst_region:oe,dst_resource_id:T(K("dst")),dst_resource_type:W(K("dst"))},[I.Audit]:{auth:Q,response_code_range:Q,account_id:U,principal_id:T(["iam_user","service_account"]),principal_ip:Q,principal_type:W(Ut),principal_ip_type:W(Vt()),resource_type:W(Ie),cluster_name:Se(Kt),namespace:Se(["namespace"]),resource:T(Ie),principal_location:Te}};function ke(t){return e.jsx(D,{inputProps:{type:"number"},matchTypes:[j.Is,j.IsNot],...t})}function Re(t){return e.jsx(D,{...t,matchTypes:[j.Is,j.IsNot],validation:({value:r})=>r&&!r.match(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)?"Invalid IP address":null})}function Te(t){return e.jsx(D,{...t,validation:({value:r})=>r&&!r.match(/[A-Z]{2}/)?"Invalid ISO code":null})}function Nn(t){const r=He.find(n=>n.key==="tcp_flags");return r?e.jsx(D,{...t,matchTypes:[j.Is,j.IsNot],options:r.options,renderOption:r.renderOption,getOptionLabel:r.renderOption}):e.jsx(D,{...t})}function oe(t){return e.jsx(D,{...t,options:Object.keys(ie),renderOption:r=>{var n;return e.jsx(l,{children:((n=ie[r])==null?void 0:n.name)||r})},getOptionLabel:r=>{var n;return((n=ie[r])==null?void 0:n.name)||r}})}function W(t){return r=>e.jsx(D,{...r,options:t,renderOption:n=>e.jsx(Be,{resource_type:n}),getOptionLabel:n=>at(n),InputProps:{startAdornment:r.value.value&&e.jsx(zt,{type:r.value.value,size:"small"})}})}function U(t){const[r]=Mt(),n=qe(r,"cloud_account_id");return e.jsx(D,{...t,matchTypes:[j.Is,j.IsNot],getOptions:b.useCallback(async s=>{var i,c;return((c=(i=r==null?void 0:r.filter(o=>{var d,p;return!s||((d=o.display_name)==null?void 0:d.includes(s))||((p=o.cloud_account_id)==null?void 0:p.includes(s))}))==null?void 0:i.map(o=>o.cloud_account_id))==null?void 0:c.filter(o=>o!=null))||[]},[r]),renderOption:s=>{var i;return((i=n[s])==null?void 0:i.display_name)||s},getOptionLabel:s=>{var i;return((i=n[s])==null?void 0:i.display_name)||s}})}function T(t){return r=>e.jsx(Je,{...r,resourceTypes:t})}function Se(t){return r=>e.jsx(Je,{...r,resourceTypes:t,valueField:"display_name"})}function Je({resourceTypes:t,valueField:r="id",...n}){const s=We();return e.jsx(D,{...n,freeSolo:n.value.match_type===j.Contains||n.value.match_type===j.NotContains||n.value.match_type===j.Regex,getOptions:b.useCallback(async i=>{var o;const{data:c}=await s.query({query:k(`
              query DetectionRuleResourceSearch($phrase: String, $resourceTypes: [String!]) {
                search(phrase: $phrase, skip:0, limit: 100, filters: { active: true, resource_type: $resourceTypes }) {
                  results {
                    id
                    display_name
                  }
                }
              }
            `),variables:{phrase:i,resourceTypes:t}});return(((o=c.search)==null?void 0:o.results)||[]).map(d=>d[r]).filter(d=>typeof d=="string")},[s,t,r]),renderOption:i=>r==="id"?e.jsx($n,{resourceId:i,children:e.jsx(l,{noWrap:!0,children:i})}):e.jsx(N,{children:e.jsx(l,{noWrap:!0,children:i})})})}function $n({resourceId:t,...r}){const[n]=Gt(t);return e.jsx(Ht,{resource:n||void 0,...r})}function Q(t){return e.jsx(D,{...t,matchTypes:[j.Is,j.IsNot]})}for(const t in E)E[t]=he.keyBy(E[t],"key");function Xe({form:t}){const[r,n]=b.useState("condition");return e.jsxs(a,{row:!0,fullHeight:!0,children:[e.jsxs(a,{column:!0,grow:!0,style:{maxWidth:350},children:[e.jsxs(a,{header:!0,children:[e.jsx(Ft,{color:"action",fontSize:"small"}),e.jsx(l,{children:"Details"})]}),e.jsx(a,{scroll:!0,pad:2,children:e.jsxs(a,{column:!0,gap:3,pad:!0,children:[e.jsx(w,{...t.register("name",{required:!0}),label:"Name*",fullWidth:!0,variant:"outlined",InputLabelProps:{shrink:!0},placeholder:"Enter a name for the rule..."}),e.jsx(w,{...t.register("severity",{required:!0}),value:t.watch("severity")||"",required:!0,label:"Severity*",variant:"outlined",fullWidth:!0,select:!0,children:Object.values(S).sort((s,i)=>G(i)-G(s)).map(s=>e.jsx(g,{value:s,children:e.jsxs(a,{row:!0,center:!0,gap:!0,children:[e.jsx(fe,{severity:G(s)}),e.jsx(l,{children:v(s)})]})},s))}),e.jsx(w,{...t.register("description"),label:"Description",variant:"outlined",InputLabelProps:{shrink:!0},placeholder:"Describe the rule...",minRows:3,maxRows:5,multiline:!0,fullWidth:!0}),e.jsx(L,{control:t.control,name:"labels",render:({field:s})=>e.jsx(z,{...s,value:s.value||[],onChange:(i,c)=>s.onChange(c),multiple:!0,options:[],freeSolo:!0,autoSelect:!0,renderInput:i=>e.jsx(w,{...i,label:"Labels",variant:"outlined",InputLabelProps:{shrink:!0},placeholder:"Add labels..."})})}),e.jsx(L,{control:t.control,name:"notification_channels",render:({field:s})=>e.jsx(En,{value:s.value||[],onChange:s.onChange})})]})})]}),e.jsx(q,{orientation:"vertical",flexItem:!0,light:!0}),e.jsxs(a,{column:!0,grow:!0,children:[e.jsx(a,{row:!0,border:"bottom",paper:!0,children:e.jsxs($e,{value:r,onChange:(s,i)=>n(i),children:[e.jsx(B,{value:"condition",icon:e.jsx(At,{color:"action"}),label:e.jsx(l,{children:"Rule Conditions"})}),e.jsx(B,{value:"exclude",icon:e.jsx(Lt,{color:"action"}),label:e.jsx(l,{children:"Exclude Conditions"})})]})}),e.jsx(a,{grow:!0,scroll:!0,children:r==="condition"?e.jsxs(a,{column:!0,pad:2,children:[e.jsx(a,{pad:2,children:e.jsxs(a,{column:!0,children:[e.jsxs(a,{row:!0,gap:3,center:!0,children:[e.jsx(l,{color:"textSecondary",children:"Rule Type:"}),e.jsx(L,{name:"type",control:t.control,rules:{required:!0},render:({field:s})=>e.jsx(te,{component:"fieldset",children:e.jsx(ne,{...s,"aria-label":"options",style:{flexDirection:"row"},name:"options",onChange:i=>{t.setValue("condition",null),t.setValue("custom_config",i.target.value==="custom"?{log_type:I.Audit}:null),t.setValue("identityml_config",null),s.onChange(i)},children:Object.values(xe).map(i=>e.jsx(re,{value:i,control:e.jsx(se,{color:"primary"}),label:v(i)},i))})})})]}),t.watch("type")==="custom"&&e.jsxs(a,{row:!0,gap:3,center:!0,children:[e.jsx(l,{color:"textSecondary",children:"Custom Log Type:"}),e.jsx(L,{name:"custom_config.log_type",control:t.control,rules:{required:!0},render:({field:s})=>e.jsx(te,{component:"fieldset",children:e.jsx(ne,{...s,"aria-label":"options",style:{flexDirection:"row"},name:"options",onChange:i=>{t.setValue("condition.main_filter",null),s.onChange(i)},children:Object.values(I).map(i=>e.jsx(re,{value:i,control:e.jsx(se,{color:"primary"}),label:v(i)},i))})})})]})]})}),t.watch("type")==="custom"&&t.watch("custom_config.log_type")&&e.jsx(L,{name:"condition.main_filter",control:t.control,rules:{required:!0},render:({field:s})=>e.jsx(de,{logType:t.watch("custom_config.log_type"),...s})}),t.watch("type")==="identityml"&&e.jsx(L,{name:"identityml_config",control:t.control,rules:{required:!0},render:({field:s})=>e.jsx(zn,{...s})})]}):e.jsx(a,{column:!0,pad:2,children:e.jsx(L,{name:"condition.exclude",control:t.control,render:({field:s})=>e.jsx(de,{logType:t.watch("type")==="identityml"?I.Identity:t.watch("custom_config.log_type"),...s,filteredFields:t.watch("type")==="identityml"?["action"]:[]})})})}),r==="condition"&&t.watch("type")==="custom"&&t.watch("custom_config.log_type")===I.Network&&e.jsxs(a,{footer:!0,row:!0,gap:3,pad:2,center:!0,children:[e.jsx(l,{color:"textSecondary",children:"Apply On:"}),e.jsx(L,{name:"custom_config.detection_field",control:t.control,rules:{required:!0},render:({field:s})=>e.jsx(te,{component:"fieldset",children:e.jsx(ne,{...s,"aria-label":"options",style:{flexDirection:"row"},name:"options",children:Object.values(it).map(i=>e.jsx(re,{value:i,control:e.jsx(se,{color:"primary"}),label:v(i)},i))})})})]})]})]})}const En=pe.forwardRef((t,r)=>{var o;const{channels:n}=Pn(),s=qe(n,"value.id"),i=((o=t.value)==null?void 0:o.map(d=>d.id))||[],c=d=>{t.onChange(d.map(p=>s[p].value))};return e.jsx(w,{select:!0,ref:r,InputLabelProps:{shrink:!0},SelectProps:{displayEmpty:!0,multiple:!0,renderValue:d=>e.jsxs(l,{children:[d.length," selected"]})},label:"Notification Channels",variant:"outlined",fullWidth:!0,value:i,onChange:d=>c(d.target.value),children:n.map(d=>e.jsxs(g,{value:d.value.id,children:[e.jsx($,{children:e.jsx(Vn,{type:d.value.type})}),e.jsx(C,{primary:d.label})]},d.value.id))})});function Vn({type:t}){const r=t===ce.Slack?bn:_n;return e.jsx(r,{width:15,height:15})}function Pn(){var o,d;const{data:t,loading:r}=Y(k("query WebhookChannels { webhooks { _id app_name app_description } }")),{data:n,loading:s}=Y(k("query SlackChannels { slacks { _id incoming_webhook { channel } } }")),i=(o=t==null?void 0:t.webhooks)==null?void 0:o.map(p=>({value:{id:p._id,type:ce.Webhook},label:`${p.app_name} - ${p.app_description}`})),c=(d=n==null?void 0:n.slacks)==null?void 0:d.map(p=>{var m;return{value:{id:p._id,type:ce.Slack},label:((m=p.incoming_webhook)==null?void 0:m.channel)||"Unnamed channel"}});return{channels:b.useMemo(()=>[...i||[],...c||[]],[c,i]),loading:r||s}}const Oe=Le.Is,zn=pe.forwardRef((t,r)=>{const{value:n,onChange:s}=t;return e.jsx(Z,{ref:r,children:e.jsxs(Z,{children:[e.jsx(w,{defaultValue:Oe,value:n==null?void 0:n.match_type,size:"small",select:!0,onChange:i=>s({...n,match_type:i.target.value}),children:Object.values(Le).map(i=>e.jsx(g,{value:i,children:v(i)},i))}),e.jsx(w,{value:(n==null?void 0:n.action)||"",size:"small",placeholder:"Action",style:{width:200},onChange:i=>s({match_type:(n==null?void 0:n.match_type)||Oe,action:i.target.value})})]})})}),de=pe.forwardRef((t,r)=>{var O,u,y;let{value:n,parentValue:s,logType:i,filteredFields:c}=t;const o=x=>{var h;((h=x==null?void 0:x.filters)==null?void 0:h.length)===0&&(x={filters:[],operand:A.And}),t.onChange(x)};if(!n||n!=null&&n.operand)return e.jsx(Z,{ref:r,children:e.jsxs(a,{row:!0,gap:!0,grow:!0,children:[Number((O=n==null?void 0:n.filters)==null?void 0:O.length)>1&&e.jsx(a,{pad:!0,children:e.jsx(f,{size:"small",style:{width:60},onClick:()=>o({...n,operand:(n==null?void 0:n.operand)===A.And?A.Or:A.And}),children:(u=n==null?void 0:n.operand)==null?void 0:u.toUpperCase()})}),e.jsxs(a,{column:!0,gap:!0,grow:!0,children:[(y=n==null?void 0:n.filters)==null?void 0:y.map((x,h)=>e.jsx(de,{logType:i,parentValue:n,value:x,onChange:F=>{var ve;return o({...n,filters:F?Wt(n==null?void 0:n.filters,{[h]:{$set:F}}):((ve=n==null?void 0:n.filters)==null?void 0:ve.filter((hr,nt)=>h!==nt))||[]})},filteredFields:c},h)),e.jsxs(a,{row:!0,gap:!0,children:[e.jsx(f,{size:"small",variant:"text",startIcon:e.jsx(Ge,{}),onClick:()=>d(),children:"Add Field"}),e.jsx(f,{size:"small",variant:"text",startIcon:e.jsx(Nt,{}),onClick:()=>p(),children:"Add Group"}),s&&e.jsx(f,{size:"small",variant:"text",startIcon:e.jsx(le,{}),onClick:()=>m(),children:"Delete Group"})]})]})]})});return n=n||{},e.jsxs(Z,{ref:r,children:[e.jsx(z,{value:n.field,options:Kn(i).filter(x=>!(c!=null&&c.includes(x))),onChange:(x,h)=>o({...n,field:h,tag:null,value:""}),getOptionLabel:x=>{var h,F;return((F=(h=E[i??""])==null?void 0:h[x])==null?void 0:F.displayName)||x},renderOption:x=>{var h,F;return e.jsx(l,{children:((F=(h=E[i??""])==null?void 0:h[x])==null?void 0:F.displayName)||x})},renderInput:x=>e.jsx(V,{...x}),fullWidth:!0,style:{maxWidth:200}}),e.jsx(Mn,{value:n,onChange:o,logType:i}),e.jsx("div",{children:e.jsx(J,{onClick:()=>m(),children:e.jsx(le,{fontSize:"small",color:"action"})})})]});function d(){o({...n,operand:(n==null?void 0:n.operand)||A.And,filters:[...(n==null?void 0:n.filters)||[],{field:"",match_type:j.Is,value:""}]})}function p(){o({...n,operand:(n==null?void 0:n.operand)||A.And,filters:[...(n==null?void 0:n.filters)||[],{operand:A.And,filters:[{field:"",match_type:j.Is,value:""}]}]})}function m(){o({filters:[],operand:A.And})}});function Mn({value:t,onChange:r,logType:n}){var i;const s=(i=Wn[n])==null?void 0:i[t.field];return s?e.jsx(s,{value:t,onChange:r}):e.jsx(D,{value:t,onChange:r})}function D(t){const{value:r,onChange:n,getOptions:s,renderOption:i,getOptionLabel:c,freeSolo:o,matchTypes:d=Object.values(j).filter(p=>p!==j.Gte&&p!==j.Lte)}=t;return e.jsxs(e.Fragment,{children:[e.jsx(w,{value:r.match_type,onChange:p=>n({...r,match_type:p.target.value}),size:"small",select:!0,style:{minWidth:100},children:d.map(p=>e.jsx(g,{value:p,children:v(p)},p))}),e.jsxs(a,{column:!0,grow:!0,style:{minWidth:150},children:[s?e.jsx(qn,{getOptions:s,renderOption:i,getOptionLabel:c,value:r.value,onChange:(p,m)=>n({...r,value:m}),freeSolo:o}):t.options?e.jsx(z,{value:r.value,options:t.options,onChange:(p,m)=>n({...r,value:m}),renderOption:i,getOptionLabel:c,renderInput:p=>e.jsx(V,{...p,InputProps:{...p.InputProps,...t.InputProps}}),fullWidth:!0}):e.jsx(V,{inputProps:t.inputProps,value:r.value,onChange:p=>n({...r,value:p.target.value})}),e.jsx(Bn,{fn:t.validation,value:r})]})]})}function V(t){return e.jsx(w,{...t,placeholder:t.placeholder||"Value",size:"small",fullWidth:!0})}function Bn({fn:t,value:r}){if(!t)return null;const n=t(r);return n?e.jsx(l,{color:"error",children:n}):null}function qn(t){const{value:r,onChange:n,getOptions:s,renderOption:i,getOptionLabel:c}=t,[o,d,p]=ct("",1e3),[m,O]=b.useState(!1),[u,y]=b.useState([]);return b.useEffect(()=>{x();async function x(){O(!0),s&&y(await s(o)),O(!1)}},[s,o]),e.jsx(z,{options:u,value:r,loading:m,onChange:n,inputValue:p,onInputChange:(x,h)=>d(h),renderOption:i,getOptionLabel:c,freeSolo:t.freeSolo,autoSelect:t.freeSolo,renderInput:x=>e.jsx(V,{...x}),fullWidth:!0})}function ae({value:t,onChange:r}){const{tag:n}=t||{};return e.jsxs(e.Fragment,{children:[e.jsx(Gn,{value:(n==null?void 0:n.key)||"",onChange:s=>r({...t,tag:{...n,key:s,match_type:(n==null?void 0:n.match_type)||H.Is}})}),(n==null?void 0:n.key)&&e.jsxs(e.Fragment,{children:[e.jsx(w,{value:n==null?void 0:n.match_type,defaultValue:H.Is,onChange:s=>r({...t,tag:{...n,match_type:s.target.value}}),size:"small",select:!0,style:{minWidth:100},children:Object.values(H).map(s=>e.jsx(g,{value:s,children:v(s)},s))}),e.jsx(Hn,{tag:n,freeSolo:(n==null?void 0:n.match_type)===H.Contains,value:(n==null?void 0:n.value)||"",onChange:s=>r({...t,tag:{...n,value:s||""}})})]})]})}function Gn({value:t,onChange:r}){const[n,s]=b.useState(""),{data:i,search:c}=Bt({});return e.jsx(z,{value:t||"",inputValue:n,onInputChange:(o,d)=>{s(d),c(d)},onChange:(o,d)=>r(d),options:i,renderOption:o=>e.jsx(l,{noWrap:!0,children:o}),renderInput:o=>e.jsx(V,{...o,placeholder:"Key"}),fullWidth:!0,style:{maxWidth:250}})}function Hn({value:t,onChange:r,tag:n,freeSolo:s}){const{data:i}=qt({key:n==null?void 0:n.key});return e.jsx(z,{value:t||"",onChange:(c,o)=>r(o),options:i,freeSolo:s,renderOption:c=>e.jsx(l,{noWrap:!0,children:c}),renderInput:c=>e.jsx(V,{...c}),autoSelect:s,fullWidth:!0})}const Z=Ae(a).withConfig({displayName:"DetectionRuleForm__Card",componentId:"sc-oc12q1-0"})(({theme:t})=>({background:ot(t.palette.background.default,.4),display:"flex",flexDirection:"row",gap:t.spacing(2),border:`solid 1px ${t.palette.dividerLight}`,borderRadius:t.shape.borderRadius,padding:t.spacing(2),maxWidth:1e3}));function G(t){return{[S.Critical]:4,[S.High]:3,[S.Medium]:2,[S.Low]:1}[t]}function Kn(t){return Object.keys(E[t??""]||{})}function be({onCompleted:t}={}){const r=We(),n=je(),s=Ke();return b.useCallback(async(i,c)=>{switch(i){case"enable":if(await Un(s))try{await Zn(r,c),n("Detection rule enabled","success")}catch(o){n(o.message||"Failed to enable detection rule","error")}break;case"disable":if(await Qn(s))try{await Jn(r,c),n("Detection rule disabled","success")}catch(o){n(o.message||"Failed to disable detection rule","error")}break;case"edit":s.open(o=>e.jsx(tt,{rule:c,...o}),{size:"xl"});break;case"delete":if(await Yn(s))try{await Xn(r,c),n("Detection rule deleted","success")}catch(o){n(o.message||"Failed to delete detection rule","error")}break;case"copy":s.open(o=>e.jsx(et,{template:X(c),...o}),{size:"xl"});break}t==null||t()},[r,s,n,t])}function Un(t){return t.confirm({title:"Enable Detection Rule",text:"Are you sure you want to enable this detection rule?",confirmText:"Enable",declineText:"Cancel",actionsLayout:"row",inputText:{disabled:!0}})}function Qn(t){return t.confirm({title:"Disable Detection Rule",text:"Are you sure you want to disable this detection rule?",confirmText:"Disable",declineText:"Cancel",actionsLayout:"row",confirmRed:!0,inputText:{disabled:!0}})}function Yn(t){return t.confirm({title:"Delete Detection Rule",text:"Are you sure you want to delete this detection rule?",confirmText:"Delete",declineText:"Cancel",actionsLayout:"row",confirmRed:!0,inputText:{disabled:!0}})}function Zn(t,r){return t.mutate({mutation:k(`
          mutation EnableDetectionRule($id: ID, $input: DetectionRuleInput) {
              editDetectionRule(id: $id, input: $input)
          }
      `),variables:{id:r._id,input:{...X(r),enabled:!0}},update(n){n.evict({fieldName:"detection_rules"})}})}function Jn(t,r){return t.mutate({mutation:k(`
          mutation DisableDetectionRule($id: ID, $input: DetectionRuleInput) {
              editDetectionRule(id: $id, input: $input)
          }
      `),variables:{id:r._id,input:{...X(r),enabled:!1}},update(n){n.evict({fieldName:"detection_rules"})}})}function Xn(t,r){return t.mutate({mutation:k(`
              mutation DeleteDetectionRule($id: ID) {
                  deleteDetectionRule(id: $id) 
              }
          `),variables:{id:r._id},update(n){n.evict({fieldName:"detection_rules"})}})}function X(t){return he.omit(t,"_id","created_by","created_at","modified_at")}function er({rule:t,...r}){const n=be({onCompleted:()=>{var s;return(s=r.onClose)==null?void 0:s.call(r,{},"escapeKeyDown")}});return e.jsxs(me,{...r,children:[t!=null&&t.enabled?e.jsxs(g,{onClick:s=>n("disable",t),children:[e.jsx($,{children:e.jsx(Zt,{})}),e.jsx(C,{primary:"Disable"})]}):e.jsxs(g,{onClick:s=>n("enable",t),children:[e.jsx($,{children:e.jsx(Jt,{})}),e.jsx(C,{primary:"Enable"})]}),e.jsxs(g,{onClick:s=>n("edit",t),children:[e.jsx($,{children:e.jsx(Xt,{})}),e.jsx(C,{primary:"Edit"})]}),e.jsxs(g,{onClick:s=>n("copy",t),children:[e.jsx($,{children:e.jsx(en,{})}),e.jsx(C,{primary:"Copy as template"})]}),e.jsxs(g,{onClick:s=>n("delete",t),children:[e.jsx($,{children:e.jsx(le,{})}),e.jsx(C,{primary:"Delete"})]})]})}function _e(t){return Y(tr,t)}const tr=k(`
  query DetectionRules {
    detection_rules {
      _id
      name
      created_at
      modified_at
      created_by
      description
      severity
      type
      enabled
      labels
      condition {
        main_filter {
          operand
          filters {
            field
            match_type
            value
            operand
            tag {
              key
              match_type
              value
            }
            filters {
              field
              match_type
              value
            }
          }
        }
        exclude {
          operand
          filters {
            field
            match_type
            value
            operand
            tag {
              key
              match_type
              value
            }
            filters {
              field
              match_type
              value
            }
          }
        }
      }
      notification_channels {
        id
        type
      }
      custom_config {
        log_type
        detection_field
      }
      identityml_config {
        match_type
        action
      }
    }
  }
`);function nr(){const{path:t}=ye();return e.jsxs(Ne,{children:[e.jsx(M,{path:`${t}/:rule_id`,component:rr}),e.jsx(M,{path:t,exact:!0,component:sr})]})}function rr(){var c;const{rule_id:t}=ye().params,{data:r,loading:n,error:s}=_e(),i=(c=r==null?void 0:r.detection_rules)==null?void 0:c.find(o=>(o==null?void 0:o._id)===t);return e.jsx(a,{fullHeight:!0,paper:!0,loading:n,error:s,children:e.jsx(tt,{rule:i})})}function sr(){return e.jsx(a,{fullHeight:!0,row:!0,children:e.jsxs(a,{column:!0,grow:!0,children:[e.jsxs(a,{header:!0,paper:!0,sticky:!0,children:[e.jsx(ir,{}),e.jsx(a,{grow:!0}),e.jsx(pr,{}),e.jsx(dr,{})]}),e.jsx(a,{scroll:!0,grow:!0,children:e.jsx(or,{})})]})})}function ir(){var r;const{data:t}=_e();return e.jsxs(l,{variant:"subtitle1",children:[(r=t==null?void 0:t.detection_rules)==null?void 0:r.length," Detection Rules Found"]})}function or(){var m,O;const t=be(),[r]=Ze("search",""),n=nn("detection_rules_table_columns",[]),{data:s,loading:i,error:c}=_e(),[o,d]=b.useState({sort_by:"created_at",sort_order:-1});if(!i&&c)return e.jsx(Pe,{children:e.jsx(ze,{error:c})});if(!i&&((m=s==null?void 0:s.detection_rules)==null?void 0:m.length)===0)return e.jsx(e.Fragment,{});const p=he.sortBy((O=s==null?void 0:s.detection_rules)==null?void 0:O.filter(u=>!r||u.name.toLocaleLowerCase().includes(r.toLocaleLowerCase())||u.severity.toLocaleLowerCase().includes(r.toLocaleLowerCase())),u=>{var y,x,h;return(o==null?void 0:o.sort_by)==="name"?u.name.toLowerCase():(o==null?void 0:o.sort_by)==="created_by"?(y=u.created_by)==null?void 0:y.toLowerCase():(o==null?void 0:o.sort_by)==="type"?(x=u.type)==null?void 0:x.toLowerCase():(o==null?void 0:o.sort_by)==="labels"?(h=u.labels)==null?void 0:h.join(",").toLowerCase():(o==null?void 0:o.sort_by)==="enabled"?u.enabled:(o==null?void 0:o.sort_by)==="severity"?{[S.Critical]:4,[S.High]:3,[S.Medium]:2,[S.Low]:1}[u.severity]:u.created_at});return(o==null?void 0:o.sort_order)===-1&&p.reverse(),e.jsxs(ur,{stickyHeader:!0,data:p,sortOptions:o,onSortChange:d,loading:i,columnOptions:{storage:n},menu:(u,{menuProps:y})=>e.jsx(er,{rule:u,...y}),onClick:u=>t("edit",u),children:[e.jsx(R,{style:{maxWidth:5},render:u=>e.jsx(rn,{severity:G(u.severity)})}),e.jsx(R,{sortKey:"name",header:"Name",grow:2,render:u=>e.jsxs(a,{column:!0,children:[e.jsx(N,{children:e.jsx(l,{noWrap:!0,children:u.name})}),e.jsx(N,{children:e.jsx(l,{color:"textSecondary",noWrap:!0,children:u.description})})]})}),e.jsx(R,{sortKey:"severity",header:"Severity",render:u=>e.jsxs(a,{row:!0,center:!0,gap:!0,children:[e.jsx(fe,{severity:G(u.severity)}),e.jsx(l,{children:v(u.severity)})]})}),e.jsx(R,{sortKey:"created_by",header:"Owner",grow:2,render:u=>e.jsx(ar,{rule:u})}),e.jsx(R,{sortKey:"created_at",header:"Created",grow:2,render:u=>e.jsx(De,{color:"textSecondary",value:u.created_at})}),e.jsx(R,{sortKey:"modified_at",header:"Modified",grow:2,render:u=>e.jsx(De,{color:"textSecondary",value:u.modified_at})}),e.jsx(R,{sortKey:"type",header:"Type",render:u=>{var y;return e.jsx(N,{children:e.jsx(l,{noWrap:!0,children:u.type===xe.Custom?v((y=u.custom_config)==null?void 0:y.log_type):v(u.type)})})}}),e.jsx(R,{sortKey:"labels",header:"Labels",grow:2,render:u=>{var y;return e.jsxs(a,{row:!0,gap:!0,center:!0,children:[e.jsx(sn,{color:"action",fontSize:"small"}),e.jsx(on,{width:300,children:(y=u.labels)==null?void 0:y.filter(Boolean).map(x=>e.jsx(a,{round:!0,border:!0,bg:!0,pad:!0,style:{minWidth:30,maxWidth:80},children:e.jsx(N,{children:e.jsx(l,{color:"textSecondary",noWrap:!0,children:x})})},x))})]})}}),e.jsx(R,{sortKey:"enabled",header:"Status",render:u=>e.jsx(lr,{rule:u}),style:{minWidth:120}})]})}function ar({rule:t}){var n,s;const{data:r}=cr({variables:{id:t.created_by}});return e.jsxs(a,{row:!0,gap:!0,center:!0,children:[e.jsx(dn,{children:e.jsx(l,{children:pn((n=r==null?void 0:r.userDetails)==null?void 0:n.full_name)||"--"})}),e.jsx(l,{color:"textSecondary",children:(s=r==null?void 0:r.userDetails)==null?void 0:s.full_name})]})}function cr(t){return Y(k(`
        query User($id: ID!) {
            userDetails(id: $id) {
                full_name
            }
        }
    `),t)}function lr({rule:t}){const r=be();return e.jsxs(a,{row:!0,center:!0,gap:!0,onClick:n=>{n.stopPropagation(),t.enabled?r("disable",t):r("enable",t)},children:[e.jsx(xn,{size:"small",checked:t.enabled}),e.jsx(l,{color:"textSecondary",children:t.enabled?"Enabled":"Disabled"})]})}const ur=Ae(cn).withConfig({displayName:"page__StyledTable",componentId:"sc-1v5oij1-0"})(({theme:t})=>({padding:t.spacing(2),[un]:{background:t.palette.background.paper,marginBottom:t.spacing(1)},[ln]:{borderRadius:0,background:t.palette.background.default}}));function dr(){const t=Ke();return e.jsx(f,{variant:"text",size:"small",startIcon:e.jsx(Ge,{fontSize:"small"}),onClick:()=>t.open(et,{size:"xl"}),children:"New Rule"})}function et({template:t,onClose:r}){const n=je(),s=Ue({defaultValues:{labels:[],notification_channels:[],type:xe.Custom,custom_config:{log_type:I.Audit},...t}}),[i,{loading:c}]=Qe(k(`
        mutation CreateDetectionRule($input: DetectionRuleInput!) {
            createDetectionRule(input: $input)
        }    
    `),{onCompleted(){n("Detection rule created","success"),r()},onError(o){n(o.message||"Failed to create detection rule","error")},update(o){o.evict({fieldName:"detection_rules"})}});return e.jsxs(a,{column:!0,fullHeight:!0,children:[e.jsxs(a,{header:!0,children:[e.jsx(l,{variant:"h6",children:"Create Detection Rule"}),e.jsx(a,{grow:!0}),e.jsx(J,{onClick:r,children:e.jsx(Ye,{})})]}),e.jsx(a,{grow:!0,children:e.jsx(Xe,{form:s})}),e.jsxs(a,{footer:!0,children:[e.jsx(a,{grow:!0}),e.jsx(f,{variant:"text",onClick:r,children:"Cancel"}),e.jsx(f,{color:"primary",disabled:c||!s.formState.isValid,onClick:()=>{i({variables:{input:s.getValues()}})},children:"Create"})]})]})}function tt({rule:t,onClose:r}){const n=je(),s=Ue({defaultValues:X(t)}),[i,{loading:c}]=Qe(k(`
          mutation EditDetectionRule($id: ID, $input: DetectionRuleInput!) {
              editDetectionRule(id: $id, input: $input)
          }    
      `),{onCompleted(){n("Detection rule edited","success"),r==null||r()},onError(o){n(o.message||"Failed to edit detection rule","error")},update(o){o.evict({fieldName:"detection_rules"})}});return e.jsxs(a,{column:!0,fullHeight:!0,children:[e.jsxs(a,{header:!0,children:[!r&&e.jsx(xr,{}),e.jsx(l,{variant:"h6",children:"Edit Detection Rule"}),e.jsx(a,{grow:!0}),r&&e.jsx(J,{onClick:r,children:e.jsx(Ye,{})})]}),e.jsx(a,{grow:!0,children:e.jsx(Xe,{form:s})}),e.jsxs(a,{footer:!0,children:[e.jsx(a,{grow:!0}),r&&e.jsx(f,{variant:"text",onClick:r,children:"Cancel"}),e.jsx(f,{color:"primary",disabled:c||!s.formState.isValid,onClick:()=>{t&&i({variables:{id:t._id,input:s.getValues()}})},children:"Save"})]})]})}function pr(){const[t,r]=Ze("search",""),n=lt(r,500);return e.jsx(w,{variant:"outlined",size:"small",defaultValue:t,style:{width:260},placeholder:"Search by rule name or severity",onChange:s=>n(s.target.value),InputProps:{endAdornment:e.jsx(tn,{color:"action",fontSize:"small"})}})}function xr(){const{url:t}=ye(),r=ut();return e.jsx(J,{onClick:()=>r.push(t.split("/").slice(0,-1).join("/")),children:e.jsx(an,{})})}function fr(){const t=Fe();return e.jsxs(a,{fullHeight:!0,column:!0,children:[e.jsxs(a,{paper:!0,header:!0,style:{paddingTop:0,paddingBottom:0},children:[e.jsx(hn,{color:"action"}),e.jsx(l,{variant:"h5",children:"Detections"}),e.jsx(vn,{}),e.jsx(a,{grow:!0}),t===Ce.path[0]&&e.jsx(f,{variant:"text",startIcon:e.jsx(jn,{}),component:"a",href:"https://docs.streamsec.io/docs/threat-detections",target:"_blank",children:e.jsx(l,{color:"textSecondary",children:"Learn about Detections"})})]}),e.jsx(a,{grow:!0,children:e.jsxs(Ne,{children:[e.jsx(M,{path:ee(Ce.path[0]),component:kn}),e.jsx(M,{path:ee(mn.path),component:yn}),e.jsx(M,{path:ee("/detection_rules"),component:nr})]})})]})}export{fr as default};
