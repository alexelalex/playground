import{aL as ge,R as te,F as Ht,j as e,am as Kn,q as f,af as Ut,l as N,r as c,aa as H,C as ae,o as de,ae as _e,aV as Ee,d as Z,w as Zn,aW as st,aX as X,a as B,a7 as ct,e as Qt,n as Jn,I as Yt,X as Xn,H as dt,a8 as es,B as ts,g as ns,m as ss,f as O,p as ye,t as je,aY as k,V as De,an as is,aZ as zt,h as ut,v as Kt,c as Zt,a_ as os,x as Jt,a$ as it,S as pt,i as le}from"./index-CDz6_-F0.js";import{L as v,b as E,d as p,fc as Xt,a5 as Ne,bO as Te,iJ as ot,cf as G,T as P,di as Ke,gx as Fe,dA as Ae,iK as as,cM as $e,iL as Se,bj as Le,fG as rs,aw as C,gP as mt,F as ls,cj as cs,ck as Ze,cl as re,ae as ne,fi as ds,eb as en,n as D,N as Oe,O as ce,ch as xt,ci as tn,i as Ce,iM as at,j as ue,z as nn,iN as ht,B as w,iO as us,cF as gt,fF as ze,h as ie,I as J,bg as pe,iP as ps,aZ as Mt,bt as ve,A as sn,ap as on,bo as an,dN as ms,aR as Me,iQ as xs,iR as hs,b$ as rn,bY as jt,M as F,cm as $,cG as ke,bZ as L,cH as gs,cI as ft,cJ as js,iS as fs,iT as yt,c2 as bt,iU as ys,iV as ln,iW as bs,C as me,c5 as cn,cX as _s,aT as dn,u as xe,g as U,dY as un,U as _t,aL as Ct,bq as Ve,e5 as Pe,bs as Be,iX as We,iY as Cs,iZ as vs,i_ as Rs,d4 as ws,ah as se,K as x,i$ as pn,ec as Ss,by as mn,b6 as vt,g3 as ks,j0 as Is,g4 as Es,fw as Ds,bp as Rt,gF as xn,fX as Ns,fY as Ts,bE as hn,bf as Fs,g8 as As,j1 as $s,q as fe,r as wt,s as St,dQ as Ls,j2 as Vt,j3 as Os,gH as zs,d8 as Ms,d7 as Vs,d5 as Pt,j4 as gn,dl as Ps,iw as Bs,dC as Ws,dD as qs,dE as Gs,dF as Hs,as as Ie,R as jn,d0 as Us,j5 as Qs,j6 as Ys,j7 as Ks,j8 as Zs,j9 as qe,ja as Js,at as fn,jb as Xs,cg as Ge,de as yn,ai as Je,cc as ei,S as bn,a3 as ti,a as ni,db as si,ca as ii,cb as oi,w as ai,jc as ri,jd as _n,hL as li,je as ci,jf as di,eT as ui,ab as Cn,ad as A,cK as pi,af as mi,cP as xi,ag as hi,jg as gi,jh as ji,a0 as fi,dS as yi,cL as bi,aY as ee,hN as _i,cd as Ci,h8 as vi}from"./App-c61S4xKC.js";import{R as vn,b as Ri,u as wi,E as Si,c as ki,d as Ii}from"./ExcludeConditions-BtQe29_n.js";import{c as Ei,g as Di,d as Ni}from"./AI-z54HM-Ow.js";import{C as Rn}from"./CreatedByAvatar-CjI4u2Dk.js";import{H as Ti}from"./Header-CRo7NnqJ.js";import{u as Fi}from"./useRuleFilterValues-4yo_Nn-S.js";import"./PortsInput-BLbSnFLr.js";import"./transform-DxSsZRCH.js";import"./color-9lF95FHy.js";import"./select-C5KTakZX.js";import"./index-ZTFIyMoE.js";const wn=[ge.Security,ge.Cost,ge.Availability,ge.Sustainability,ge.Other];function Sn({form:t}){const{control:n,formState:{errors:s}}=t,o=ot("labels"),i=ot("compliance");return e.jsxs(v,{gap:3,style:{overflow:"visible"},children:[e.jsxs(v,{gap:2,style:{overflow:"visible"},children:[e.jsx(G,{name:"name",defaultValue:"",control:n,rules:{required:!0},render:({field:a})=>e.jsx(P,{...a,error:!!s.name,helperText:s.name&&"Required",label:"Name",variant:"outlined",required:!0})}),e.jsx(G,{name:"category",defaultValue:"",control:n,rules:{required:!0},render:({field:a})=>e.jsx(P,{...a,error:!!s.category,helperText:s.category&&"Required",label:"Category",variant:"outlined",select:!0,required:!0,children:wn.map(r=>e.jsx(Ke,{value:r,children:e.jsxs(E,{style:{alignItems:"center"},gap:1,children:[e.jsx(Fe,{category:r,fontSize:"small"}),e.jsx(p,{variant:"body2",children:r})]})},r))})}),e.jsx(G,{name:"severity",defaultValue:"",control:n,rules:{required:!0},render:({field:a})=>e.jsx(kn,{error:!!s.severity,helperText:s.severity&&"Required",required:!0,...a})}),e.jsx(G,{name:"description",defaultValue:"",control:n,render:({field:a})=>e.jsx(P,{...a,value:a.value||"",label:"Description",variant:"outlined",maxRows:8,multiline:!0})}),e.jsx(G,{name:"finding_type",control:n,render:({field:a})=>e.jsxs(P,{...a,select:!0,InputLabelProps:{shrink:!!a.value},SelectProps:{displayEmpty:!0},value:a.value||"",label:"Finding Type",variant:"outlined",children:[a.value&&e.jsx(Ke,{value:null,children:"None"}),Object.values(Ut).map(r=>e.jsx(Ke,{value:r,children:e.jsx(Ae,{findingType:r})},r))]})}),e.jsx(G,{name:"remediation",defaultValue:"",control:n,render:({field:a})=>e.jsx(P,{...a,value:a.value||"",label:"Remediation",variant:"outlined",maxRows:8,multiline:!0})})]}),e.jsxs(v,{gap:1,children:[e.jsx(Xe,{Icon:as,title:"Properties"}),e.jsx(G,{name:"fail_simulation",control:n,defaultValue:!1,render:({field:{onChange:a,value:r}})=>e.jsx(In,{value:r,onChange:a})})]}),e.jsxs(v,{children:[e.jsx(Xe,{variant:"subtitle2",Icon:$e,title:"Labels"}),e.jsx(G,{name:"labels",control:n,render:({field:a})=>e.jsx(Se,{...a,options:o,placeholder:"Type here (optional)"})})]}),e.jsxs(v,{children:[e.jsx(Xe,{variant:"subtitle2",Icon:Le,title:"Compliance"}),e.jsx(G,{name:"compliance",control:n,render:({field:a})=>e.jsx(Se,{...a,options:i,placeholder:"Type here (optional)"})})]})]})}const kn=te.forwardRef(({value:t,onChange:n,helperText:s},o)=>{const i=Ht();return e.jsxs(v,{children:[e.jsxs(E,{gap:2,style:{alignItems:"center"},children:[e.jsx(p,{variant:"caption",color:"textSecondary",children:"Severity"}),e.jsx(E,{gap:1,children:Xt((a,r)=>e.jsx(Kn,{onClick:()=>n(r),value:r,style:{border:`solid 1px ${t===r?i.palette.action.selected:i.palette.dividerLight}`,borderRadius:i.shape.borderRadius,background:t===r?i.palette.action.selected:i.palette.background.default,padding:i.spacing(1)},children:e.jsxs(E,{style:{alignItems:"center"},gap:1,children:[e.jsx(Ne,{severity:r}),e.jsx(p,{variant:"body2",children:a})]})},r))})]}),s&&e.jsx(Ai,{children:s})]})}),Ai=f(p).withConfig({displayName:"RuleMetadataForm__ErrorMessage",componentId:"sc-1ypwxla-0"})(({theme:t})=>({color:t.palette.common.red,marginLeft:t.spacing(2)}));function In({value:t,onChange:n}){return e.jsxs(E,{gap:2,children:[e.jsx(Te,{checked:t,onChange:()=>n(!t),size:"small"}),e.jsx(p,{children:"Force fail violating simulation"})]})}const Xe=({Icon:t,title:n,variant:s="subtitle1",actions:o})=>e.jsxs($i,{$spacing:s==="subtitle1"?3:2,children:[e.jsx(t,{color:"action"}),e.jsx(p,{variant:s,children:n}),e.jsx("div",{style:{flexGrow:1}}),o]}),$i=f(E).withConfig({displayName:"RuleMetadataForm__SubtitleBox",componentId:"sc-1ypwxla-1"})(({theme:t,$spacing:n})=>({marginBottom:t.spacing(n),alignItems:"center"})),En=({form:t})=>{const{watch:n,control:s,formState:{errors:o},setValue:i}=t,a=n("path_intermediate_predicates"),r=n("subject"),d=N.some(a,({resource_id:l,resource_type:u})=>l===void 0&&u===void 0);return c.useEffect(()=>{d&&r===H.Intermediate&&i("subject","")},[d,r,i]),e.jsx(Oi,{className:rs({error:o.subject}),children:e.jsxs(E,{style:{alignItems:"center"},gap:1,children:[e.jsx(C,{icon:e.jsx(mt,{color:"primary",fontSize:"small"}),label:"Apply violation on :"}),e.jsx(G,{name:"subject",defaultValue:"",control:s,rules:{required:!0},render:({field:l})=>e.jsx(ls,{component:"fieldset",children:e.jsxs(cs,{...l,"aria-label":"options",style:{flexDirection:"row"},name:"options",children:[e.jsx(Ze,{value:H.Source,control:e.jsx(re,{color:"primary"}),label:ae(H.Source)}),e.jsx(ne,{placement:"top",title:d&&"Intermediate cannot be Any and marked as violated",children:e.jsx(Ze,{value:H.Intermediate,control:e.jsx(re,{color:"primary"}),disabled:d,label:ae(H.Intermediate)})}),e.jsx(Ze,{value:H.Destination,control:e.jsx(re,{color:"primary"}),label:ae(H.Destination)})]})})}),e.jsx(ne,{title:"Select the resource that will trigger a violation if the ruleâ€™s criteria are met.",children:e.jsx(Mi,{color:"action"})}),!!o.subject&&e.jsxs(E,{gap:1,style:{marginLeft:"auto",alignItems:"center"},children:[e.jsx(Li,{}),e.jsx(zi,{children:"This field is required"})]})]})})},Li=f(en).withConfig({displayName:"RuleSubjectSelection__ErrorMessageIcon",componentId:"sc-12lm3i7-0"})(["color:",";"],t=>t.theme.palette.error.main),Oi=f.div.withConfig({displayName:"RuleSubjectSelection__StyledRuleSubjectSelection",componentId:"sc-12lm3i7-1"})(["padding:","px;border-top:1px solid ",";&.error{border-top:none;background-color:",";}"],t=>t.theme.spacing(2),t=>t.theme.palette.divider,t=>de(t.theme.palette.primary.light,.2)),zi=f(p).withConfig({displayName:"RuleSubjectSelection__ErrorMessage",componentId:"sc-12lm3i7-2"})(["color:",";"],t=>t.theme.palette.error.main),Mi=f(ds).withConfig({displayName:"RuleSubjectSelection__HelpIconWrapper",componentId:"sc-12lm3i7-3"})(["margin-left:","px;cursor:pointer;"],t=>t.theme.spacing(1));function Vi({form:t}){const{watch:n}=t,[s,o]=c.useState("conditions"),i=n("rule_type");return e.jsxs(Pi,{children:[e.jsx(Hi,{children:e.jsx(Sn,{form:t})}),e.jsx(D,{orientation:"vertical",flexItem:!0}),e.jsxs(qi,{children:[e.jsxs(Bi,{children:[e.jsxs(Oe,{value:s,onChange:(a,r)=>o(r),children:[e.jsx(ce,{value:"conditions",label:"Rule Conditions",icon:e.jsx(xt,{color:"action",fontSize:"small"})}),e.jsx(ce,{value:"exclusions",label:"Exclude Conditions",icon:e.jsx(tn,{color:"action",fontSize:"small"})})]}),e.jsx(D,{light:!0}),e.jsxs(Wi,{children:[s==="conditions"&&e.jsx(vn,{form:t}),s==="exclusions"&&e.jsx(Ri,{form:t})]})]}),s==="conditions"&&_e.Path===i&&e.jsx(Gi,{children:e.jsx(En,{form:t})})]})]})}const Pi=f.div.withConfig({displayName:"RuleForm__Container",componentId:"sc-14bxo4s-0"})(({theme:t})=>({display:"flex",flexDirection:"row",gap:t.spacing(2),height:"100%"})),Bi=f.div.withConfig({displayName:"RuleForm__Content",componentId:"sc-14bxo4s-1"})({overflow:"auto",position:"relative",flexGrow:1}),Wi=f.div.withConfig({displayName:"RuleForm__ContentWrapper",componentId:"sc-14bxo4s-2"})(({theme:t})=>({padding:t.spacing(2,0)})),qi=f.div.withConfig({displayName:"RuleForm__MainColumn",componentId:"sc-14bxo4s-3"})({display:"flex",flexDirection:"column",overflow:"auto",position:"relative",height:"100%",flexGrow:1}),Gi=f.div.withConfig({displayName:"RuleForm__Footer",componentId:"sc-14bxo4s-4"})({position:"sticky",bottom:0}),Hi=f.div.withConfig({displayName:"RuleForm__LeftColumn",componentId:"sc-14bxo4s-5"})(({theme:t})=>({maxWidth:400,overflow:"auto",paddingTop:t.spacing(1),flexGrow:1}));function Ui(){return Ce(ue`
      mutation CreateRule($rule: RuleInput!) {
        createRule(rule: $rule) {
          ...RuleFields
        }
      }
      ${at}
    `,{update(t,{data:{createRule:n}}){t.modify({fields:{rules(s={}){const o=t.writeFragment({data:n,fragment:at,fragmentName:"RuleFields"});return{...s,results:[...s.results||[],o]}}}})}})}function kt(t,n={rule_type:_e.Path,state:Ee.Enabled,fail_simulation:!1}){return nn({mode:"onChange",defaultValues:N.omit(N.defaults(t,n),ht)})}function Qi(t){return e.jsx(Ei,{resolvers:Di,onResolve:n=>{n.key==="output"&&n.data&&t.form.reset(n.data)},children:e.jsx(Ni,{placeholder:"Suggest a rule that will...",trigger:e.jsx(ne,{title:"Suggest a rule using AI",children:e.jsx(w,{startIcon:e.jsx(us,{}),size:"small",variant:"text",children:"AI Suggestion"})})})})}function Yi({rule:t}){const n=gt(),s=Z(),[o,i]=c.useState(!1),a=kt(t),r=ze(),[d,{loading:l}]=Ui(),u=c.useCallback(async({isDraft:j}={})=>{const g=a.getValues();j&&(g.state=Ee.Draft),g.rule_type===_e.Resource&&delete g.subject;const h=await d({variables:{rule:N.omit(g,["exclusions"])}});r({ruleId:h.data.createRule.id,tab:"conditions"})},[d,a,r]),m=c.useCallback(async({isDraft:j}={})=>{i(j??!1),await a.trigger(),a.formState.isValid&&u({isDraft:j}).then(()=>{s("Rule updated successfully","success"),n.close()}).catch(g=>{s(g.message,"error")})},[n,a,s,u]);return e.jsxs(Ki,{children:[e.jsx(ie,{title:e.jsx(p,{variant:"subtitle1",children:"Create New Rule"}),actions:e.jsx(J,{onClick:n.close,children:e.jsx(pe,{})})}),e.jsx(eo,{children:e.jsx(Vi,{form:a})}),e.jsxs(Ji,{children:[e.jsx(ps,{children:e.jsx(Qi,{form:a})}),e.jsx("div",{style:{flexGrow:1}}),e.jsx(Zi,{variant:"outlined",onClick:n.close,children:"Discard"}),e.jsx(w,{startIcon:l&&o&&e.jsx(Mt,{}),variant:"text",onClick:()=>m({isDraft:!0}),disabled:l,children:"Save as draft"}),e.jsx(Xi,{startIcon:l&&!o&&e.jsx(Mt,{}),variant:"contained",color:"primary",onClick:()=>m(),disabled:l,children:"Publish"})]})]})}const Ki=f(v).withConfig({displayName:"RuleDialog__Container",componentId:"sc-1un052n-0"})({height:"100%"}),Zi=f(w).withConfig({displayName:"RuleDialog__DiscardButton",componentId:"sc-1un052n-1"})(({theme:t})=>({color:t.palette.common.red,borderColor:t.palette.common.red})),Ji=f(ve).withConfig({displayName:"RuleDialog__Footer",componentId:"sc-1un052n-2"})(({theme:t})=>({padding:t.spacing(2)})),Xi=Zn(t=>({root:{...t.palette.type==="dark"?{background:t.palette.primary.main,color:t.palette.primary.contrastText}:{background:t.palette.common.black,color:t.palette.primary.contrastText}}}))(w),eo=f.div.withConfig({displayName:"RuleDialog__Content",componentId:"sc-1un052n-3"})(({theme:t})=>({overflow:"auto",flexGrow:1,flexBasis:0,padding:t.spacing(2),borderBottom:`solid 1px ${t.palette.dividerLight}`}));function It(){const t=gt(),n=c.useCallback(s=>t.open(()=>e.jsx(Yi,{rule:s}),{size:"xl"}),[t]);return c.useMemo(()=>({createRule(){return n()},createRuleFromTemplate(s){return n(N.omit(s,ht))}}),[n])}function to({allRules:t,hasFilters:n,filterOnlyViolations:s,onClick:o}){const i=It();return e.jsx(so,{children:n?s?e.jsxs(v,{style:{alignItems:"center"},children:[e.jsx(p,{color:"textSecondary",children:"There are no actively violated rules"}),e.jsxs(w,{size:"small",variant:"text",onClick:o,children:["Show available rules (",t.length,")"]})]}):e.jsxs(v,{style:{alignItems:"center"},children:[e.jsx(p,{color:"textSecondary",children:"No rules matched"}),e.jsx(w,{size:"small",variant:"text",onClick:o,children:"Clear filters"})]}):e.jsx(no,{variant:"outlined",startIcon:e.jsx(sn,{color:"action"}),onClick:i.createRule,children:"New Rule"})})}const no=f(w).withConfig({displayName:"RulesEmpty__CustomButton",componentId:"sc-kiet4k-0"})(({theme:t})=>({background:t.palette.background.paper})),so=f.div.withConfig({displayName:"RulesEmpty__EmptyContainer",componentId:"sc-kiet4k-1"})(({theme:t})=>({maxHeight:400,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexGrow:1})),Dn=te.createContext();function io({allRules:t,rules:n,values:s,loadingAccountsData:o,onChange:i,isEventView:a,hideAccounts:r,...d}){return e.jsx(Dn.Provider,{value:{onChange:i,values:s},children:e.jsxs(co,{...d,children:[!a&&e.jsx(lo,{}),e.jsx(on,{filterValues:s,filters:oo({allRules:t,rules:n,isEventView:a,hideAccounts:r}),onChange:i})]})})}function oo({allRules:t,rules:n,isEventView:s,hideAccounts:o}){const i=c.useMemo(()=>N.chain(["labels","compliance","created_by"]).keyBy().mapValues(h=>N.chain(t).map(h).flatten().uniq().compact().sort().value()).value(),[t]),a=(h,y)=>{switch(y){case"account_ids":case"compliance":case"labels":return N.chain(h).map(({id:R,[y]:b})=>b==null?void 0:b.map(I=>({rule_id:R,[y]:I}))).flatten().groupBy(y).value();default:return N.groupBy(h,y)}},r=c.useMemo(()=>N.chain(["severity","category","compliance","created_by","labels","status","state","rule_type","account_ids"]).keyBy().mapValues(h=>a(n,h)).value(),[n]),d=c.useMemo(()=>N.chain(["severity","category","compliance","created_by","labels","status","state","rule_type","account_ids"]).keyBy().mapValues(h=>a(t,h)).value(),[t]),[l,{loading:u,error:m}]=an(),j=ms(),g=c.useMemo(()=>({attr:h,value:y})=>{var I,z,Q,S;const R=((z=(I=r[h])==null?void 0:I[y])==null?void 0:z.length)||0,b=((S=(Q=d[h])==null?void 0:Q[y])==null?void 0:S.length)||0;return e.jsxs(p,{color:"textSecondary",children:["(",b!==R?`${R}/${b}`:R,")"]})},[d,r]);return c.useMemo(()=>[...o?[]:[{key:"account_ids",defaultOpen:!0,displayName:"Account",loading:u,error:m,renderOption:h=>e.jsx(C,{label:j(h),action:e.jsx(g,{attr:"account_ids",value:h}),actionVisible:!0}),searchableOptions:!0,options:l==null?void 0:l.map(h=>({value:h.cloud_account_id,filterBy:h.display_name}))}],{key:"severity",displayName:"Severity",renderOption:h=>e.jsx(C,{label:Me(h),icon:e.jsx(Ne,{severity:h}),action:e.jsx(g,{attr:"severity",value:h}),actionVisible:!0}),options:Xt((h,y)=>y)},{key:"labels",displayName:"Labels",options:i.labels||[],searchableOptions:!0,renderOption:h=>e.jsx(C,{label:h,action:e.jsx(g,{attr:"labels",value:h}),actionVisible:!0})},{key:"compliance",displayName:"Compliance",options:i.compliance||[],searchableOptions:!0,renderOption:h=>e.jsx(C,{label:h,action:e.jsx(g,{attr:"compliance",value:h}),actionVisible:!0})},{key:"finding_type",displayName:"Finding Type",options:Object.values(Ut),searchableOptions:!0,renderOption:h=>e.jsx(Ae,{findingType:h})},{key:"created_by",displayName:"Creators",options:i.created_by||[],searchableOptions:!0,renderOption:h=>e.jsx(C,{label:h,action:e.jsx(g,{attr:"created_by",value:h}),actionVisible:!0})},{key:"category",defaultOpen:!0,displayName:"Category",options:wn,renderOption:h=>e.jsx(C,{label:h,icon:e.jsx(Fe,{category:h,fontSize:"small",color:"action"}),action:e.jsx(g,{attr:"category",value:h}),actionVisible:!0})},{key:"rule_type",displayName:"Rule Type",options:ao,renderOption:h=>e.jsx(C,{label:ae(h),action:e.jsx(g,{attr:"rule_type",value:h}),actionVisible:!0})},...s?[]:[{key:"status",displayName:"Status",options:ro,renderOption:h=>e.jsx(C,{label:ae(h),action:e.jsx(g,{attr:"status",value:h}),actionVisible:!0})}]].sort((h,y)=>h.displayName>y.displayName?1:-1),[l,m,u,j,o,s,i.compliance,i.created_by,i.labels])}const ao=["path","resource"],ro=["pending","processing","active","invalid"];function lo(){return e.jsxs(e.Fragment,{children:[e.jsx(C,{icon:e.jsx(et,{defaultOn:!0,attr:"only_violations"}),label:"Violated rules"}),e.jsx(C,{icon:e.jsx(et,{attr:"archived"}),label:"Archived rules"}),e.jsx(C,{icon:e.jsx(et,{attr:"fail_simulation"}),label:"Fail simulation"})]})}const co=f.div.withConfig({displayName:"RulesFilters__Container",componentId:"sc-1q1lns5-0"})(({theme:t})=>({overflow:"auto","& > *":{marginBottom:t.spacing(1)}})),et=({attr:t,defaultOn:n=!1})=>{const{onChange:s,values:o}=c.useContext(Dn),i=st(o==null?void 0:o[t],n),a=c.useCallback(()=>{s({...o,[t]:!i})},[t,s,o,i]);return e.jsx(Te,{checked:i,onChange:a,size:"small"})},Nn=["resource_predicates","path_source_predicates","path_intermediate_predicates","path_destination_predicates","exclusion_predicates"];function Et(){const[t,n]=Ce(ue`
      mutation EditRule($id: ID!, $rule: RuleInput!) {
        editRule(id: $id, rule: $rule) {
          ...RuleFields
        }
      }
      ${at}
    `);return[c.useCallback((o,i)=>(i=N.mapValues(i,(a,r)=>Nn.includes(r)?uo(a):a),t({variables:{id:o,rule:i}}).then(({data:a})=>N.omit(a==null?void 0:a.editRule,ht))),[t]),n]}function uo(t){return N.compact(t==null?void 0:t.map(n=>{var s,o;return n=N.omitBy(n,N.isNil),delete n.__typename,n.tags&&!((o=(s=n==null?void 0:n.tags)==null?void 0:s.attributes_list)!=null&&o.length)&&delete n.tags,Object.keys(n).length===0?null:n}))}function po({rule:t}){const{triggerProps:n,menuProps:s}=xs({stopPropagation:!0}),{onClose:o}=s,[i]=Et(),a=ze(),r=It(),d=hs(),l=Z(),u=c.useCallback(async(b,I)=>{b.stopPropagation(),I&&await I(),o()},[o]),m=c.useCallback(async b=>i(t.id,{state:b}).then(()=>l("Rule updated successfully","success")).catch(I=>l(I.message,"error")),[i,l,t.id]),j=c.useCallback(()=>m("disabled"),[m]),g=c.useCallback(()=>m("enabled"),[m]),h=c.useCallback(()=>m("archived"),[m]),y=c.useCallback(()=>a({ruleId:t.id,state:{editMode:!0}}),[a,t.id]),R=c.useCallback(async()=>{r.createRuleFromTemplate(await d(t.id))},[d,t.id,r]);return e.jsxs(e.Fragment,{children:[e.jsx(J,{size:"small",...n,children:e.jsx(rn,{fontSize:"small"})}),e.jsxs(jt,{...s,children:[t.state==="enabled"&&e.jsxs(F,{onClick:b=>u(b,j),children:[e.jsx($,{children:e.jsx(ke,{fontSize:"small"})}),e.jsx(L,{primary:"Disable"})]}),t.state==="disabled"&&e.jsxs(F,{onClick:b=>u(b,g),children:[e.jsx($,{children:e.jsx(gs,{fontSize:"small"})}),e.jsx(L,{primary:"Enable"})]}),t.state!=="archived"&&e.jsxs(F,{onClick:b=>u(b,y),children:[e.jsx($,{children:e.jsx(ft,{fontSize:"small"})}),e.jsx(L,{primary:"Edit details"})]}),t.state!=="draft"&&e.jsxs(F,{onClick:b=>u(b,R),children:[e.jsx($,{children:e.jsx(js,{fontSize:"small"})}),e.jsx(L,{primary:"Copy as template"})]}),t.state==="draft"&&e.jsxs(F,{onClick:b=>u(b,g),children:[e.jsx($,{children:e.jsx(fs,{fontSize:"small"})}),e.jsx(L,{primary:"Publish"})]}),t.state!=="archived"&&t.state!=="draft"&&e.jsxs(F,{onClick:b=>u(b,h),children:[e.jsx($,{children:e.jsx(yt,{fontSize:"small"})}),e.jsx(L,{primary:"Archive"})]})]})]})}function Dt({rule:t}){return t.status===X.Invalid?e.jsx(ho,{icon:e.jsx(bt,{fontSize:"small",color:"error"}),label:"Invalid",labelColor:"error"}):t.state===X.Error?e.jsx(Bt,{icon:e.jsx(ke,{fontSize:"small",color:"error"}),label:"Error",labelColor:"error"}):t.state===X.Disabled?e.jsx(Bt,{icon:e.jsx(ke,{fontSize:"small",color:"action"}),label:"Disabled"}):t.state===X.Archived?e.jsx(C,{icon:e.jsx(yt,{fontSize:"small",color:"action"}),label:"Archived"}):t.state===X.Draft?e.jsx(xo,{icon:e.jsx(ys,{fontSize:"small",color:"action"}),label:"Draft"}):t.status===X.Pending?e.jsx(C,{icon:e.jsx(ln,{fontSize:"small",color:"action"}),label:"Pending"}):t.status==="processing"?e.jsx(mo,{icon:e.jsx(bs,{fontSize:"small",color:"primary"}),label:"Processing",labelColor:"primary"}):e.jsx(C,{labelColor:"textSecondary",label:t.status===X.Inactive?"Inactive":"Active"})}const He=f(C).withConfig({displayName:"RuleStatus__Tag",componentId:"sc-185ln2d-0"})(({theme:t})=>({borderRadius:t.shape.borderRadius/2,maxWidth:"fit-content",padding:t.spacing(.5,1,.5,.5)})),mo=f(He).withConfig({displayName:"RuleStatus__ProcessingTag",componentId:"sc-185ln2d-1"})(({theme:t})=>({background:de(t.palette.primary.main,.25)})),Bt=f(He).withConfig({displayName:"RuleStatus__DisabledTag",componentId:"sc-185ln2d-2"})(({theme:t})=>({background:de(t.palette.common.gray,.25)})),xo=f(He).withConfig({displayName:"RuleStatus__DraftTag",componentId:"sc-185ln2d-3"})(({theme:t})=>({border:`solid 1px ${t.palette.divider}`})),ho=f(He).withConfig({displayName:"RuleStatus__InvalidTag",componentId:"sc-185ln2d-4"})(({theme:t})=>({background:de(t.palette.error.main,.15)}));function go(t,{filters:n,...s}={}){var r,d;const{data:o,...i}=B(ue`
      query RulesCostQuery($ids: [String!], $filters: RulesCostFilters) {
        rules_cost(rules_ids: $ids, filters: $filters) {
          rule_id
          predicted_cost
        }
      }
    `,{...s,variables:{ids:[t],filters:n}});return[(d=(r=o==null?void 0:o.rules_cost)==null?void 0:r[0])==null?void 0:d.predicted_cost,i]}function jo({rule:t,filters:n,...s}){const[o,{loading:i}]=go(t.id,{skip:t.category!=="Cost",filters:n});return e.jsx("div",{...s,children:i?e.jsx(me,{size:15}):o>0?e.jsx(p,{children:`$${Number(o).toLocaleString(void 0,{maximumFractionDigits:2})}`}):e.jsx(p,{color:"textSecondary",children:"â€”"})})}function fo({rules:t,selected:n,filtersValues:s,setSelected:o,focusRuleId:i,...a}){const r=c.useRef(null),d=ze(),l=c.useCallback(m=>{s&&s.account_ids?d({ruleId:m.id,filters:{account:s.account_ids}}):d({ruleId:m.id})},[s,d]);c.useEffect(()=>{if(i){const m=t.findIndex(j=>j.id===i);m>-1&&setTimeout(()=>{var j;return(j=r.current)==null?void 0:j.scrollToItem(m)})}},[i,t]);const u=c.useCallback(()=>{n.size>0?o(new Set):o(new Set(t.map(m=>m.id)))},[t,n.size,o]);return e.jsxs(yo,{...a,children:[e.jsxs(Ro,{children:[e.jsxs(E,{gap:1,className:"cell name-cell",style:{alignItems:"center"},children:[e.jsx(cn,{size:"small",checked:n.size>0,indeterminate:n.size>0&&n.size!==(t==null?void 0:t.length),onClick:u}),e.jsx(Tn,{style:{visibility:"hidden"}}),e.jsx(p,{children:"Name"})]}),e.jsx(p,{className:"cell category-cell",children:"Category"}),e.jsx(p,{className:"cell status-cell",children:"Status"}),e.jsx(p,{className:"cell violations-cell",children:"Violations"}),e.jsx(p,{className:"cell exclude-cell",children:"Excluded"}),e.jsx(p,{className:"cell labels-cell",children:"Labels"}),e.jsx(p,{className:"cell time-cell",children:"Created"}),e.jsx(p,{className:"cell compliance-cell",children:"Compliance"}),e.jsx(p,{className:"cell finding-type-cell",children:"Finding Type"}),e.jsx(p,{className:"cell cost-cell",children:"Predicted Saving"}),e.jsx("span",{className:"cell actions-cell"})]}),e.jsx(vo,{children:e.jsx(_s,{ref:r,data:t,itemData:{selected:n,setSelected:o},itemCount:(t==null?void 0:t.length)||0,itemSize:55,ItemComponent:bo,onItemClick:l})})]})}const yo=f.div.withConfig({displayName:"RulesList__Container",componentId:"sc-1iiyukw-0"})({display:"flex",minWidth:1300,flexDirection:"column",flexGrow:1}),bo=te.forwardRef(({item:t,itemData:{selected:n,setSelected:s}},o)=>{var l,u,m,j,g;const[i]=xe("f"),a=t==null?void 0:t.violationsCount,r=c.useCallback(h=>{h.stopPropagation();const y=new Set(n);n.has((t==null?void 0:t.id)??"")?y.delete((t==null?void 0:t.id)??""):y.add((t==null?void 0:t.id)??""),s(y)},[t,n,s]),d=c.useMemo(()=>({account:i==null?void 0:i.account_ids}),[i]);return e.jsx(_o,{ref:o,children:e.jsxs(Co,{children:[e.jsxs(E,{gap:1,className:"cell name-cell",children:[e.jsx("div",{children:e.jsx(cn,{size:"small",checked:n.has((t==null?void 0:t.id)??""),onClick:r})}),e.jsx(Tn,{severity:t==null?void 0:t.severity,violationsCount:a}),e.jsxs(v,{children:[e.jsx(U,{children:e.jsx(p,{variant:"subtitle2",noWrap:!0,children:t.name})}),e.jsx(U,{children:e.jsx(p,{color:"textSecondary",noWrap:!0,children:t.description})})]})]}),e.jsx("div",{className:"cell category-cell",children:e.jsx(C,{icon:e.jsx(Fe,{fontSize:"small",color:"action",category:t.category}),label:t.category})}),e.jsx("div",{className:"cell status-cell",children:e.jsx(Dt,{rule:t})}),e.jsx(C,{className:"cell violations-cell",style:{opacity:a>0?1:.4},icon:e.jsx(Ne,{severity:t.severity}),label:a>0?a:"â€”"}),e.jsx(C,{className:"cell exclude-cell",icon:t.exclusions_count?e.jsx(un,{color:"action",fontSize:"small"}):null,label:t.exclusions_count?t.exclusions_count:""}),e.jsx(C,{className:"cell labels-cell",style:{opacity:(l=t.labels)!=null&&l.length?1:.4},icon:(u=t.labels)!=null&&u.length?e.jsx(_t,{title:"Labels",content:e.jsx(wo,{labels:t.labels}),children:e.jsx($e,{fontSize:"small",color:"action"})}):null,label:((m=t.labels)==null?void 0:m.length)||""}),e.jsx(C,{className:"cell time-cell",icon:e.jsx(Rn,{name:t.created_by}),label:Ct(t.creation_date,"short_date")}),(j=t.compliance)!=null&&j.length?e.jsx(C,{className:"cell compliance-cell",icon:e.jsx(Le,{fontSize:"small",color:"action"}),label:(g=t.compliance)==null?void 0:g.join(", ")}):e.jsx(p,{className:"cell compliance-cell",color:"textSecondary",children:"â€”"}),e.jsx("div",{className:"cell finding-type-cell",color:"textSecondary",children:t.finding_type?e.jsx(Ae,{findingType:t.finding_type}):e.jsx(p,{color:"textSecondary",children:"â€”"})}),e.jsx(jo,{rule:t,filters:d,className:"cell cost-cell"}),e.jsx("span",{className:"cell actions-cell",children:e.jsx(po,{rule:t})})]})})}),_o=f.div.withConfig({displayName:"RulesList__RuleRowBoxWrapper",componentId:"sc-1iiyukw-1"})(({theme:t})=>({paddingBottom:t.spacing(1)})),Tn=f.div.withConfig({displayName:"RulesList__SeverityBar",componentId:"sc-1iiyukw-2"})(({theme:t,severity:n,violationsCount:s})=>({minWidth:5,height:35,borderRadius:t.shape.borderRadius,backgroundColor:s?dn(t,n)||t.palette.divider:t.palette.common.green})),Nt=f(E).withConfig({displayName:"RulesList__RowBox",componentId:"sc-1iiyukw-3"})(({theme:t})=>({alignItems:"center",padding:t.spacing(1,1,1,2),borderRadius:t.shape.borderRadius,overflow:"visible","& .cell":{flexGrow:1,flexBasis:0},"& .name-cell":{flexGrow:4,minWidth:150,maxWidth:800},"& .category-cell":{minWidth:100,maxWidth:120},"& .status-cell":{minWidth:100,maxWidth:120},"& .state-cell":{minWidth:100,maxWidth:120},"& .violations-cell, & .labels-cell, & .exclude-cell":{minWidth:50,maxWidth:70},"& .time-cell":{minWidth:80},"& .compliance-cell":{minWidth:100},"& .finding-type-cell":{display:"flex",overflow:"hidden",minWidth:100},"& .cost-cell":{minWidth:80},"& .actions-cell":{maxWidth:50,display:"flex",justifyContent:"flex-end"}}));Nt.defaultProps={gap:2};const Co=f(Nt).withConfig({displayName:"RulesList__RuleRowBox",componentId:"sc-1iiyukw-4"})(({theme:t})=>({minHeight:50,backgroundColor:t.palette.background.paper,"&:hover":{backgroundColor:t.palette.action.hover,cursor:"pointer"}})),vo=f.div.withConfig({displayName:"RulesList__Content",componentId:"sc-1iiyukw-5"})(({theme:t})=>({overflow:"hidden",flexGrow:1,flexBasis:0,padding:t.spacing(2)})),Ro=f(Nt).withConfig({displayName:"RulesList__GroupHeader",componentId:"sc-1iiyukw-6"})(({theme:t})=>({position:"sticky",background:t.palette.background.paper,borderRadius:0,margin:-t.spacing(2,1,0,1),padding:t.spacing(1,4),top:-t.spacing(1),zIndex:100,alignItems:"center","& .cell":{color:t.palette.text.secondary}})),wo=({labels:t})=>(t==null?void 0:t.length)>0?t.map((n,s)=>e.jsx(So,{children:n},s)):e.jsx(p,{variant:"caption",color:"textSecondary",children:"None"}),So=f.span.withConfig({displayName:"RulesList__LabelBox",componentId:"sc-1iiyukw-7"})(({theme:t})=>({padding:t.spacing(.5,1),background:t.palette.background.paper,color:t.palette.text.primary,margin:t.spacing(0,.5,.5,0),borderRadius:t.shape.borderRadius/2}));function ko({allRules:t,rules:n,selectedRuleIds:s,actions:o,loading:i,startAdornment:a}){return e.jsx(ie,{paper:!0,actions:o,title:e.jsxs(e.Fragment,{children:[a,i?e.jsxs(E,{gap:1,style:{alignItems:"center"},children:[e.jsx(me,{size:15}),e.jsx(p,{children:"Loading..."})]}):n&&t&&e.jsxs(e.Fragment,{children:[e.jsx(Io,{variant:"subtitle1",children:`${t.length===n.length?n.length:`${n.length}/${t.length}`} rules available`}),s.size>0&&e.jsx(p,{color:"primary",children:`${s.size} selected`})]})]})})}const Io=f(p).withConfig({displayName:"RulesListHeader__TitleTypography",componentId:"sc-107p9ec-0"})(({theme:t})=>({paddingLeft:t.spacing(1)}));function Eo({open:t,onClose:n,onEdit:s,selectedRuleIds:o}){const[i,a]=c.useState(!1),[r,d]=c.useState(!1),l=c.useCallback(()=>{s(r),d(!1)},[r,s]);return e.jsxs(Ve,{open:t,onClose:n,children:[e.jsxs(Pe,{disableTypography:!0,children:[e.jsxs(p,{variant:"subtitle1",children:["Edit force fail simulation (",o.size," rules)"]}),e.jsx("div",{style:{flexGrow:1}}),e.jsx(J,{edge:"end",onClick:n,children:e.jsx(pe,{})})]}),e.jsx(Be,{children:e.jsxs(v,{gap:2,children:[e.jsx(In,{value:r,onChange:d}),e.jsx(We,{checked:i,onChange:a})]})}),e.jsxs(ve,{children:[e.jsx(w,{variant:"text",onClick:n,children:"Cancel"}),e.jsx(w,{color:"primary",onClick:l,children:"Submit"})]})]})}function Do({open:t,onClose:n,selectedRuleIds:s,onEdit:o}){const[i,a]=c.useState(!1),[r,d]=c.useState(new Set),[l,u]=c.useState(new Set),m=c.useCallback(()=>{d(new Set),u(new Set),o({addCompliance:Array.from(r),removeCompliance:Array.from(l)})},[r,o,l]),j=To(),g=No(s),h=c.useCallback(R=>{u(b=>new Set([...N.difference(g,R),...b]))},[g]),y=c.useCallback(()=>{d(new Set),u(new Set),n(),a(!1)},[n]);return e.jsxs(Ve,{open:t,onClose:y,children:[e.jsxs(Pe,{disableTypography:!0,children:[e.jsxs(p,{variant:"subtitle1",children:["Edit compliance (",s.size," rules)"]}),e.jsx("div",{style:{flexGrow:1}}),e.jsx(J,{edge:"end",onClick:n,children:e.jsx(pe,{})})]}),e.jsx(Be,{children:e.jsxs(v,{gap:2,style:{overflow:"visible",minWidth:300},children:[e.jsxs(v,{gap:1,children:[e.jsx(p,{variant:"caption",children:"Compliance to add"}),e.jsx(Se,{value:r,options:j,onChange:d,placeholder:"Type here",useSet:!0})]}),e.jsxs(v,{gap:1,children:[e.jsxs(v,{children:[e.jsx(p,{variant:"caption",children:"Common Compliance"}),e.jsx(p,{color:"textSecondary",variant:"caption",children:"You can delete existing labels here"})]}),e.jsx(Se,{value:g,onChange:h,disabledLabels:l,placeholder:g.length===0?"No common compliance":"",removeOnly:!0})]}),e.jsx(We,{checked:i,onChange:a})]})}),e.jsxs(ve,{children:[e.jsx(w,{variant:"text",onClick:y,children:"Cancel"}),e.jsx(w,{color:"primary",onClick:m,disabled:!i||r.size===0&&l.size===0,children:"Submit"})]})]})}function No(t){return Cs(t,"compliance")}function To(){return ot("compliance")}function Fo({open:t,onClose:n,onEdit:s,selectedRuleIds:o}){const[i,a]=c.useState(!1),[r,d]=c.useState(""),l=c.useCallback(()=>{s(r),d("")},[s,r]);return e.jsxs(Ve,{open:t,onClose:n,children:[e.jsxs(Pe,{disableTypography:!0,children:[e.jsxs(p,{variant:"subtitle1",children:["Change severity (",o.size," rules)"]}),e.jsx("div",{style:{flexGrow:1}}),e.jsx(J,{edge:"end",onClick:n,children:e.jsx(pe,{})})]}),e.jsx(Be,{children:e.jsxs(v,{gap:2,children:[e.jsx(kn,{value:r,onChange:d}),e.jsx(We,{checked:i,onChange:a})]})}),e.jsxs(ve,{children:[e.jsx(w,{variant:"text",onClick:n,children:"Cancel"}),e.jsx(w,{color:"primary",disabled:!i||!r,onClick:l,children:"Change Severity"})]})]})}function Ao(){const t=ct();return c.useCallback((n,s)=>t.mutate({mutation:$o,variables:{ids:n,rule:s},update:o=>{for(const i of n)o.writeFragment({id:o.identify({id:i,__typename:"Rule"}),fragment:ue`
              fragment UpdatedRule on Rule {
                ${"state"in s?"state":""}
                ${"severity"in s?"severity":""}
                ${"fail_simulation"in s?"fail_simulation":""}
                ${"labels"in s?"labels":""}
              }
            `,data:s})}}),[t])}const $o=ue`
  mutation EditRulesBulk($ids: [ID!]!, $rule: RuleInput!) {
    editRules(ids: $ids, rule: $rule) 
  }
`;function Lo({selectedRuleIds:t,onComplete:n=null}){const s=c.useRef(),[o,i]=c.useState(!1),[a,r]=c.useState(!1),[d,l,u,m,j]=Po(c.useCallback(()=>i(!1),[])),g=Mo({selectedRuleIds:t,waitConfirm:l,onComplete:n,confirmState:{action:"disable"}}),h=Vo({selectedRuleIds:t,waitConfirm:l,onComplete:n,confirmState:{action:"archive"}}),[y,R,b]=Bo({selectedRuleIds:t,onComplete:n}),[I,z,Q]=Wo({selectedRuleIds:t,onComplete:n}),[S,M,W]=qo({selectedRuleIds:t,onComplete:n}),[oe,Qe,q]=Go({selectedRuleIds:t,onComplete:n}),T=c.useCallback(Re=>()=>{Re(),r(!1)},[]);return e.jsxs(e.Fragment,{children:[e.jsx(w,{ref:s,color:t.size===0?"default":"primary",variant:"outlined",size:"small",disabled:t.size===0,startIcon:e.jsx(rn,{fontSize:"small",color:t.size===0?"disabled":"primary"}),onClick:()=>r(!a),children:"Actions"}),e.jsxs(jt,{open:a,anchorEl:s.current,anchorOrigin:{horizontal:"left",vertical:"bottom"},onClose:()=>r(!1),PaperProps:{style:{maxHeight:300,width:200}},children:[e.jsxs(F,{onClick:T(g),children:[e.jsx($,{children:e.jsx(ke,{})}),e.jsx(L,{primary:"Disable"})]}),e.jsxs(F,{onClick:T(h),children:[e.jsx($,{children:e.jsx(yt,{})}),e.jsx(L,{primary:"Archive"})]}),e.jsxs(F,{onClick:T(y),children:[e.jsx($,{children:e.jsx(ft,{})}),e.jsx(L,{primary:"Edit severity"})]}),e.jsxs(F,{onClick:T(I),children:[e.jsx($,{children:e.jsx(vs,{})}),e.jsx(L,{primary:"Force fail simulation"})]}),e.jsxs(F,{onClick:T(S),children:[e.jsx($,{children:e.jsx($e,{})}),e.jsx(L,{primary:"Edit labels"})]}),e.jsxs(F,{onClick:T(oe),children:[e.jsx($,{children:e.jsx(Le,{})}),e.jsx(L,{primary:"Edit compliance"})]})]}),e.jsx(Fo,{selectedRuleIds:t,open:R,onClose:()=>b(!1),onEdit:y}),e.jsx(Eo,{selectedRuleIds:t,open:z,onClose:()=>Q(!1),onEdit:I}),e.jsx(Rs,{selectedRuleIds:t,open:M,onClose:()=>W(!1),onEdit:S}),e.jsx(Do,{selectedRuleIds:t,open:Qe,onClose:()=>q(!1),onEdit:oe}),e.jsxs(Ve,{open:u,onClose:()=>m(!1),children:[e.jsxs(Pe,{disableTypography:!0,children:[e.jsxs(p,{variant:"subtitle1",children:[{disable:"Disable Rules",archive:"Archive Rules"}[j==null?void 0:j.action]||"Confirm bulk action"," ","(",t.size,")"]}),e.jsx("div",{style:{flexGrow:1}}),e.jsx(J,{edge:"end",onClick:()=>m(!1),children:e.jsx(pe,{})})]}),e.jsx(Be,{children:e.jsxs(v,{gap:2,children:[e.jsx(p,{children:"Are you sure you want to perform this operation?"}),e.jsx(We,{checked:o,onChange:i})]})}),e.jsxs(ve,{children:[e.jsx(w,{variant:"text",onClick:()=>m(!1),children:"Cancel"}),e.jsx(w,{color:"primary",onClick:d,disabled:!o,children:{disable:"Disable",archive:"Archive"}[j==null?void 0:j.action]||"Yes"})]})]})]})}const Oo=(t,n)=>{const{workspaceId:s,session:o,user:i}=Qt(),[a,r]=c.useState(!1);return{downloadRules:c.useCallback(async()=>{const l="/api/standards/rules/report";try{r(!0);const u=await fetch(l,{method:"POST",headers:{customer:s,authorization:`Bearer ${o==null?void 0:o.access_token}`,"content-type":"application/json"},body:JSON.stringify({export_by:i.email,filters:{rule_ids:t,account_ids:n}})});if(!u.ok)throw new Error(await u.text());const m=await u.blob(),j=window.URL.createObjectURL(m),g=document.createElement("a"),y="stream_rules_report-"+Jn().format("DD_MM_YYYY-HH:mm:ss")+".csv";g.href=j,g.download=y,document.body.appendChild(g),g.click(),g.remove()}catch(u){console.log(u)}finally{r(!1)}},[s,o,i,t,n]),isLoading:a}},zo=({rules:t,filterValues:n})=>{const[s,o]=te.useState(null),{download:i,isDownloading:a}=wi({rule_ids:t.map(g=>g.id),account_ids:n.account_ids}),{downloadRules:r,isLoading:d}=Oo(t.map(g=>g.id),n.account_ids),l=()=>{o(null)},u=g=>{o(g.currentTarget)},m=()=>{r(),o(null)},j=()=>{i(),o(null)};return e.jsxs(e.Fragment,{children:[e.jsx(w,{variant:"outlined",loading:a||d,startIcon:e.jsx(ws,{style:{fontSize:"14px"}}),onClick:u,size:"small",style:{padding:"0px 12px"},children:"Export to CSV"}),e.jsxs(jt,{anchorEl:s,keepMounted:!0,open:!!s,onClose:l,anchorOrigin:{vertical:"bottom",horizontal:"left"},style:{marginTop:"6px"},children:[e.jsxs(F,{onClick:m,children:[e.jsx(L,{primary:"Rules Summary"}),e.jsx($,{children:e.jsx(ne,{placement:"top",title:e.jsxs(x,{column:!0,fullHeight:!0,children:[e.jsx(p,{variant:"body2",color:"textSecondary",children:"Rules Summary"}),e.jsx(p,{variant:"body2",children:"Export a high-level rules overview, capturing essential details like rule names, violations count, severity levels, and statuses."})]}),children:e.jsx(se,{style:{fontSize:"12px"}})})})]}),e.jsxs(F,{onClick:j,children:[e.jsx(L,{primary:"Detailed Violations Summary"}),e.jsx($,{children:e.jsx(ne,{placement:"top",title:e.jsxs(x,{column:!0,fullHeight:!0,children:[e.jsx(p,{variant:"body2",color:"textSecondary",children:"Detailed Violations Report"}),e.jsx(p,{variant:"body2",children:"Export an in-depth report of all rule violations, containing detailed information for each incident. Depending on the number of findings, this report may take longer to generate and download."})]}),children:e.jsx(se,{style:{fontSize:"12px",marginLeft:"14px"}})})})]})]})]})};function Mo({selectedRuleIds:t,waitConfirm:n,onComplete:s,confirmState:o}){const i=Ue({selectedRuleIds:t,onComplete:s});return c.useCallback(()=>{n(()=>{i({data:{state:"disabled"},loadingMessage:"Disabling rules in progress...",successMessage:"Disabled rules successfully",errorMessage:"Something went wrong while trying to disable rules"})},o)},[i,n,o])}function Vo({selectedRuleIds:t,waitConfirm:n,onComplete:s,confirmState:o}){const i=Ue({selectedRuleIds:t,onComplete:s});return c.useCallback(()=>{n(()=>{i({data:{state:"archived"},loadingMessage:"Archiving rules in progress...",successMessage:"Archived rules successfully",errorMessage:"Something went wrong while trying to archive rules"})},o)},[i,n,o])}function Po(t){const n=c.useRef(),[s,o]=c.useState(),[i,a]=c.useState(!1),r=c.useCallback((l,u)=>{new Promise(m=>{n.current=m,a(!0),o(u)}).then(l)},[]);return[c.useCallback(()=>{a(!1),n.current(),t==null||t()},[t]),r,i,a,s]}function Ue({selectedRuleIds:t,onComplete:n}){const s=Z(),o=c.useMemo(()=>Array.from(t),[t]),i=Ao();return c.useCallback(({data:a,loadingMessage:r,successMessage:d,errorMessage:l})=>{s(r,"info",null),i(o,a).then(()=>{s(d,"success"),n==null||n()}).catch(u=>{console.error(u),s(l,"error",null)})},[i,o,s,n])}function Bo({selectedRuleIds:t,onComplete:n}){const s=Ue({selectedRuleIds:t,onComplete:n}),[o,i]=c.useState(!1);return[c.useCallback(a=>{typeof a<"u"?(s({data:{severity:a},loadingMessage:"Editing severity for selected rules...",errorMessage:"Something went wrong while editing severity",successMessage:"Edited severity successfully"}),i(!1)):i(!0)},[s]),o,i]}function Wo({selectedRuleIds:t,onComplete:n}){const s=Ue({selectedRuleIds:t,onComplete:n}),[o,i]=c.useState(!1);return[c.useCallback(a=>{typeof a<"u"?(s({data:{fail_simulation:a},loadingMessage:"Editing force fail simulation for selected rules...",errorMessage:"Something went wrong while editing force fail simulation",successMessage:"Edited force fail simulation successfully",onComplete:n}),i(!1)):i(!0)},[s,n]),o,i]}function qo({selectedRuleIds:t,onComplete:n}){const s=Z(),[o,i]=c.useState(!1),a=pn({selectedRuleIds:t,field:"labels"});return[c.useCallback(r=>{if(typeof r<"u"){i(!1);const{addLabels:d,removeLabels:l}=r;s("Editing labels for selected rules...","info",null),Promise.all([a(d,!1),a(l,!0)]).then(()=>{s("Edited labels successfully","success"),n==null||n()}).catch(u=>{console.error(u),s("Something went wrong while editing labels","error",null)})}else i(!0)},[a,s,n]),o,i]}function Go({selectedRuleIds:t,onComplete:n}){const s=Z(),[o,i]=c.useState(!1),a=pn({selectedRuleIds:t,field:"compliance"});return[c.useCallback(r=>{if(typeof r<"u"){i(!1);const{addCompliance:d,removeCompliance:l}=r;s("Editing compliance for selected rules...","info",null),Promise.all([a(d,!1),a(l,!0)]).then(()=>{s("Edited compliance successfully","success"),n==null||n()}).catch(u=>{console.error(u),s("Something went wrong while editing compliance","error",null)})}else i(!0)},[a,s,n]),o,i]}const Ho=({extendedWidth:t,...n})=>{const[s,o]=c.useState(!1),[i,a]=c.useState(!1),r=c.useRef(null),d=()=>{o(m=>(!m&&r.current&&r.current.focus(),!m))},l=()=>{i||o(!1)},u=()=>{a(!0),setTimeout(()=>{a(!1)},0)};return e.jsx(x,{row:!0,gap:2,children:e.jsx(Uo,{expanded:s,extendedWidth:t,variant:"outlined",size:"small",onFocus:()=>o(!0),onBlur:l,inputRef:r,InputProps:{endAdornment:e.jsx(Ss,{position:"end",children:e.jsx(Yt,{onClick:d,onMouseDown:u,children:e.jsx(mn,{fontSize:"small",color:"action"})})})},...n})})},Uo=f(P).withConfig({displayName:"ExpandableSearch__StyledTextField",componentId:"sc-8v3imc-0"})(({expanded:t,extendedWidth:n})=>({background:"transparent",".MuiInputBase-root":{width:t?n:32.5,transition:"width 0.3s ease",overflow:"hidden",paddingRight:t?8:0,paddingLeft:t?8:0},".MuiInputBase-input":{...!t&&{paddingLeft:0,paddingRight:0,opacity:0},pointerEvents:t?"auto":"none",transition:"opacity 0.3s ease"},...!t&&{".MuiOutlinedInput-notchedOutline":{display:"none"},".MuiInputAdornment-root":{margin:0}}}));function Qo(){const t=Xn(),[n,s]=vt("rules-page-chart-visible",!0),{state:o}=dt(),i=It(),[a,r,d]=Fi(),{selectedRuleIds:l,setSelectedRuleIds:u}=c.useContext(Gn),{filtersValues:m,filterOnlyViolations:j,showArchived:g}=c.useMemo(()=>({filtersValues:{...N.omitBy(N.omit(a,["only_violations","archived"]),_=>Array.isArray(_)&&_.length===0)},filterOnlyViolations:st(a==null?void 0:a.only_violations,!0),showArchived:st(a==null?void 0:a.archived)}),[a]),[h,y]=c.useState(a==null?void 0:a.name),R=c.useMemo(()=>j||g||Object.keys(m).length>0,[j,m,g]),[b,I]=c.useState(!0),[z,{loading:Q,loadingAccountsData:S,error:M}]=ks(),[W,{loading:oe,error:Qe}]=Is(),q=c.useMemo(()=>z==null?void 0:z.filter(_=>g?_.state==="archived":_.state!=="archived").map(_=>{var V;return{..._,violationsCount:(V=W[_.id])==null?void 0:V.count}}),[z,g,W]),T=Es(q,m,j),Re=Q||oe||S,Lt=M||Qe,Ot=es((_,V)=>r({...V,name:_}),500),Hn=c.useCallback(_=>{y(_),Ot(_,a)},[Ot,a]),Un=c.useCallback(_=>{_&&Object.keys(_).length>0?r({..._,...(_==null?void 0:_.archived)&&j&&{only_violations:!1}}):r(null)},[j,r]),Qn=c.useCallback(()=>{r(j?{...a,only_violations:!1}:null)},[j,a,r]),Yn=T.reduce((_,V)=>{const Ye=Me(V.severity)??"";return _[Ye]||(_[Ye]={value:0,color:dn(t,V.severity)}),_[Ye].value+=V.violationsCount??0,_},{});return e.jsx(Ds,{screen:ts.Rules,body:{filters:a},updateBody:_=>{var V;Un(_==null?void 0:_.filters),y(((V=_==null?void 0:_.filters)==null?void 0:V.name)||"")},getLink:d,children:e.jsxs(v,{grow:[0,1],style:{height:"100%"},children:[e.jsx("div",{}),e.jsxs(E,{grow:!0,children:[e.jsx(Rt,{open:b,children:e.jsxs(Yo,{grow:[0,1],children:[e.jsx(ie,{dense:!0,title:e.jsx(Ns,{}),actions:e.jsx(E,{gap:1,style:{alignItems:"center"},children:e.jsx(xn,{open:!0,onClick:()=>I(!1)})})}),e.jsx(Ts,{Filters:_=>e.jsx(io,{allRules:q,rules:T,loadingAccountsData:S,..._})})]})}),e.jsxs(v,{grow:[0,0,1],children:[e.jsx(ko,{loading:Re,allRules:T,rules:T,selectedRuleIds:l,startAdornment:e.jsx(e.Fragment,{children:e.jsx(As,{})}),actions:e.jsxs(x,{row:!0,gap:2,children:[e.jsx(Ho,{placeholder:"Search by rule name",variant:"outlined",value:h,size:"small",extendedWidth:260,onChange:_=>Hn(_.target.value)}),e.jsx(w,{variant:"outlined",size:"small",active:b,disabled:!(q!=null&&q.length),startIcon:e.jsx(hn,{}),onClick:()=>I(!b),children:"Filters"}),e.jsx(Lo,{selectedRuleIds:l}),e.jsx(zo,{rules:T,filterValues:m}),e.jsx(w,{size:"small",startIcon:e.jsx(sn,{fontSize:"small"}),variant:"outlined",onClick:i.createRule,children:"New Rule"}),e.jsx(D,{variant:"middle",orientation:"vertical",flexItem:!0}),e.jsx(J,{selected:n,onClick:()=>{s(!n)},children:e.jsx(Fs,{fontSize:"small"})})]})}),n&&q&&e.jsx($s,{filters:m,severities:Yn}),Re?e.jsx(fe,{children:e.jsx(wt,{})}):!q&&Lt?e.jsx(St,{error:Lt}):(T==null?void 0:T.length)===0?e.jsx(to,{allRules:q,hasFilters:R,filterOnlyViolations:j,onClick:Qn}):e.jsx(Ko,{children:e.jsx(fo,{selected:l,setSelected:u,rules:T,focusRuleId:o==null?void 0:o.focusRuleId,filtersValues:m})})]})]})]})})}const Yo=f(v).withConfig({displayName:"RulesPage__FiltersContainers",componentId:"sc-ht7nnt-0"})(({theme:t})=>({maxWidth:300})),Ko=f(v).withConfig({displayName:"RulesPage__Content",componentId:"sc-ht7nnt-1"})(({theme:t})=>({overflow:"auto"}));function Zo({rule:t,headerActions:n,...s}){var o,i;return e.jsxs(ta,{...s,children:[e.jsx(ie,{actions:n,title:e.jsxs(e.Fragment,{children:[e.jsx(se,{color:"action"}),e.jsx(p,{variant:"subtitle1",children:"Details"})]})}),e.jsx(na,{children:e.jsxs(v,{gap:2,style:{overflow:"visible"},children:[(t==null?void 0:t.status)==="invalid"&&e.jsx(Jo,{rule:t}),e.jsx(C,{icon:e.jsx(Fe,{category:t==null?void 0:t.category,fontSize:"small",color:"action"}),label:t==null?void 0:t.category}),e.jsx(C,{icon:e.jsx(Rn,{name:t==null?void 0:t.created_by}),label:Ct(t==null?void 0:t.creation_date)}),e.jsx(D,{light:!0}),e.jsx(C,{icon:e.jsx(mt,{fontSize:"small",color:"action"}),label:"Violations",labelVariant:"subtitle2"}),e.jsxs(E,{gap:1,children:[e.jsx(C,{icon:e.jsx(Ne,{severity:t==null?void 0:t.severity}),label:Me(t==null?void 0:t.severity)}),(t==null?void 0:t.rule_type)===_e.Path&&e.jsx(sa,{subject:t.subject})]}),(t==null?void 0:t.fail_simulation)&&e.jsx(C,{icon:e.jsx(ea,{fontSize:"small"}),label:"Fail violating simulations"}),(t==null?void 0:t.description)&&e.jsxs(e.Fragment,{children:[e.jsx(D,{light:!0}),e.jsxs(v,{gap:1,children:[e.jsx(C,{icon:e.jsx(Ls,{fontSize:"small",color:"action"}),label:"Description",labelVariant:"subtitle2"}),e.jsx(Vt,{color:"textSecondary",children:t==null?void 0:t.description})]})]}),(t==null?void 0:t.remediation)&&e.jsxs(e.Fragment,{children:[e.jsx(D,{light:!0}),e.jsxs(v,{gap:1,children:[e.jsx(C,{icon:e.jsx(Os,{fontSize:"small",color:"action"}),label:"Remediation",labelVariant:"subtitle2"}),e.jsx(Vt,{color:"textSecondary",children:t==null?void 0:t.remediation})]})]}),(t==null?void 0:t.finding_type)&&e.jsxs(e.Fragment,{children:[e.jsx(D,{light:!0}),e.jsxs(v,{gap:1,children:[e.jsx(C,{icon:e.jsx(zs,{fontSize:"small",color:"action"}),label:"Finding Type",labelVariant:"subtitle2"}),e.jsx(Ae,{findingType:t==null?void 0:t.finding_type})]})]}),((o=t==null?void 0:t.labels)==null?void 0:o.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx(D,{light:!0}),e.jsxs(v,{gap:2,style:{overflow:"visible"},children:[e.jsx(C,{icon:e.jsx($e,{fontSize:"small",color:"action"}),label:"Labels",labelVariant:"subtitle2"}),e.jsx(Wt,{children:t.labels.map((a,r)=>e.jsx(qt,{children:a},r))})]})]}),((i=t==null?void 0:t.compliance)==null?void 0:i.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx(D,{light:!0}),e.jsxs(v,{gap:2,style:{overflow:"visible"},children:[e.jsx(C,{icon:e.jsx(Le,{fontSize:"small",color:"action"}),label:"Compliance",labelVariant:"subtitle2"}),e.jsx(Wt,{children:t.compliance.map((a,r)=>e.jsx(qt,{children:a},r))})]})]})]})})]})}const Wt=f.div.withConfig({displayName:"RuleDetails__LabelsWrapper",componentId:"sc-1exz6by-0"})({display:"flex",flexWrap:"wrap"});function Jo(){return e.jsxs(Xo,{gap:1,children:[e.jsxs(E,{style:{alignItems:"center"},gap:1,children:[e.jsx(bt,{fontSize:"small",color:"error"}),e.jsx(p,{variant:"subtitle1",children:"Rule criteria is no longer valid"})]}),e.jsx(D,{light:!0}),e.jsx(p,{children:"One of the resources included in this rule has been removed. No violations are collected."})]})}const Xo=f(v).withConfig({displayName:"RuleDetails__InvlidBox",componentId:"sc-1exz6by-1"})(({theme:t})=>({background:de(t.palette.error.main,.25),padding:t.spacing(2),borderRadius:t.shape.borderRadius})),qt=f.span.withConfig({displayName:"RuleDetails__Label",componentId:"sc-1exz6by-2"})(({theme:t})=>({borderRadius:t.shape.borderRadius/2,border:`solid 1px ${t.palette.divider}`,padding:t.spacing(.5,1),margin:t.spacing(0,.5,.5,0)})),ea=f(gn).withConfig({displayName:"RuleDetails__GreenCheckIcon",componentId:"sc-1exz6by-3"})(({theme:t})=>({color:t.palette.common.green})),ta=f(v).withConfig({displayName:"RuleDetails__Container",componentId:"sc-1exz6by-4"})(({theme:t})=>({background:t.palette.background.default,maxWidth:350})),na=f.div.withConfig({displayName:"RuleDetails__Content",componentId:"sc-1exz6by-5"})(({theme:t})=>({flexGrow:1,overflow:"auto",padding:t.spacing(2)})),sa=({subject:t})=>{const s={[H.Source]:Pt,[H.Intermediate]:Vs,[H.Destination]:Ms}[t]||Pt;return e.jsxs(e.Fragment,{children:[e.jsx(D,{light:!0,flexItem:!0,orientation:"vertical",variant:"middle"}),e.jsx(ne,{placement:"top",title:"This resource is set to trigger a violation when the ruleâ€™s criteria are met.",children:e.jsx(C,{icon:e.jsx(s,{color:"action"}),label:ae(t)})})]})};function ia({form:t,rule:n,onClose:s,...o}){const[i,{loading:a}]=Et(),r=Z(),d=c.useCallback(async()=>{let l=t.getValues();n.state!=="draft"&&(l=N.omit(l,["rule_type","ports","allowed_actions","subject","action","path_destination_predicate_equals_match","path_intermediate_predicate_equals_match","path_intermediate_predicate_operand","path_source_predicate_equals_match",...Nn])),i(n.id,l).then(u=>{r("Rule updated successfully","success"),s(),t.reset(u)}).catch(u=>r(u.message,"error"))},[i,t,r,s,n]);return e.jsxs(aa,{...o,children:[e.jsx(ie,{title:e.jsxs(e.Fragment,{children:[e.jsx(se,{color:"action"}),e.jsx(p,{variant:"subtitle1",children:"Details"})]}),actions:e.jsxs(E,{gap:1,children:[e.jsx(w,{variant:"text",size:"small",disabled:a,onClick:s,children:"Discard"}),e.jsx(w,{disabled:a||!t.formState.isDirty,startIcon:a?e.jsx(me,{size:10}):e.jsx(Ps,{fontSize:"small"}),size:"small",color:"primary",onClick:d,children:"Save"})]})}),e.jsx(oa,{children:e.jsx(Sn,{form:t})})]})}const oa=f.div.withConfig({displayName:"RuleDetailsEdit__Content",componentId:"sc-1l3m3u8-0"})(({theme:t})=>({flexGrow:1,overflow:"auto",padding:t.spacing(2)})),aa=f(v).withConfig({displayName:"RuleDetailsEdit__Container",componentId:"sc-1l3m3u8-1"})(({theme:t})=>({background:t.palette.background.default,maxWidth:350}));function ra({form:t,...n}){const{watch:s}=t,o=s("rule_type");return e.jsxs(la,{...n,children:[e.jsx("div",{style:{flexGrow:1},children:e.jsxs(v,{gap:1,children:[e.jsx(C,{icon:e.jsx(xt,{color:"action"}),label:"Conditions",labelVariant:"subtitle1"}),e.jsx(vn,{form:t})]})}),_e.Path===o&&e.jsx("div",{children:e.jsx(En,{form:t})})]})}const la=f.div.withConfig({displayName:"RuleEditForm__Container",componentId:"sc-6yf624-0"})(({theme:t})=>({padding:t.spacing(2),overflow:"auto",height:"100%",display:"flex",flexDirection:"column"}));function ca({rule:t}){const n=t==null?void 0:t.exclusion_predicates,s=Z(),[o,{loading:i}]=Et(),a=kt(c.useMemo(()=>({exclusion_predicates:n}),[n]),null),r=async()=>{try{const d=a.getValues();await o(t.id,d),a.reset(d),s("Saved successfully","success")}catch(d){s(d.message,"error")}};return e.jsx(Si,{form:a,submitting:i,onSubmit:r})}function Fn({field:t,filters:n}){const s=ct();return c.useCallback(({phrase:o,skip:i,limit:a})=>s.query({query:da,variables:{field:t,filters:n,phrase:o,skip:i,limit:a}}).then(({data:r})=>r==null?void 0:r.ruleViolations_facet),[s,t,n])}const da=ue`
  query RuleViolationsFacetQuery(
    $field: RuleViolationFacetField
    $filters: RuleViolationFilters
    $phrase: String
    $skip: Int
    $limit: Int
  ) {
    ruleViolations_facet(
      field: $field
      filters: $filters
      phrase: $phrase
      skip: $skip
      limit: $limit
    )
  }
`;function ua(){const{integrations:t}=Bs();return(t==null?void 0:t.length)>0}function pa({rule:t,values:n,onChange:s}){return e.jsx(on,{filters:ma({rule_id:t==null?void 0:t.id}),filterValues:n,onChange:s})}function ma(t){const n={resourceId:K({field:"resource_id",displayName:"Resource ID",filters:t}),resourceAccount:K({field:"account",displayName:"Account",filters:t}),resourceType:xa({field:"resource_type",displayName:"Resource Type",filters:t}),resourceVpc:K({field:"vpc",displayName:"VPC",filters:t}),region:ha({field:"region",displayName:"Region",filters:t}),availabilityZones:be({field:"availability_zones",displayName:"Availability Zone",filters:t}),subnet:K({field:"subnet",displayName:"Subnet",filters:t}),cluster:K({field:"cluster",displayName:"Cluster",filters:t}),autoScalingGroup:K({field:"auto_scaling_group",displayName:"Auto Scaling Group",filters:t}),namespace:K({field:"namespace",displayName:"Namespace",filters:t}),deployment:K({field:"deployment",displayName:"Deployment",filters:t}),ticketIds:s()};function s(){const i=Fn({field:"ticket_ids",filters:t});return be({field:"ticket_ids",displayName:"Ticket ID",getAllOptions:c.useCallback(()=>i({}),[i]),filters:t})}const o=ua();return c.useMemo(()=>[n.resourceId,n.resourceAccount,{key:"resource_tag",displayName:"Resource Tag",type:({value:i,onChange:a})=>e.jsx(Ws,{value:i,onChange:a,renderTag:qs,renderKeyInput:r=>e.jsx(Hs,{...r}),renderValueInput:r=>e.jsx(Gs,{...r})})},n.resourceVpc,n.resourceType,n.region,n.availabilityZones,n.subnet,n.cluster,n.autoScalingGroup,n.namespace,n.deployment,...o?[n.ticketIds]:[]].sort((i,a)=>i.displayName>a.displayName?1:-1),[n.resourceId,n.resourceAccount,n.resourceVpc,n.resourceType,n.region,n.availabilityZones,n.subnet,n.cluster,n.autoScalingGroup,n.namespace,n.deployment,n.ticketIds,o])}function be({field:t,filters:n,...s}){const o=Fn({field:t,filters:n});return c.useMemo(()=>({key:t,limit:200,searchableOptions:!0,getOptions:async({phrase:i,skip:a,limit:r})=>await o({phrase:i,skip:a,limit:r}),...s}),[s,o,t])}function K(t){const n=be(t);return c.useMemo(()=>({...n,renderOption:s=>s.includes(" ")?s:e.jsx(Ie,{id:s})}),[n])}function xa(t){const n=be(t);return c.useMemo(()=>({...n,renderOption:s=>e.jsx(C,{icon:e.jsx(jn,{type:s,size:"small"}),label:ns(s)})}),[n])}function ha(t){const n=be(t);return c.useMemo(()=>({...n,renderOption:s=>e.jsxs(E,{gap:1,children:[e.jsx(jn,{size:"small",type:"Region"}),e.jsx(p,{children:s})]})}),[n])}function ga({filtersValues:t,onFiltersChange:n,rule:s,sortOptions:o,onSortChange:i}){const[a,r]=vt("rule-violations-filters",!0);return e.jsx(Us,{children:e.jsxs(ba,{grow:!0,children:[e.jsx(ja,{rule:s,open:a,values:t,onChange:n,onClose:()=>r(!1)}),e.jsx(Qs,{rule:s,filtersValues:t,filtersOpen:a,setFiltersOpen:r,sortOptions:o,onSortChange:i})]})})}function ja({rule:t,open:n,onClose:s,values:o,onChange:i,...a}){const r=c.useMemo(()=>o?Object.keys(o).length:0,[o]);return e.jsx(Rt,{open:n,...a,children:e.jsxs(ya,{grow:[0,1],children:[e.jsx(ie,{icon:e.jsx(hn,{fontSize:"small",color:"action"}),title:e.jsxs(p,{variant:"subtitle1",noWrap:!0,children:["Filter by"," ",r>0?`(${r})`:""]}),actions:e.jsx(J,{onClick:s,children:e.jsx(pe,{})})}),e.jsx(fa,{children:e.jsx(pa,{rule:t,values:o,onChange:i})})]})})}const fa=f.div.withConfig({displayName:"RuleViolations__Content",componentId:"sc-1f9jfnz-0"})({overflow:"auto"}),ya=f(v).withConfig({displayName:"RuleViolations__FiltersBox",componentId:"sc-1f9jfnz-1"})(({theme:t})=>({maxWidth:300,borderRight:`solid 1px ${t.palette.dividerLight}`,background:de(t.palette.background.default,.25)})),ba=f(E).withConfig({displayName:"RuleViolations__Container",componentId:"sc-1f9jfnz-2"})(({theme:t})=>({flexGrow:1}));function _a(t){return c.useMemo(()=>({rule_id:t==null?void 0:t.id}),[t==null?void 0:t.id])}var Ca=Ys();const va=ss(Ca);function An(t,n){const s=gt();return[c.useCallback(async(...i)=>{if(await s.confirm({actionsLayout:"row",inputText:{disabled:!0},...n}))return t[0](...i)},[s,n,t]),t[1]]}function Tt(t){return Object.keys(t||{}).filter(n=>n!=="__typename"&&n!=="preferred_action"&&n!=="remediation_config_last_updated_time"&&n!=="remediation_config_last_updated_user_id").some(n=>{var s;return((s=t==null?void 0:t[n])==null?void 0:s.length)>0})}function Ft(){var s;const{data:t,...n}=B(rt);return{...n,enabled:!!((s=t==null?void 0:t.workspace_auto_remediation_config)!=null&&s.active_auto_remediation)}}const rt=O(`
  query AutoRemediationWorkspaceEnabled {
    workspace_auto_remediation_config {
      active_auto_remediation
    }
  }
`),At=O(`
  query AutoRemediationRuleConfig($rule_id: ID) {
    rule(id: $rule_id) {
      id
      path_destination_predicates {
        resource_type
      }
      path_intermediate_predicates {
        resource_type
      }
      path_source_predicates {
        resource_type
      }
      resource_predicates {
        resource_type
      }
      remediation_config {
        ...AutoRemediationRuleConfigFields
      }
    }
  }
`);function $n({ruleId:t}){return B(At,{variables:{rule_id:t}})}const Ln=O(`
  query AutoRemediationRuleEnabled($rule_id: ID) {
    rule(id: $rule_id) {
      id
      remediation_enable
    }
  }
`);function Ra({ruleId:t}){return B(Ln,{variables:{rule_id:t}})}const On=c.createContext(null);function he(){const t=c.useContext(On);if(!t)throw new Error("useConfigContext must be used within a ConfigContext");return t}function wa(){return Ce(O(`
    mutation AutoRemediationRuleEditEnabled($rule_id: ID!, $enable: Boolean!) {
      edit_enable_rule_auto_remediation(rule_id: $rule_id, enable: $enable) 
    }`))}function Sa(t){return{title:t?"Disable Rule Auto-Remediation":"Enable Rule Auto-Remediation",text:t?"Are you sure you want to disable auto remediation for this specific rule?":"Are you sure you want to enable auto remediation for this specific rule?",confirmText:t?"Disable":"Enable"}}const $t=c.forwardRef((t,n)=>{const{checked:s,disabled:o,ruleId:i,mutationOptions:a}=t,[r,{loading:d}]=An(wa(),Sa(s));return e.jsxs(x,{row:!0,gap:!0,center:!0,ref:n,children:[e.jsx(Te,{checked:s,disabled:o||d,size:"small",onClick:l=>{l.stopPropagation(),r({...a,variables:{rule_id:i,enable:!s}})}}),e.jsx(p,{color:o?"textSecondary":"textPrimary",children:s?"Enabled":"Disabled"}),d&&e.jsx(me,{size:15})]})});function ka({showTooltip:t,...n}){const{enabled:s,loading:o}=Ft(),i=t||!s;return e.jsx(ne,{disabled:!i,title:s?"Configure a remediation policy to enable auto-remediation":"Auto-remediation is disabled for the entire workspace",children:e.jsxs(x,{row:!0,center:!0,gap:2,children:[e.jsx($t,{...n,disabled:n.disabled||!s||o,checked:n.checked&&!n.disabled}),i&&e.jsx(se,{fontSize:"small",color:"action"})]})})}function Ia(){var d,l;const{ruleId:t}=he(),{data:n,loading:s}=Ra({ruleId:t}),{data:o}=$n({ruleId:t}),i=!!((d=n==null?void 0:n.rule)!=null&&d.remediation_enable),a=Tt((l=o==null?void 0:o.rule)==null?void 0:l.remediation_config),r=!a||s;return e.jsx(ka,{showTooltip:!a,disabled:r,checked:i,ruleId:t,mutationOptions:{update(u){u.writeQuery({query:Ln,variables:{rule_id:t},data:{rule:{__typename:"Rule",id:t,remediation_enable:!i}}})}}})}function Y(){return Js()}function Ea({children:t}){const n=Y();return e.jsx(x,{column:!0,fullHeight:!0,loading:n.formState.isLoading,children:t})}function Da({ruleId:t}){const n=ct();return nn({mode:"onChange",defaultValues:async()=>{var i;const{data:o}=await n.query({query:At,fetchPolicy:"network-only",variables:{rule_id:t}});return(i=o==null?void 0:o.rule)==null?void 0:i.remediation_config}})}function Na({ruleId:t,children:n}){const s=Da({ruleId:t}),o=c.useMemo(()=>({ruleId:t}),[t]);return e.jsx(On.Provider,{value:o,children:e.jsx(Ks,{...s,children:n})})}function zn(){const{ruleId:t}=he(),{data:n}=$n({ruleId:t});return c.useMemo(()=>{var s,o;return((o=(s=n==null?void 0:n.rule)==null?void 0:s.path_destination_predicates)==null?void 0:o.map(i=>i.resource_type).filter(Boolean))||[]},[n])}const Mn={accounts:[],regions:[],resource_types:[],resource_ids:null,resource_tags:[],source_user_agent:null,event_name:null,source_user_identity:null,preferred_action:null};$t.displayName="AutoRemediationRuleEnableSwitch";const lt="ByEvent";function Vn({ruleId:t}){return B(O(`
      query Runbooks($rule_id: ID!) {
        rule_runbooks(rule_id: $rule_id) {
          allow_smart_remediation
          runbooks {
            runbook_name
            runbook_description
            runbook_content
          }
      }
    }
    `),{variables:{rule_id:t}})}const Ta=f(x).withConfig({displayName:"AutoRemediationRuleSettings__SmartBox",componentId:"sc-1dekiw-0"})(["background:",";"],t=>t.theme.palette.gradients.aiOutline);function Fa({checked:t,onSelect:n}){return e.jsx(Ta,{round:!0,border:!0,hover:!0,children:e.jsxs(x,{row:!0,gap:2,pad:!0,selected:t,children:[e.jsx(re,{size:"small",checked:t,onClick:()=>n()}),e.jsxs(x,{column:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Smart Remediation"}),e.jsx(p,{color:"textSecondary",children:"Stream will auto apply one of the following actions based on violation context"})]})]})})}function Aa({runbook:t,checked:n,onSelect:s}){const[o,i]=c.useState(!1);return e.jsxs(x,{round:!0,border:!0,column:!0,children:[e.jsxs(x,{row:!0,gap:2,pad:!0,selected:n,...t.runbook_content&&{hover:!0,onClick:()=>i(!o)},children:[e.jsx(re,{size:"small",checked:n,onClick:a=>{a.stopPropagation(),s()}}),e.jsxs(x,{column:!0,style:{justifyContent:"center"},children:[e.jsx(p,{variant:"subtitle2",children:t.runbook_name}),e.jsx(p,{color:"textSecondary",children:t.runbook_description})]}),e.jsx(x,{grow:!0}),t.runbook_content&&e.jsx(Yt,{children:o?e.jsx(ii,{}):e.jsx(oi,{})})]}),e.jsxs(ai,{in:o,children:[e.jsx("div",{style:{height:10}}),e.jsxs(x,{row:!0,gap:2,children:[e.jsx(re,{size:"small",style:{visibility:"hidden"}}),e.jsx(x,{bg:!0,round:!0,children:e.jsx("pre",{style:{padding:"0 12px"},children:t.runbook_content})})]})]})]})}function $a(){var a,r,d;const{ruleId:t}=he(),{data:n}=Vn({ruleId:t}),s=Y(),{field:o}=qe({name:"preferred_action",control:s.control}),i=s.watch("preferred_action");return e.jsxs(x,{column:!0,gap:2,children:[e.jsx(p,{variant:"subtitle1",children:"Remediation Action"}),((a=n==null?void 0:n.rule_runbooks)==null?void 0:a.allow_smart_remediation)&&e.jsxs(e.Fragment,{children:[e.jsx(Fa,{checked:i===lt,onSelect:()=>o.onChange(lt)}),e.jsx(p,{color:"textSecondary",children:"Or select one of the following:"})]}),(d=(r=n==null?void 0:n.rule_runbooks)==null?void 0:r.runbooks)==null?void 0:d.map(l=>e.jsx(Aa,{checked:l.runbook_name===i,runbook:l,onSelect:()=>o.onChange(l.runbook_name)},l.runbook_name))]})}function La(){var r,d;const{ruleId:t}=he(),n=Y(),s=n.watch(),o=Object.keys(s).some(l=>{var u;return((u=s[l])==null?void 0:u.length)>0}),{data:i}=Vn({ruleId:t}),a=c.useMemo(()=>{var l,u,m,j;return{...Mn,preferred_action:(l=i==null?void 0:i.rule_runbooks)!=null&&l.allow_smart_remediation?lt:(j=(m=(u=i==null?void 0:i.rule_runbooks)==null?void 0:u.runbooks)==null?void 0:m[0])==null?void 0:j.runbook_name}},[(r=i==null?void 0:i.rule_runbooks)==null?void 0:r.allow_smart_remediation,(d=i==null?void 0:i.rule_runbooks)==null?void 0:d.runbooks]);return e.jsx(w,{disabled:!o,onClick:()=>{n.reset(a,{keepDefaultValues:!0})},children:"Reset to Default"})}function Oa(){return Ce(O(`
    mutation AutoRemediationRuleEditConfig($rule_id: ID!, $config: AutoRemediationRuleConfigInput!) {
      edit_config_rule_auto_remediation(rule_id: $rule_id, config: $config) 
    }`))}function za(){const t=Z(),{ruleId:n}=he(),[s,{loading:o}]=Oa(),i=Y(),{isDirty:a}=Xs({control:i.control});return e.jsx(w,{color:"primary",disabled:!a||o,startIcon:o&&e.jsx(me,{size:15}),onClick:()=>s({variables:{rule_id:n,config:i.getValues()},update(r){const d=va(i.getValues(),Mn);r.writeQuery({query:At,variables:{rule_id:n},data:{rule:{__typename:"Rule",id:n,remediation_config:{...d,__typename:"AutoRemediationRuleConfig"}}}})}}).then(()=>{t("Saved successfully","success"),i.reset(i.getValues())}).catch(r=>{t(`Error: ${r.message}`,"error")}),children:"Save Changes"})}function Ma({tagKey:t,value:n}){const[s,o]=c.useState(n||""),[i]=De(s,300),{data:a,loading:r}=B(O(`
    query ResourceTagValues($key: String, $search_keyword: String) {
      resourceTagValues(key: $key, search_keyword: $search_keyword) 
    }
  `),{variables:{key:t,search_keyword:i}});return c.useEffect(()=>{o(n||"")},[n]),{options:(a==null?void 0:a.resourceTagValues)||[],inputValue:s,onInputChange:(d,l)=>o(l),filterOptions:(d,{inputValue:l})=>d.filter(u=>!l||u.toLowerCase().includes(l.toLowerCase())),loading:r}}function Va({value:t}){const[n,s]=c.useState(t||""),[o]=De(n,300),{data:i,loading:a}=B(O(`
    query ResourceTagKeys($search_keyword: String) {
      resourceTagKeys(search_keyword: $search_keyword) 
    }
  `),{variables:{search_keyword:o}});return c.useEffect(()=>{s(t||"")},[t]),{options:(i==null?void 0:i.resourceTagKeys)||[],inputValue:n,onInputChange:(r,d)=>s(d),filterOptions:(r,{inputValue:d})=>r.filter(l=>!d||l.toLowerCase().includes(d.toLowerCase())),loading:a}}function Pa({tag:t,onChange:n}){const s=Ma({tagKey:t.key,value:t.value});return e.jsxs(e.Fragment,{children:[e.jsx(bn,{defaultValue:is.Equals,variant:"standard",style:{flexGrow:1},value:t.operand,onChange:o=>{const i=o.target.value;n({...t,operand:i,value:i===k.Empty||i===k.NotEmpty?null:t.value})},children:Object.values(k).map(o=>e.jsx(F,{value:o,children:{[k.Equals]:"Is",[k.NotEquals]:"Is not",[k.NotContains]:"Not contains",[k.Empty]:"Empty",[k.NotEmpty]:"Not empty"}[o]||ye(o)},o))}),t.operand!==k.Empty&&t.operand!==k.NotEmpty&&e.jsx(Ge,{value:t.value||"",onChange:(o,i)=>n({...t,value:i}),freeSolo:!0,autoSelect:!0,style:{flexGrow:2},renderInput:o=>e.jsx(P,{...o,placeholder:"Values"}),renderOption:o=>e.jsx(U,{children:e.jsx(p,{noWrap:!0,children:o})}),...s})]})}const Pn=f(x).withConfig({displayName:"AutoRemediationRuleSettings__InputLayout",componentId:"sc-1dekiw-1"})(({theme:t})=>({background:"#D0D0D026",display:"flex",gap:t.spacing(1),padding:t.spacing(2),borderRadius:t.shape.borderRadius,border:"solid 1px #D0D0D026"}));function Ba({tag:t,onChange:n}){return e.jsxs(Pn,{children:[e.jsx(Ge,{value:t.key||"",onChange:(s,o)=>n({...t,key:o,value:o?t.value:null,operand:o?t.operand||k.Equals:null}),style:{flexGrow:2},freeSolo:!0,autoSelect:!0,renderInput:s=>e.jsx(P,{...s,placeholder:"Add Resource Tag Key",InputProps:{...s.InputProps,disableUnderline:!t.key}}),...Va({value:t.key})}),t.key&&e.jsx(Pa,{tag:t,onChange:n})]})}const Bn={options:[]};function we({field:t,options:n=Bn.options,freeSolo:s,renderOption:o,renderOptionChip:i,noOptionsText:a,loading:r,filterOptions:d,inputValue:l,onInputChange:u,placeholder:m}){var Q;const j=Y(),{field:{value:g,onChange:h}}=qe({name:t,control:j.control}),y=g||{},R=c.useMemo(()=>y.values||[],[y.values]),b=y.operand||k.Equals,I=!y.operand||b===k.Contains||b===k.NotContains||s,z=I?void 0:i;return e.jsxs(Pn,{children:[!!((Q=y.values)!=null&&Q.length)&&e.jsx(bn,{variant:"standard",value:b,onChange:S=>h({...y,operand:S.target.value}),children:Object.values(k).filter(S=>S!==k.Empty&&S!==k.NotEmpty).map(S=>e.jsx(F,{value:S,children:{[k.Equals]:"Is",[k.NotEquals]:"Is not",[k.NotContains]:"Not contains"}[S]||ye(S)},S))}),e.jsx(Ge,{fullWidth:!0,options:n,freeSolo:I,autoSelect:I,multiple:!0,value:R,forcePopupIcon:n.length>0,onChange:(S,M,W)=>h(M.length?{operand:y.operand||W==="create-option"?k.Contains:k.Equals,values:M}:null),renderInput:S=>{var M;return e.jsx(P,{placeholder:m||`Add ${ye(t)}`,...S,InputProps:{...S.InputProps,disableUnderline:!((M=y.values)!=null&&M.length)},fullWidth:!0})},renderTags:(S,M)=>S.map((W,oe)=>e.jsx(yn,{size:"small",...M({index:oe}),label:(z==null?void 0:z(W??"",{inputValue:"",selected:!1}))||W},W)),noOptionsText:a,loading:r,renderOption:o,filterOptions:d,inputValue:l,onInputChange:u})]})}function Wa({field:t}){var i,a,r;const n=Y(),{field:s}=qe({name:t,control:n.control}),o=((i=s.value)==null?void 0:i.length)>0?s.value:[{}];return e.jsxs(x,{column:!0,gap:2,children:[(a=o==null?void 0:o.map)==null?void 0:a.call(o,(d,l)=>e.jsx(Ba,{tag:d,onChange:u=>{s.onChange(!u.key&&(o==null?void 0:o.length)===0?null:ni(o,u.key?{[l]:{$set:u}}:{$splice:[[l,1]]}))}},d.key)),((r=o==null?void 0:o[o.length-1])==null?void 0:r.key)&&e.jsx(x,{children:e.jsx(w,{size:"small",variant:"text",onClick:()=>s.onChange([...o,{}]),startIcon:e.jsx(si,{}),children:"Add Another Tag"})})]})}function qa(){var m,j;const n=Y().watch("resource_types"),s=zn(),[o,i,a]=De("",1e3),{data:r,loading:d}=B(O(`
      query RuleRemediationResource($phrase: String, $filters: SearchFilters) {
        search(phrase: $phrase, filters: $filters, skip: 0, limit: 100) {
          results {
            id
            display_name
          }
        }
      }
    `),{variables:{phrase:o,...(Number(n==null?void 0:n.length)>0||(s==null?void 0:s.length)>0)&&{filters:{resource_type:Number(n==null?void 0:n.length)>0?n:s}}}}),l=ti((m=r==null?void 0:r.search)==null?void 0:m.results,"id");return{noOptionsText:c.useMemo(()=>o!==a?"Loading...":a?"No results found":"Search by name, ID, tags or IP",[o,a]),options:c.useMemo(()=>{var g,h;return((h=(g=r==null?void 0:r.search)==null?void 0:g.results)==null?void 0:h.map(y=>y.id))||[]},[(j=r==null?void 0:r.search)==null?void 0:j.results]),renderOption:g=>e.jsx(Ie,{disableMenu:!0,id:g,showId:!0}),renderOptionChip:g=>e.jsx(Ie,{disableMenu:!0,id:g}),inputValue:a,onInputChange:c.useCallback((g,h)=>i(h||""),[i]),filterOptions:(g,{inputValue:h})=>g.filter(y=>{var R,b;return!h||((b=(R=l[y])==null?void 0:R.display_name)==null?void 0:b.toLowerCase().includes(h.toLowerCase()))}),loading:d}}function tt({field:t,options:n=Bn.options,renderOption:s,noOptionsText:o,loading:i,filterOptions:a,inputValue:r,onInputChange:d,placeholder:l,helperText:u}){const m=Y(),{field:{value:j,onChange:g}}=qe({name:t,control:m.control}),h=c.useMemo(()=>j||[],[j]);return e.jsx(Ge,{value:h,onChange:(y,R)=>g(R.length===0?[]:R),multiple:!0,renderInput:y=>e.jsx(P,{placeholder:l||`Add ${ye(t)}`,variant:"outlined",helperText:u,...y}),renderTags:(y,R)=>y.map((b,I)=>e.jsx(yn,{size:"small",...R({index:I}),label:(s==null?void 0:s(b,{inputValue:"",selected:!1}))||b},b)),noOptionsText:o,options:n??[],loading:i,renderOption:s,filterOptions:a,inputValue:r,onInputChange:d})}function Ga(){const[t,{loading:n}]=an({fetchAll:!0}),{ruleId:s}=he(),{data:o,loading:i}=B(O(`
      query RuleRemediationAccounts($ruleId: ID!) {
        rule_remediation_accounts(rule_id: $ruleId) 
      }
    `),{variables:{ruleId:s}});return{accounts:(t==null?void 0:t.filter(a=>a.type==="AWS"&&!!a.cloud_account_id))||[],renderOption:a=>e.jsx(fn,{id:a}),loading:i||n,ruleRemediationAccounts:new Set((o==null?void 0:o.rule_remediation_accounts)||[])}}function Ha(){return{options:Object.keys(Je),renderOption:t=>{var n;return((n=Je[t])==null?void 0:n.name)||t},filterOptions:(t,{inputValue:n})=>t.filter(s=>{var o;return!n||((o=Je[s])==null?void 0:o.name.toLowerCase().includes(n.toLowerCase()))})}}function Ua(){const t=zn();return{options:t!=null&&t.length?t:Object.keys(je).filter(n=>{var s,o,i;return!!((s=je[n])!=null&&s.display_name)&&!((o=je[n])!=null&&o.pseudo)&&((i=je[n])==null?void 0:i.cloud)==="aws"}),renderOption:n=>e.jsx(ei,{resource_type:n}),filterOptions:(n,{inputValue:s})=>n.filter(o=>{var i;return!s||((i=je[o])==null?void 0:i.display_name.toLowerCase().includes(s.toLowerCase()))})}}function Qa(){const t=Ht(),{control:n}=Y(),s=Zs({control:n,name:"accounts"}),{ruleRemediationAccounts:o,accounts:i,...a}=Ga(),r=c.useMemo(()=>i==null?void 0:i.map(m=>m.cloud_account_id||""),[i]),d=s==null?void 0:s.filter(m=>!o.has(m)),l=c.useMemo(()=>i.reduce((m,j)=>(m[(j==null?void 0:j.cloud_account_id)||""]=j,m),{}),[i]),u=c.useMemo(()=>{if(!(d!=null&&d.length))return;const m=d.map(j=>{var g;return(g=l[j])==null?void 0:g.display_name}).join(", ");return e.jsxs(x,{row:!0,center:!0,gap:1,children:[e.jsx(en,{style:{color:t.palette.warning.main,width:"16px",height:"16px"}}),e.jsxs(p,{color:"textSecondary",children:["Notice: the following cloud accounts are missing the remediation stack: ",m,"."]})]})},[l,d,t.palette.warning.main]);return e.jsxs(x,{column:!0,gap:2,children:[e.jsxs(x,{row:!0,sticky:!0,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle1",children:"Remediation Scope"}),e.jsx(p,{color:"textSecondary",children:"All violations matching this policy will be automatically remediated upon detecting a violating configuration space."})]}),e.jsx(x,{grow:!0}),e.jsxs(x,{row:!0,center:!0,gap:!0,children:[e.jsx(La,{}),e.jsx(za,{})]})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Cloud Accounts"}),e.jsx(p,{color:"textSecondary",children:"Only resources from the selected cloud accounts will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(tt,{field:"accounts",options:r,...a,helperText:u})})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Regions"}),e.jsx(p,{color:"textSecondary",children:"Only resources in the selected regions will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(tt,{field:"regions",...Ha()})})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Violated Resource Types"}),e.jsx(p,{color:"textSecondary",children:"Only resources of the selected types will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(tt,{field:"resource_types",...Ua()})})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Violated Resource IDs"}),e.jsx(p,{color:"textSecondary",children:"Only the selected resource IDs will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(we,{field:"resource_ids",...qa()})})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Violated Resource Tags"}),e.jsx(p,{color:"textSecondary",children:"Only resources matching the selected tag conditions will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(Wa,{field:"resource_tags"})})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Source User Agent"}),e.jsx(p,{color:"textSecondary",children:"Only resources where the triggering event preformed by the specified user agent will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(we,{field:"source_user_agent",placeholder:"Add Source User Agent",freeSolo:!0})})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Event Name"}),e.jsx(p,{color:"textSecondary",children:"Only resources where the triggering event matches the specified event name (API Call) will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(we,{field:"event_name",placeholder:"Add Event Name",freeSolo:!0})})]}),e.jsx(D,{}),e.jsxs(x,{row:!0,gap:2,children:[e.jsxs(x,{column:!0,grow:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle2",children:"Source User Identity"}),e.jsx(p,{color:"textSecondary",children:"Only resources where the triggering event preformed by the specified user identities will be remediated."})]}),e.jsx(x,{grow:2,children:e.jsx(we,{field:"source_user_identity",placeholder:"Add Source User Identity",freeSolo:!0})})]})]})}function Ya({ruleId:t}){return e.jsx(Na,{ruleId:t,children:e.jsxs(Ea,{children:[e.jsx(x,{paper:!0,pad:2,border:"bottom",children:e.jsxs(x,{row:!0,center:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle1",children:"Auto Rule Remediation"}),e.jsx(Ia,{})]})}),e.jsx(x,{grow:!0,scroll:!0,pad:2,children:e.jsxs(x,{column:!0,gap:4,children:[e.jsx(Qa,{}),e.jsx(D,{light:!0}),e.jsx($a,{}),e.jsx("div",{style:{height:"25vh"}})]})})]})})}function Ka({rule:t,toggleButton:n,...s}){const[o,i]=Xa(t),[a,r]=xe("t","violations"),d=_a(t),l=20,{totalCount:u}=ri({variables:{rule_id:(t==null?void 0:t.id)??""}}),{totalCount:m}=_n({filters:d,limit:l}),j=c.useMemo(()=>[{value:"conditions",Icon:xt,label:"Rule Conditions"},{value:"exclusions",Icon:tn,label:"Exclude Conditions"},{value:"violations",disabled:(t==null?void 0:t.state)!==Ee.Enabled,Icon:mt,label:`Violations ${u?`(${u})`:""}`},{value:"exclude",Icon:un,label:`Manually Excluded ${m?`(${m})`:""}`},...t.remediation_available||a==="remediation"?[{value:"remediation",Icon:li,label:"Rule Remediation Settings"}]:[]],[t==null?void 0:t.state,t.remediation_available,u,m,a]);return e.jsxs(v,{...s,children:[e.jsxs(tr,{children:[n,e.jsx(nr,{value:a,onChange:(g,h)=>r(h),children:j.map(({value:g,label:h,Icon:y},R)=>e.jsx(ce,{value:g,label:e.jsx(C,{icon:e.jsx(y,{fontSize:"small",color:"action"}),label:h,labelVariant:a===g?"subtitle1":void 0})},R))})]}),e.jsx(er,{children:{conditions:e.jsx(ki,{rule:t}),exclusions:e.jsx(ca,{rule:t}),violations:e.jsx(Ja,{rule:t,sortOptions:o,onSortChange:i}),exclude:e.jsx(Za,{rule:t,filters:d,limit:l}),remediation:e.jsx(Ya,{ruleId:(t==null?void 0:t.id)??""})}[a]||e.jsx(te.Fragment,{})})]})}function Za({rule:t,filters:n,limit:s}){const{data:o,error:i,loading:a,totalCount:r,loadMore:d}=_n({filters:n,limit:s});return i&&!o&&!a?e.jsx(fe,{children:e.jsx(St,{error:i})}):a?e.jsx(fe,{children:e.jsx(wt,{})}):o!=null&&o.length?e.jsx(Ii,{rule:t,filters:n,exclusions:o,count:r??0,limit:s,onScroll:d}):e.jsx(fe,{children:e.jsx(p,{color:"textSecondary",children:"No exclusions"})})}function Ja({rule:t,sortOptions:n,onSortChange:s}){const[o,i]=xe("f");return e.jsx(ga,{filtersValues:o,onFiltersChange:i,rule:t,sortOptions:n,onSortChange:s})}function Xa(t){const n=c.useMemo(()=>t.category==="Cost"?{sort_by:zt.PredictedMonthlyCost,sort_order:-1}:{sort_by:zt.FirstSeenTimestamp,sort_order:-1},[t.category]);return xe("s",n,{sort_order:Number})}const er=f.div.withConfig({displayName:"RuleOverview__Content",componentId:"sc-1nq5m1c-0"})(({theme:t})=>({flexGrow:1,overflow:"auto",display:"flex",flexDirection:"column"})),tr=f(ie).withConfig({displayName:"RuleOverview__Header",componentId:"sc-1nq5m1c-1"})(({theme:t})=>({alignItems:"center",padding:t.spacing(0,1)})),nr=f(Oe).withConfig({displayName:"RuleOverview__HeaderTabs",componentId:"sc-1nq5m1c-2"})({height:"100%"});function sr({rule:t,...n}){var m;const[s,o]=vt("rule-details",!0),i=dt(),[a,r]=c.useState(!!((m=i.state)!=null&&m.editMode)),d=kt(t),l=e.jsx(xn,{open:s,onClick:()=>o(!s),ClosedIcon:se}),u=c.useCallback(()=>{r(!1)},[]);return e.jsx(ci,{rule:t,children:e.jsxs(E,{grow:!0,...n,children:[e.jsx(Rt,{open:s,children:a?e.jsx(ia,{form:d,rule:t,onClose:u}):e.jsx(Zo,{rule:t,headerActions:e.jsxs(e.Fragment,{children:[e.jsx(w,{variant:"text",startIcon:e.jsx(ft,{fontSize:"small",color:"action"}),size:"small",onClick:()=>r(!a),children:"Edit"}),l]})})}),a&&(t==null?void 0:t.state)===Ee.Draft?e.jsx(ra,{form:d}):e.jsx(Ka,{rule:t,toggleButton:!s&&l})]})})}function ir(){const t=ut(),n=dt(),s=t.params.id,[o,{loading:i,error:a}]=di(s),r=Kt(),d=Zt(),l=c.useCallback(()=>{var m;const u={focusRuleId:s};(m=n.state)!=null&&m.prevLocation?d.replace({pathname:n.state.prevLocation.pathname,search:n.state.prevLocation.search,state:u}):r.replace({pathname:`${ui.path}`,state:u})},[d,s,r]);return e.jsxs(v,{grow:[0,1],style:{height:"100%"},children:[e.jsx(Ti,{Icon:Cn,title:e.jsxs(E,{gap:1,style:{alignItems:"center"},children:[e.jsx(p,{variant:"inherit",children:o==null?void 0:o.name}),o&&o.status!=="active"&&e.jsx(Dt,{rule:o})]}),onBackClick:l}),e.jsxs(or,{grow:[0,1],children:[e.jsx("div",{}),i?e.jsx(fe,{children:e.jsx(wt,{})}):a?e.jsx(St,{error:a}):e.jsx(sr,{rule:o})]})]})}const or=f(v).withConfig({displayName:"RulePage__Container",componentId:"sc-y1732u-0"})(({theme:t})=>({background:t.palette.background.paper}));function ar(){const{enabled:t,loading:n}=Ft(),{rules:s,loading:o,error:i,loadMore:a}=ur(),r=ze(),d=n||o;return e.jsx(x,{grow:!0,scroll:!0,onScrollEnd:a,error:i,children:e.jsxs(pr,{data:s,loading:d,stickyHeader:!0,onClick:l=>r({ruleId:l.id??"",tab:"remediation"}),children:[e.jsx(A,{grow:2,header:"Remediable Rule Name",render:l=>e.jsxs(x,{row:!0,gap:!0,style:{maxWidth:500},children:[e.jsx(pi,{severity:l.severity}),e.jsxs(x,{column:!0,grow:!0,children:[e.jsx(p,{noWrap:!0,children:l.name}),e.jsx(p,{color:"textSecondary",noWrap:!0,children:l.description})]})]})}),e.jsx(A,{header:"Rule Status",render:l=>e.jsx(Dt,{rule:l})}),e.jsx(A,{header:"Enable Auto-Remediation",render:l=>e.jsx(x,{row:!0,center:!0,gap:!0,children:e.jsx($t,{disabled:!t||!Tt(l.remediation_config),checked:!!l.remediation_enable,ruleId:l.id??"",mutationOptions:{update(u){u.writeQuery({query:Wn,data:{remediation_rules:s.map(m=>m.id===l.id?{...m,remediation_enable:!l.remediation_enable}:m)}})}}})})}),e.jsx(A,{header:"Auto-Remediation Policy",render:l=>e.jsx(lr,{config:l.remediation_config})}),e.jsx(A,{header:"Last Changed",render:l=>{var u,m;return e.jsx(rr,{userId:(u=l.remediation_config)==null?void 0:u.remediation_config_last_updated_user_id,lastUpdatedTime:(m=l.remediation_config)==null?void 0:m.remediation_config_last_updated_time})}})]})})}function rr({userId:t,lastUpdatedTime:n}){const s=Ct(n),{fullName:o}=gi(t,{});return e.jsx(x,{row:!0,center:!0,gap:!0,children:e.jsx(p,{color:"textSecondary",children:`${n?s:"--"} by ${t&&o||"--"}`})})}function lr({config:t}){return Tt(t)?e.jsxs(x,{row:!0,center:!0,gap:!0,children:[e.jsx(cr,{}),e.jsx(p,{color:"textSecondary",children:"Configured"})]}):e.jsx(_t,{title:"Auto Remediation Policy",content:e.jsx(p,{style:{maxWidth:250},children:"Auto-remediation policy has not been configured for this rule."}),children:e.jsxs(x,{row:!0,center:!0,gap:!0,children:[e.jsx(dr,{}),e.jsx(p,{color:"textSecondary",children:"Not Configured"})]})})}const cr=f(gn).withConfig({displayName:"AutoRemediationRulesTable__ConfiguredIcon",componentId:"sc-1836asu-0"})(({theme:t})=>({color:t.palette.common.green})),dr=f(ji).withConfig({displayName:"AutoRemediationRulesTable__NotConfiguredIcon",componentId:"sc-1836asu-1"})(({theme:t})=>({color:t.palette.common.red})),nt=50,Wn=O(`
  query RemediationRules {
    remediation_rules {
      id
      name
      description
      severity
      status
      remediation_enable
      remediation_config {
        ...AutoRemediationRuleConfigFields
        remediation_config_last_updated_time
        remediation_config_last_updated_user_id
      }
    }
  }
`);function ur(){var d;const[t]=xe("search",""),{data:n,loading:s,error:o}=B(Wn),i=c.useCallback(()=>{var l;return((l=n==null?void 0:n.remediation_rules)==null?void 0:l.filter(u=>{var m,j;return!t||((m=u.name)==null?void 0:m.toLowerCase().includes(t.toLowerCase()))||((j=u.description)==null?void 0:j.toLowerCase().includes(t.toLowerCase()))}))||[]},[n==null?void 0:n.remediation_rules,t]),[a,r]=c.useState((d=i())==null?void 0:d.slice(0,nt));return c.useEffect(()=>{var l;r((l=i())==null?void 0:l.slice(0,nt))},[i]),{rules:a,loading:s,error:o,loadMore:c.useCallback(()=>{var l,u;(a==null?void 0:a.length)<((l=i())==null?void 0:l.length)&&r((u=i())==null?void 0:u.slice(0,a.length+nt))},[i,a==null?void 0:a.length])}}const pr=f(mi).withConfig({displayName:"AutoRemediationRulesTable__StyledTable",componentId:"sc-1836asu-2"})(({theme:t})=>({padding:t.spacing(2),[hi]:{background:t.palette.background.paper,marginBottom:t.spacing(1)},[xi]:{borderRadius:0,background:t.palette.background.default}}));function mr(){return e.jsxs(x,{column:!0,fullHeight:!0,children:[e.jsx(x,{paper:!0,pad:3,border:"bottom",children:e.jsxs(x,{row:!0,center:!0,gap:!0,children:[e.jsx(p,{variant:"subtitle1",children:"Workspace Auto-Remediation"}),e.jsx(_t,{title:"Workspace Auto-remediation",content:e.jsx(p,{style:{maxWidth:250},children:"Automatically apply remediations to policy violations within this workspace."}),children:e.jsx(se,{fontSize:"small",color:"action"})}),e.jsx(gr,{}),e.jsx(x,{grow:!0}),e.jsx(xr,{})]})}),e.jsx(ar,{})]})}function xr(){const[t,n]=xe("search",""),[s,o,i]=De(t,500);return c.useEffect(()=>{t!==s&&n(s)},[s,t,n]),e.jsx(P,{variant:"outlined",size:"small",placeholder:"Search by rule name ",value:i,onChange:a=>o(a.target.value),style:{minWidth:300},InputProps:{startAdornment:e.jsxs(e.Fragment,{children:[e.jsx(mn,{fontSize:"small",color:"action"}),"Â Â "]})}})}function hr(t){return c.useMemo(()=>({title:t?"Disable Workspace Auto-Remediation":"Enable Workspace Auto-Remediation",text:t?"Are you sure you want to disable auto-remediation for the entire workspace?":"Are you sure you want to enable auto-remediation for the entire workspace?",confirmText:t?"Disable":"Enable"}),[t])}function gr(){const{workspaceId:t}=Qt(),{enabled:n,loading:s}=Ft(),[o,{loading:i}]=An(jr(),hr(n));return e.jsxs(x,{row:!0,center:!0,gap:!0,children:[e.jsx(Te,{disabled:s||i,checked:n,size:"small",onClick:()=>{o({variables:{workspace_id:t,enable:!n}})}}),!s&&e.jsx(p,{children:n?"Enabled":"Disabled"}),(s||i)&&e.jsx(me,{size:15})]})}function jr(){return Ce(O(`
    mutation AutoRemediationWorkspaceEditEnabled($workspace_id: ID!, $enable: Boolean!) {
      edit_active_auto_remediation(workspace_id: $workspace_id, active: $enable) 
    }`),{update(t){var n,s;t.writeQuery({query:rt,data:{workspace_auto_remediation_config:{__typename:"WorkspaceAutoRemediationConfig",active_auto_remediation:!((s=(n=t.readQuery({query:rt}))==null?void 0:n.workspace_auto_remediation_config)!=null&&s.active_auto_remediation)}}})}})}function fr(){const{results:t,loading:n,loadMore:s,error:o}=fi({query:Cr,getResults:i=>(i==null?void 0:i.remediation_executions)??[],getTotalCount:()=>null,limit:100});return e.jsx(x,{paper:!0,fullHeight:!0,onScrollEnd:s,error:o,scroll:!0,children:e.jsxs(yi,{data:t,loading:n,stickyHeader:!0,children:[e.jsx(A,{style:{minWidth:160},header:"Timestamp",render:i=>e.jsx(U,{children:e.jsx(bi,{noWrap:!0,value:i.start_time})})}),e.jsx(A,{grow:2,header:"Account / Region",render:i=>e.jsx(x,{column:!0,children:e.jsx(fn,{id:i.account_id,secondaryLabel:i.region})})}),e.jsx(A,{grow:2,style:{minWidth:200},header:"Remediated Resource",render:i=>e.jsx(Ie,{id:i.remediated_resource_id,resourceType:i.remediated_resource_type,showType:!0})}),e.jsx(A,{header:"Severity",render:i=>e.jsx(br,{ruleId:i.violated_rule_id})}),e.jsx(A,{grow:4,header:"Violated Rule",render:i=>e.jsx(_r,{ruleId:i.violated_rule_id})}),e.jsx(A,{grow:2,header:"Remediation Action",render:i=>i.runbook_name&&e.jsx(x,{round:!0,bg:!0,pad:!0,style:{maxWidth:"fit-content"},children:e.jsx(U,{children:e.jsx(ee,{color:"textSecondary",noWrap:!0,children:i.runbook_name})})})}),e.jsx(A,{grow:2,header:"Status",render:i=>e.jsxs(x,{row:!0,center:!0,gap:!0,children:[{Success:e.jsx(_i,{color:"success"}),Failed:e.jsx(bt,{color:"error"}),InProgress:e.jsx(ln,{color:"primary"})}[i.status??""]||e.jsx(e.Fragment,{}),e.jsx(U,{children:e.jsx(ee,{noWrap:!0,children:ye(i.status)})})]})}),e.jsx(A,{grow:2,header:"Trigerring Event",render:i=>i.event_name?e.jsx(U,{children:e.jsx(ee,{noWrap:!0,children:i.event_id?e.jsx(yr,{eventId:i.event_id,children:i.event_name}):i.event_name})}):e.jsx(ee,{color:"textSecondary",children:"--"})}),e.jsx(A,{grow:3,header:"External Remediation ID",render:i=>e.jsx(U,{children:e.jsx(ee,{noWrap:!0,children:e.jsx("a",{href:i.execution_url??"",target:"_blank",rel:"noreferrer",children:i.execution_id})})})})]})})}function yr({eventId:t,children:n}){return e.jsx("a",{href:os(`${vi.path}/${t}`),target:"_blank",rel:"noreferrer",children:n})}function br({ruleId:t}){var s,o,i;const{data:n}=qn(t);return!t||!((s=n==null?void 0:n.rule)!=null&&s.severity)?null:e.jsxs(x,{row:!0,center:!0,gap:!0,children:[e.jsx(Ci,{severity:(o=n==null?void 0:n.rule)==null?void 0:o.severity}),e.jsx(U,{children:e.jsx(ee,{noWrap:!0,children:Me((i=n==null?void 0:n.rule)==null?void 0:i.severity)})})]})}function _r({ruleId:t,...n}){var o;const{data:s}=qn(t);return e.jsx(U,{children:e.jsx(ee,{clamp:!0,...n,children:(o=s==null?void 0:s.rule)==null?void 0:o.name})})}function qn(t){return B(O(`
    query RemediationRule($ruleId: ID) {
      rule(id: $ruleId) {
        name
        severity
      }
    }
  `),{variables:{ruleId:t}})}const Cr=O(`
  query RemediationExecutions($skip: Int, $limit: Int) {
    remediation_executions(skip: $skip, limit: $limit) {
      _id
      execution_id
      execution_url
      start_time
      account_id
      region
      remediated_resource_id
      remediated_resource_type
      violated_rule_id
      status
      event_name
      event_id
      runbook_name
    }
  }
`);function vr(){return e.jsxs(Rr,{children:[e.jsx(Gt,{value:"/settings",label:"Remediation Settings",component:mr}),e.jsx(Gt,{value:"/log",label:"Remediation Log",component:fr})]})}function Rr({children:t}){const{url:n,path:s}=ut(),o=Jt(),i=Zt(),a=s.replace(it,""),r=te.Children.toArray(t)[0].props,d=o.replace(a,"")||r.value;return e.jsxs(x,{fullHeight:!0,column:!0,children:[e.jsx(x,{border:"bottom",paper:!0,children:e.jsx(Oe,{value:d,onChange:(l,u)=>i.push(n+u),children:t})}),e.jsx(x,{grow:!0,scroll:!0,children:e.jsxs(pt,{children:[te.Children.map(t,l=>{const{value:u,component:m}=l.props;return e.jsx(le,{path:`${s}${u}`,exact:!0,component:m})}),e.jsx(le,{path:s,exact:!0,component:r.component})]})})]})}function Gt({component:t,...n}){return e.jsx(ce,{...n})}const Gn=c.createContext({selectedRuleIds:new Set,setSelectedRuleIds:t=>{}});function wr(){const{path:t}=ut(),[n,s]=c.useState(new Set);return e.jsx(Gn.Provider,{value:{selectedRuleIds:n,setSelectedRuleIds:s},children:e.jsxs(pt,{children:[e.jsx(le,{path:`${t}/`,exact:!0,component:Qo}),e.jsx(le,{path:`${t}/:id`,component:ir})]})})}function zr(){const t=`/${Jt().split("/")[1]}`,n=Kt();return e.jsxs(x,{column:!0,fullHeight:!0,children:[e.jsxs(x,{header:!0,paper:!0,style:{padding:0},children:[e.jsxs(x,{row:!0,center:!0,gap:!0,pad:2,children:[e.jsx(Cn,{color:"action"}),e.jsx(p,{variant:"h5",children:"Rules"})]}),e.jsxs(Oe,{value:t,onChange:(s,o)=>n.push(o),children:[e.jsx(ce,{value:"/rules",label:"Rules"}),e.jsx(ce,{value:"/remediation",label:"Remediation Log & Settings"})]})]}),e.jsx(x,{grow:!0,scroll:!0,children:e.jsxs(pt,{children:[e.jsx(le,{path:`${it}/rules`,component:wr}),e.jsx(le,{path:`${it}/remediation`,component:vr})]})})]})}export{Gn as SelectedRulesContext,zr as default};
